!function(t){function g(t,e){return t+Math.floor(Math.random()*(e-t+1))}function o(t,e){var i=t[0].mul((1-e)*(1-e)),o=t[1].mul(2*e*(1-e)),e=t[2].mul(e*e);return i.add(o).add(e)}Point=function(t,e){this.x=t||0,this.y=e||0},Point.prototype={clone:function(){return new Point(this.x,this.y)},add:function(t){return p=this.clone(),p.x+=t.x,p.y+=t.y,p},sub:function(t){return p=this.clone(),p.x-=t.x,p.y-=t.y,p},div:function(t){return p=this.clone(),p.x/=t,p.y/=t,p},mul:function(t){return p=this.clone(),p.x*=t,p.y*=t,p}},Heart=function(){for(var t,e,i=[],o=10;o<30;o+=.2)e=o/Math.PI,t=16*Math.pow(Math.sin(e),3),e=13*Math.cos(e)-5*Math.cos(2*e)-2*Math.cos(3*e)-Math.cos(4*e),i.push(new Point(t,e));this.points=i,this.length=i.length},Heart.prototype={get:function(t,e){return this.points[t].mul(e||1)}},Seed=function(t,e,i,o){this.tree=t;i=i||1,o=o||"#FF0000";this.heart={point:e,scale:i,color:o,figure:new Heart},this.cirle={point:e,scale:i,color:o,radius:5}},Seed.prototype={draw:function(){this.drawHeart(),this.drawText()},addPosition:function(t,e){this.cirle.point=this.cirle.point.add(new Point(t,e))},canMove:function(){return this.cirle.point.y<this.tree.height+20},move:function(t,e){this.clear(),this.drawCirle(),this.addPosition(t,e)},canScale:function(){return.2<this.heart.scale},setHeartScale:function(t){this.heart.scale*=t},scale:function(t){this.clear(),this.drawCirle(),this.drawHeart(),this.setHeartScale(t)},drawHeart:function(){var t=this.tree.ctx,e=this.heart,i=e.point,o=e.color,n=e.scale;t.save(),t.fillStyle=o,t.translate(i.x,i.y),t.beginPath(),t.moveTo(0,0);for(var r=0;r<e.figure.length;r++){var h=e.figure.get(r,n);t.lineTo(h.x,-h.y)}t.closePath(),t.fill(),t.restore()},drawCirle:function(){var t=this.tree.ctx,e=this.cirle,i=e.point,o=e.color,n=e.scale,e=e.radius;t.save(),t.fillStyle=o,t.translate(i.x,i.y),t.scale(n,n),t.beginPath(),t.moveTo(0,0),t.arc(0,0,e,0,2*Math.PI),t.closePath(),t.fill(),t.restore()},drawText:function(){var t=this.tree.ctx,e=this.heart,i=e.point,o=e.color,e=e.scale;t.save(),t.strokeStyle=o,t.fillStyle=o,t.translate(i.x,i.y),t.scale(e,e),t.moveTo(0,0),t.lineTo(15,15),t.lineTo(60,15),t.stroke(),t.moveTo(0,0),t.scale(.75,.75),t.font="12px 微软雅黑,Verdana",t.fillText("Come on 怡妹",23,10),t.restore()},clear:function(){var t=this.tree.ctx,e=this.cirle,i=e.point,e=e.scale,e=h=26*e;t.clearRect(i.x-e,i.y-h,4*e,4*h)},hover:function(t,e){return 255==this.tree.ctx.getImageData(t,e,1,1).data[3]}},Footer=function(t,e,i,o){this.tree=t,this.point=new Point(t.seed.heart.point.x,t.height-i/2),this.width=e,this.height=i,this.speed=o||2,this.length=0},Footer.prototype={draw:function(){var t=this.tree.ctx,e=this.point,i=this.length/2;t.save(),t.strokeStyle="rgb(35, 31, 32)",t.lineWidth=this.height,t.lineCap="round",t.lineJoin="round",t.translate(e.x,e.y),t.beginPath(),t.moveTo(0,0),t.lineTo(i,0),t.lineTo(-i,0),t.stroke(),t.restore(),this.length<this.width&&(this.length+=this.speed)}},Tree=function(t,e,i,o){this.canvas=t,this.ctx=t.getContext("2d"),this.width=e,this.height=i,this.opt=o||{},this.record={},this.initSeed(),this.initFooter(),this.initBranch(),this.initBloom()},Tree.prototype={initSeed:function(){var t=this.opt.seed||{},e=t.x||this.width/2,i=t.y||this.height/2,e=new Point(e,i),i=t.color||"#FF0000",t=t.scale||1;this.seed=new Seed(this,e,t,i)},initFooter:function(){var t=this.opt.footer||{},e=t.width||this.width,i=t.height||5,t=t.speed||2;this.footer=new Footer(this,e,i,t)},initBranch:function(){var t=this.opt.branch||[];this.branchs=[],this.addBranchs(t)},initBloom:function(){for(var t=this.opt.bloom||{},e=[],i=t.num||500,o=t.width||this.width,n=t.height||this.height,r=this.seed.heart.figure,h=0;h<i;h++)e.push(this.createBloom(o,n,240,r));this.blooms=[],this.bloomsCache=e},toDataURL:function(t){return this.canvas.toDataURL(t)},draw:function(t){var e=this.ctx,i=this.record[t];i&&(t=i.point,i=i.image,e.save(),e.putImageData(i,t.x,t.y),e.restore())},addBranch:function(t){this.branchs.push(t)},addBranchs:function(t){for(var e,i,o,n,r,h,s=0;s<t.length;s++)h=t[s],e=new Point(h[0],h[1]),i=new Point(h[2],h[3]),o=new Point(h[4],h[5]),n=h[6],r=h[7],h=h[8],this.addBranch(new Branch(this,e,i,o,n,r,h))},removeBranch:function(t){for(var e=this.branchs,i=0;i<e.length;i++)e[i]===t&&e.splice(i,1)},canGrow:function(){return!!this.branchs.length},grow:function(){for(var t=this.branchs,e=0;e<t.length;e++){var i=t[e];i&&i.grow()}},addBloom:function(t){this.blooms.push(t)},removeBloom:function(t){for(var e=this.blooms,i=0;i<e.length;i++)e[i]===t&&e.splice(i,1)},createBloom:function(t,e,i,o,n,r,h,s,a,l){for(var c,u,p,d,f;;)if(c=g(20,t-20),u=g(20,e-20),((p=c-t/2)/(f=i)*(p/f)+(d=e-(e-40)/2-u)/f*(d/f)-1)*(p/f*(p/f)+d/f*(d/f)-1)*(p/f*(p/f)+d/f*(d/f)-1)-p/f*(p/f)*(d/f)*(d/f)*(d/f)<0)return new Bloom(this,new Point(c,u),o,n,r,h,s,a,l)},canFlower:function(){return!!this.blooms.length},flower:function(t){for(var e=this.bloomsCache.splice(0,t),i=0;i<e.length;i++)this.addBloom(e[i]);e=this.blooms;for(var o=0;o<e.length;o++)e[o].flower()},snapshot:function(t,e,i,o,n){var r=this.ctx.getImageData(e,i,o,n);this.record[t]={image:r,point:new Point(e,i),width:o,height:n}},setSpeed:function(t,e){this.record[t||"move"].speed=e},move:function(t,e,o){var n=this.ctx,r=this.record[t||"move"],h=r.point,s=r.image,a=r.speed||10,l=r.width,t=r.height;return i=h.x+a<e?h.x+a:e,j=h.y+a<o?h.y+a:o,n.save(),n.clearRect(h.x,h.y,l,t),n.putImageData(s,i,j),n.restore(),r.point=new Point(i,j),r.speed=.95*a,r.speed<2&&(r.speed=2),i<e||j<o},jump:function(){var t=this.blooms;if(t.length)for(var e=0;e<t.length;e++)t[e].jump();if(t.length&&t.length<3||!t.length)for(var i=this.opt.bloom||{},o=i.width||this.width,n=i.height||this.height,r=this.seed.heart.figure,e=0;e<g(1,2);e++)t.push(this.createBloom(o/2+o,n,240,r,null,1,null,1,new Point(g(-100,600),720),g(200,300)))}},Branch=function(t,e,i,o,n,r,h){this.tree=t,this.point1=e,this.point2=i,this.point3=o,this.radius=n,this.length=r||100,this.len=0,this.t=1/(this.length-1),this.branchs=h||[]},Branch.prototype={grow:function(){var t,e=this;e.len<=e.length?(t=o([e.point1,e.point2,e.point3],e.len*e.t),e.draw(t),e.len+=1,e.radius*=.97):(e.tree.removeBranch(e),e.tree.addBranchs(e.branchs))},draw:function(t){var e=this.tree.ctx;e.save(),e.beginPath(),e.fillStyle="rgb(35, 31, 32)",e.shadowColor="rgb(35, 31, 32)",e.shadowBlur=2,e.moveTo(t.x,t.y),e.arc(t.x,t.y,this.radius,0,2*Math.PI),e.closePath(),e.fill(),e.restore()}},Bloom=function(t,e,i,o,n,r,h,s,a){this.tree=t,this.point=e,this.color=o||"rgb(255,"+g(0,255)+","+g(0,255)+")",this.alpha=n||g(.3,1),this.angle=r||g(0,360),this.scale=h||.1,this.place=s,this.speed=a,this.figure=i},Bloom.prototype={setFigure:function(t){this.figure=t},flower:function(){var t=this;t.draw(),t.scale+=.1,1<t.scale&&t.tree.removeBloom(t)},draw:function(){var t=this,e=t.tree.ctx,i=t.figure;e.save(),e.fillStyle=t.color,e.globalAlpha=t.alpha,e.translate(t.point.x,t.point.y),e.scale(t.scale,t.scale),e.rotate(t.angle),e.beginPath(),e.moveTo(0,0);for(var o=0;o<i.length;o++){var n=i.get(o);e.lineTo(n.x,-n.y)}e.closePath(),e.fill(),e.restore()},jump:function(){var t=this,e=t.tree.height;t.point.x<-20||t.point.y>e+20?t.tree.removeBloom(t):(t.draw(),t.point=t.place.sub(t.point).div(t.speed).add(t.point),t.angle+=.05,--t.speed)}},t.random=g,t.bezier=o,t.Point=Point,t.Tree=Tree}(window);