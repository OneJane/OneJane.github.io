<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="frida沙箱自吐实现"><meta name="keywords" content="objection,frida,ssl,aosp"><meta name="author" content="J"><meta name="copyright" content="J"><title>frida沙箱自吐实现 | J</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?a345f534c85363668f09d4d5c6a9ee81";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-111479568-4","auto"),ga("send","pageview")</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer="defer"></script><script>var GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容:${query}"}},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},hexoVersion:"4.1.1"}</script><meta name="generator" content="Hexo 4.1.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#沙箱"><span class="toc-number">1.</span> <span class="toc-text">沙箱</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#基于hook的沙箱"><span class="toc-number">1.1.</span> <span class="toc-text">基于hook的沙箱</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#appmon"><span class="toc-number">1.1.1.</span> <span class="toc-text">appmon</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于源码的沙箱"><span class="toc-number">1.2.</span> <span class="toc-text">基于源码的沙箱</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#crypto-filter-aosp"><span class="toc-number">1.2.1.</span> <span class="toc-text">crypto_filter_aosp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AOSP网络库自吐"><span class="toc-number">2.</span> <span class="toc-text">AOSP网络库自吐</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#应用层抓包通杀脚本"><span class="toc-number">2.1.</span> <span class="toc-text">应用层抓包通杀脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SSL"><span class="toc-number">2.1.1.</span> <span class="toc-text">SSL</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#File"><span class="toc-number">3.</span> <span class="toc-text">File</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#通杀"><span class="toc-number">3.1.</span> <span class="toc-text">通杀</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#自制沙箱"><span class="toc-number">4.</span> <span class="toc-text">自制沙箱</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#甲方风控"><span class="toc-number">5.</span> <span class="toc-text">甲方风控</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#r0capture"><span class="toc-number">5.1.</span> <span class="toc-text">r0capture</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#框架层抓包"><span class="toc-number">6.</span> <span class="toc-text">框架层抓包</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HTTPS客户端证书多重证书绑定"><span class="toc-number">7.</span> <span class="toc-text">HTTPS客户端证书多重证书绑定</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#咪咕视频"><span class="toc-number">7.1.</span> <span class="toc-text">咪咕视频</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#北京银行"><span class="toc-number">7.2.</span> <span class="toc-text">北京银行</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="http://onejane.gitee.io/picture/avatar.jpg"></div><div class="author-info__name text-center">J</div><div class="author-info__description text-center">逆向,爬虫</div><div class="follow-button"><a href="https://github.com/OneJane/" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">55</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">55</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">7</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友情链接</div><a class="author-info-links__name text-center" href="https://blog.csdn.net/welggy" target="_blank" rel="noopener">OneJane</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image:url(http://onejane.gitee.io/picture/kali.jpg)"><div id="page-header"> <span class="pull-left"><a id="site-name" href="/">J</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i> <span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i> <span>搜索</span></a></span></div><div id="post-info"><div id="post-title">frida沙箱自吐实现</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-06</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/">安卓逆向</a><div class="post-meta-wordcount"><span>字数总计:</span> <span class="word-count">11.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 54 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="沙箱"><a href="#沙箱" class="headerlink" title="沙箱"></a>沙箱</h1><p>沙箱：对于系统来说，单个APP是没有隐私的，不管是脱壳、还是收发包，都是由系统的API来执行的。HOOK系统的API，就能得到很多APP的关键信息。</p><p>APP想要对抗沙箱：</p><ol><li>尽可能减少系统API的调用；</li><li>尽可能自己实现一定量的算法；</li><li>对自己实现的算法进行强混淆；</li><li>增加自身算法的复杂度吧：VMP</li></ol><p>各大安全公司、杀毒软件公司基本上都会有自己的沙箱，只要病毒/木马在自己的沙箱跑一遍，直接得到执行流、病毒相似性分析，如绑绑安全的<a href="https://www.bangcle.com/products/productindex?product_id=3" target="_blank" rel="noopener">安全密钥白盒</a>，对于APP也是一样的。</p><h2 id="基于hook的沙箱"><a href="#基于hook的沙箱" class="headerlink" title="基于hook的沙箱"></a>基于hook的沙箱</h2><p>Youpk Fart 都是沙箱,由于基于系统本身基本无法对抗。</p><h3 id="appmon"><a href="#appmon" class="headerlink" title="appmon"></a>appmon</h3><p><a href="https://github.com/dpnishant/appmon/wiki/4.a-Setup-Host" target="_blank" rel="noopener">appmon wiki</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;fs128arm64 </span><br><span class="line">vim &#x2F;etc&#x2F;proxychains4.conf </span><br><span class="line">socks5  192.168.0.107 1080   # 电脑主机 ssr选项设置-开启来自局域网的连接</span><br><span class="line">PYTHON_CONFIGURE_OPTS&#x3D;&quot;--disable-ipv6&quot; proxychains4 pyenv install 3.8.2</span><br><span class="line">PYTHON_CONFIGURE_OPTS&#x3D;&quot;--disable-ipv6&quot; proxychains4 pip install frida&#x3D;&#x3D;12.8.0</span><br><span class="line">PYTHON_CONFIGURE_OPTS&#x3D;&quot;--disable-ipv6&quot; proxychains4 pip install frida-tools&#x3D;&#x3D;5.3.0</span><br><span class="line">PYTHON_CONFIGURE_OPTS&#x3D;&quot;--disable-ipv6&quot; proxychains4 pip install objection&#x3D;&#x3D;1.8.4</span><br><span class="line">proxychains wget https:&#x2F;&#x2F;github.com&#x2F;dpnishant&#x2F;appmon&#x2F;archive&#x2F;refs&#x2F;heads&#x2F;master.zip</span><br><span class="line">7z x master.zip </span><br><span class="line">cd appmon-master </span><br><span class="line">pip install argparse flask termcolor dataset --upgrade --ignore-installed six</span><br><span class="line">python appmon.py -a &quot;com.xiaojianbang.app&quot; -p android -s scripts&#x2F;Android</span><br></pre></td></tr></table></figure><p>点击HookTestDemo.apk的算法加密按钮，触发生成./app_dumps/com.xiaojianbang.app.db</p><p>访问<a href="http://127.0.0.1:5000/" target="_blank" rel="noopener">http://127.0.0.1:5000/</a> 选择com.xiaojianbang.app</p><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/image-20210506003248713.png" alt="image-20210506003248713"></p><p>由于显示内容都是[Object Object],修改源码打印hook内容。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data.value &#x3D; byteArraytoHexString(digest);  删除</span><br><span class="line">var ByteString &#x3D; Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);  替换</span><br><span class="line">data.value &#x3D; ByteString.of(digest).hex()</span><br><span class="line"></span><br><span class="line">frida -UF -l Hash.js</span><br></pre></td></tr></table></figure><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/image-20210506003840372.png" alt="image-20210506003840372"></p><h2 id="基于源码的沙箱"><a href="#基于源码的沙箱" class="headerlink" title="基于源码的沙箱"></a>基于源码的沙箱</h2><p><a href="https://pan.baidu.com/s/1uPZbnKXa2_RJEUJRFxckLA" target="_blank" rel="noopener">aosp810r1</a> 解压<br><a href="https://dl.google.com/dl/android/aosp/google_devices-sailfish-opm1.171019.011-f3bafc8b.tgz" target="_blank" rel="noopener">驱动Vendor image</a> <a href="https://dl.google.com/dl/android/aosp/qcom-sailfish-opm1.171019.011-247af472.tgz" target="_blank" rel="noopener">驱动GPS, Audio, Camera, Gestures, Graphics, DRM, Video, Sensors</a> 解压驱动<br>解压到aosp810r1中后<code>./extrace-google_devices-sailfish.sh</code> 和<code>./extrace-qcom-sailfish.sh</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># apt update</span><br><span class="line"># git config --global user.email &quot;you@example.com&quot;</span><br><span class="line"># git config --global user.name &quot;Your Name&quot;</span><br><span class="line"># apt install bison tree</span><br><span class="line"># dpkg --add-architecture i386</span><br><span class="line"># apt update</span><br><span class="line"># apt install libc6:i386 libncurses5:i386 libstdc++6:i386</span><br><span class="line"># apt install libxml2-utils</span><br><span class="line"></span><br><span class="line">dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;swapfile bs&#x3D;1024 count&#x3D;10240000  使用dd创建swapfile作为swap分区空间</span><br><span class="line">mkswap swapfile  mkswap创建交换文件</span><br><span class="line"></span><br><span class="line">Kali下手动安装openjdk-8-jdk：</span><br><span class="line"># wget http:&#x2F;&#x2F;http.kali.org&#x2F;pool&#x2F;main&#x2F;o&#x2F;openjdk-8&#x2F;openjdk-8-jdk-headless_8u212-b01-1_amd64.deb</span><br><span class="line"># dpkg -i openjdk-8-jdk-headless_8u212-b01-1_amd64.deb</span><br><span class="line"># wget http:&#x2F;&#x2F;http.kali.org&#x2F;pool&#x2F;main&#x2F;o&#x2F;openjdk-8&#x2F;openjdk-8-jdk_8u212-b01-1_amd64.deb</span><br><span class="line"># dpkg -i openjdk-8-jdk_8u212-b01-1_amd64.deb</span><br><span class="line">安装完成后再用：</span><br><span class="line"># update-alternatives --config java</span><br><span class="line"># update-alternatives --config javac</span><br><span class="line">选择2来切换jdk的版本：见图</span><br><span class="line">最后用version选项来确认版本：</span><br><span class="line"># java -version</span><br><span class="line"># javac -version</span><br><span class="line">source build&#x2F;envsetup.sh</span><br><span class="line">lunch   选择24 aosp_sailfish-userdebug</span><br><span class="line">make   编译完成的系统镜像位于当前目录的out&#x2F;target&#x2F;product&#x2F;sailfish&#x2F;下包括各个img</span><br></pre></td></tr></table></figure><p><a href="https://dl.google.com/dl/android/aosp/sailfish-opm1.171019.011-factory-56d15350.zip" target="_blank" rel="noopener">官方镜像</a> 下载下来后解压将上面编译好的所有img替换到官方镜像解压后的image-sailfish-opm1.171019.011文件夹，并还原创建zip包</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb reboot bootloader</span><br><span class="line">.&#x2F;flash-all.sh</span><br></pre></td></tr></table></figure><p><a href="http://wuxiaolong.me/2018/08/15/AOSP3/" target="_blank" rel="noopener">Android Studio 导入 AOSP 源码</a> <code>development/tools/idegen/idegen.sh</code></p><p>会在根目录下生成<br>android.iml 和 android.ipr 这两个文件，这两个文件是 Android Studio 的工程配置文件，这时候其实已经可以直接导入 Android Studio，但会导入所有的源码模块，会很慢，可以进行过滤，除了 frameworks 模块和 packages 模块，其他都给过滤掉，不导入 Android Studio，打开 android.iml 文件，搜下<code>excludeFolder</code>，在后面加入如下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;art&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;bionic&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;bootable&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;build&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;cts&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;dalvik&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;developers&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;development&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;device&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;docs&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;external&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;hardware&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;kernel&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;libcore&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;libnativehelper&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;out&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;pdk&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;platform_testing&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;prebuilts&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;sdk&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;system&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;test&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;toolchain&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;tools&quot; &#x2F;&gt;</span><br><span class="line">&lt;excludeFolder url&#x3D;&quot;file:&#x2F;&#x2F;$MODULE_DIR$&#x2F;.repo&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure><p>发现 Android Studio 不停 scanning files to index，我的强迫症又犯了，解决：</p><ol><li>invalidate and restart 不起作用；</li><li>右击项目 –&gt; Open module setting –&gt; Modules –&gt; 找到 gen 文件夹 –&gt; 右键选择 Resources，终于告别烦人的 scanning files to index。</li></ol><p>修改MessageDigest.java</p><h3 id="crypto-filter-aosp"><a href="#crypto-filter-aosp" class="headerlink" title="crypto_filter_aosp"></a><a href="https://github.com/icew4y/crypto_filter_aosp" target="_blank" rel="noopener">crypto_filter_aosp</a></h3><p>基于android6.0.1 Nexus 6P <a href="https://pan.baidu.com/s/1Fe_m_OsWiVZJ03eWlR-0mg" target="_blank" rel="noopener">ROM</a>,<a href="https://dl.google.com/dl/android/aosp/angler-mmb29v-factory-17366b60.zip" target="_blank" rel="noopener">系统底包</a></p><p>先刷官方原版底包，老版本使用fastboot6.0放到kali的/root/Android/Sdk/plateform-tools,<code>flash-all.sh</code></p><ol><li>手机先刷入fastbboot flash recovery twrp</li><li>下载rom解压，adb push ROM/ /sdcard/TWRP/BACKUPS</li><li>进入twrp，从备份中恢复Restore,重启手机,然后修改权限 chmod 777 /data/local/tmp/monitor_package</li><li>安装你需要监控的apk(系统自动把最后一次安装的apk添加进去监控的列表 /data/local/tmp/monitor_package),只能同时监控一个<code>adb install HookTestDemo.apk</code></li><li>/data/data/package_name/下面生成APK调用的算法,只有三种(数据均为JSON编码,字段为BASE64编码)<code>/data/data/com.xiaojianbang.app</code></li></ol><p>参考crypto_filter_aosp文件夹源码添加到aosp810r1的源码中，将MyUtil.java,ContextHolder.java,AndroidBase64.java,Cipher.java放到<code>aosp810r1/libcore/ojluni/src/main/java/javax/crypto</code></p><p>将参考20200212/MessageDigest.java代码实现到aosp810r1的MessageDigest.java。同理，修改Mac.java</p><p>openjdk_java_files.mk添加新增的需要编译的类</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ojluni&#x2F;src&#x2F;main&#x2F;java&#x2F;javax&#x2F;crypto&#x2F;Mac.java \</span><br><span class="line">ojluni&#x2F;src&#x2F;main&#x2F;java&#x2F;javax&#x2F;crypto&#x2F;ContextHolder.java \</span><br><span class="line">ojluni&#x2F;src&#x2F;main&#x2F;java&#x2F;javax&#x2F;crypto&#x2F;MyUtil.java \</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source build&#x2F;envsetup.sh</span><br><span class="line">lunch aosp_sailfish-user</span><br><span class="line">make 如报错make update-api</span><br></pre></td></tr></table></figure><p>编译完成后将编译好的img压缩成image-sailfish-opm1.17019.011.zip放到官方系统底包，<code>./flash-all.bat</code>刷机</p><h1 id="AOSP网络库自吐"><a href="#AOSP网络库自吐" class="headerlink" title="AOSP网络库自吐"></a>AOSP网络库自吐</h1><p>适用于沙箱的原则：我们要可以在安卓源码中找到其实现、彻底的修改其实现。</p><p>App开发实力越强，App自己实现的内容越多，对系统的依赖程度越低，沙箱的作用就越小。→ 沙箱只能帮助定位到关键的点，如何把内容解开还是分析自己实现的部分。</p><p>为了能抓到包，无数安全研究人员使出浑身解数，我们可以按照OSI七层模型或TCP/IP四层模型。</p><blockquote><ol><li>我们在谈论MAC地址/ARP的时候，我们聊的就是链路层；</li><li>我们在谈论IP地址/路由器的时候，我们聊的就是网络层；</li><li>我们在谈论连接某个端口的时候，我们聊的就是传输层；</li><li>我们在谈论发送数据的内容的时候，我们聊的就是应用层；</li></ol></blockquote><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/722120_5XMU3SB58Y5QA2K.png" alt="img"></p><p><strong>应用层/Application：基于中间人的HTTP(S)抓包</strong></p><ul><li>该方法继承于网页端的抓包，只不过对抗性全面强化；在设计网站时无法控制客户端，但是App确是可以被厂商全面控制的；</li><li>在客户端校验服务器证书的情况下，需要将抓包软件（推荐Charles）的证书置于手机根证书目录下，推荐Magisk插件<a href="https://github.com/Magisk-Modules-Repo/movecert" target="_blank" rel="noopener">Move Certificates</a>；</li><li>在服务器验证客户端证书的情况下，还需要<a href="https://blog.csdn.net/qq_38316655/article/details/104176882" target="_blank" rel="noopener">在App中dump出证书导入到Charles</a>中，这就涉及到证书密码和证书的解密；</li><li>App使用特定API，绕过WIFI代理进行通信→ 使用VPN将所有流量导入到Charles → App还会<a href="https://mp.weixin.qq.com/s/UixExZkPWHJAT3jAD2sJJg" target="_blank" rel="noopener">检测VPN</a>，发现即断网 → 需要hook过VPN检测；</li></ul><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/722120_PD5F7MBRW2NRUHN.png" alt="img"></p><blockquote><p>哪些是可以改的：（沙箱在辅助中间人抓包的过程中发挥的作用）</p><ul><li>Charles证书内置到系统根目录中去，某文件→某目录下<br>（<code>aosp810r1/system/ca-certificates/files</code>）</li><li>App的客户端证书的文件和密码，并不是所有的客户端证书都是必须以文件的形式、打开密码的要求存储的。可以是明文硬编码在代码里。<br>(<a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/CustomTrust.java%EF%BC%8C" target="_blank" rel="noopener">https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/CustomTrust.java，</a>)</li><li>对抗部分：有没有使用No_ Proxy、VPN检测,<a href="https://mp.weixin.qq.com/s/UixExZkPWHJAT3jAD2sJJg" target="_blank" rel="noopener">某抢票app逆向续篇之干掉vpn抓包检测</a><br>(System.getProperty(“http.proxyHost”); System.getProperty(“http.proxyPort”); java.net.NetworkInterface.getName(),android.net.ConnectivityManager.getNetworkCapabilities())</li><li>SSL pinning：从文件打开、哈希的计算处打调用栈</li></ul></blockquote><ul><li>App使用SSL pinning，只信任自己的证书 → 从<a href="https://github.com/WooyunDota/DroidSSLUnpinning" target="_blank" rel="noopener">数十种框架</a>中找到<a href="https://square.github.io/okhttp/3.x/okhttp/okhttp3/CertificatePinner.html" target="_blank" rel="noopener">hook点</a>并绕过 → App进行了代码混淆 → 反混淆并hook绕过，而反混淆总是让人倒吸一口凉气。。。</li></ul><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/722120_P8ZADA2376ZUCPY.png" alt="img"></p><ul><li>由于厂商可以全面控制客户端，因此可以使用小众协议，比如WebSocket、<a href="https://bbs.pediy.com/thread-264034.htm" target="_blank" rel="noopener">Protobuf</a>，甚至自己写协议，比如腾讯的<a href="https://bbs.pediy.com/thread-250845.htm" target="_blank" rel="noopener">JceStruct</a>，此时除了自己分析协议字段别无他法</li></ul><p><strong>传输层/Transport：App使用纯Socket通信</strong></p><ul><li>比如<a href="https://www.52pojie.cn/forum.php?mod=viewthread&tid=1179834" target="_blank" rel="noopener">某应用</a>的数据采用点对点纯Socket的tcp通信，此时只有dump其通信流量，分析其raw data，结合源码分析字段构成；</li><li><a href="https://tech.meituan.com/2017/03/17/shark-sdk.html" target="_blank" rel="noopener">某厂商</a>开创性地提出了自建代理长连通道的网络加速方案，App中绝大部分的请求通过CIP通道中的TCP子通道与长连服务器通信，长连服务器将收到的请求代理转发到业务服务器，对于业务来讲大大提高了效率，但是对于逆向来说却加大了抓包的难度。</li></ul><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/722120_8W4G2KBZHWW82XA.png" alt="img"></p><ul><li>也幸亏其SDK中包含了降级方案，可以hook某些关键函数实现降级到HTTP，给了安全研究员一口饭吃。更有大厂已经在通讯标准演进的路线上大步快跑，在目前HTTP/2都没有普及的情况下，受益于相比于网页端而言、App客户端全面可控的优势，<a href="https://zhuanlan.zhihu.com/p/157369714" target="_blank" rel="noopener">提前迈入HTTP/3时代</a>，在性能优化的KPI上一骑绝尘而去，从内核、算法、传输层网络库和服务端全部自研。</li></ul><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/722120_8W4MCA8RE9WRJCF.png" alt="img"></p><p>面对连抓包工具都没有提供支持的kQUIC，逆向分析者只能说欲哭无泪。同样还是幸亏SDK中包含了<code>plan B</code>降级方案，可以通过hook来进行降级，安全研究员续命一秒钟。</p><p> <strong>网络层/Network：一般而言鲜有App可以更改设备的IP地址</strong></p><ul><li>科学上网软件、VPN可以改手机的路由表，因此可以用来抓包；</li><li>可以自建路由器进行抓包，对手机完全无侵入、无感知，彻底搞定抓不到包！</li></ul><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/722120_NZ72UJYECSHQPYP.png" alt="img"></p><ul><li>缺点是加密内容也无法还原，可以dump流量，却无法解密内容；在手机端连标准的SSL也解不开。也可以在手机上安装使用<code>Kali Nethunter</code>，在手机上直接跑<code>Wireshark</code>，接在4G流量卡上进行抓包，这种方式甚至可以抓到手机的流量卡的网卡包，应该是目前已知的唯一抓流量卡的方法。</li></ul><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/722120_ADH5T9NFZWVAE7P.png" alt="img"></p><h2 id="应用层抓包通杀脚本"><a href="#应用层抓包通杀脚本" class="headerlink" title="应用层抓包通杀脚本"></a>应用层抓包通杀脚本</h2><ol><li>App在开发过程中，以App自己的权限，可以用代码实现到的最底层为传输层，也就用Socket接口，进行纯二进制的收发包，此处包括Java层和Native层。</li><li>除了少数开发实力雄厚甚至过剩的大厂，掌握着纯二进制收发包的传输层创新、或者自定义协议的技术之外，占绝对数量绝大多数的App厂商采用的还是传统的HTTP/SSL方案。</li></ol><p>而且占绝对数量中绝大多数的App，其实现HTTP/SSL的方案也是非常的直白，那就是调用系统的API，或者调用更加易用的网络框架，比如访问网站的<a href="https://square.github.io/okhttp/" target="_blank" rel="noopener">Okhttp框架</a>，播放视频的<a href="https://github.com/google/ExoPlayer" target="_blank" rel="noopener">Exoplayer</a>，异步平滑图片滚动加载框架<a href="https://muyangmin.github.io/glide-docs-cn/" target="_blank" rel="noopener">Glide</a>，对于非网络库或协议等底层开发者来说，这些才应当是普罗大众安卓应用开发者的日常。</p><p>所以我们在对<code>Java</code>层<code>Socket</code>接口进行<code>trace</code>之后打调用栈，即可清晰地得出从肉眼可见的视频、到被封装成HTTP包、再到进入SSL进行加解密，再通过<code>Socket</code>与服务器进行通信的完整过程。</p><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/722120_EH72H72TGJW9XKK.png" alt="img"></p><p>只要开发者使用了应用层框架，即无法避免的使用了系统的Socket进行了收发，如果是<code>HTTP</code>则直接走了<code>Socket</code>，没有加解密、直接是明文，将内容dump下来即可；如果走了<code>HTTPS</code>，那么HTTP包还要“裹上”一层SSL，通过SSL的接口进行收发，<code>SSL</code>则将加密后和解密前的数据走<code>Socket</code>与服务器进行通信，明文数据只有<code>SSL</code>库自己知道。</p><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/722120_B7KXZQUSQ8WDMDH.png" alt="img"></p><p>因此想要得到SSL加密前和解密后的HTTP数据的话，就要对SSL库有深入的研究，而像这种大型的、历史悠久的基础库，研究它的人是非常多的；比如谷歌就有研究员对<code>OpenSSL</code>的收发包接口进行了深入的研究，并对其收发包等接口使用frida进行hook，提取明文HTTP数据，最终的成品为<a href="https://github.com/google/ssl_logger" target="_blank" rel="noopener">ssl_logger项目</a>；因为这种库一般作为互联网世界架构的基础设施，所以其应用非常广泛，这也是为何当其暴漏出<a href="https://heartbleed.com/" target="_blank" rel="noopener">“心脏滴血”</a>漏洞时，几乎影响到所有互联网设备的原因，不管是<code>Linux</code>、<code>Macos/iOS</code>、还是安卓，使用的都是<code>OpenSSL</code>，刚刚我们<code>trace</code>到的<a href="http://androidxref.com/8.1.0_r33/xref/external/conscrypt/common/src/main/java/org/conscrypt/ConscryptFileDescriptorSocket.java#541" target="_blank" rel="noopener"><code>SSLInputStream.read</code></a>函数，充其量只是<code>OpenSSL</code>库在<code>Java</code>层的一个包装器罢了。</p><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/722120_THBAKWN7W3AWUNG.png" alt="img"></p><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/722120_R57W9AH8CQXWSJW.png" alt="img"></p><p>而又有来自阿里的巨佬，在使用的过程中，进一步优化了该项目的JS脚本，修复了在新版frida上的语法错误，并在原项目只支持<code>Linux</code>和<code>macOS</code>的基础上，增加了对<code>iOS</code>和<code>Android</code>的支持，最终的成品就是<a href="https://github.com/BigFaceCat2017/frida_ssl_logger" target="_blank" rel="noopener">frida_ssl_logger项目</a>。</p><p> 该项目的完成度已经非常高，其核心原理就是对<code>SSL_read</code>和<code>SSL_write</code>进行<code>hook</code>，得到其收发包的明文数据。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Process.platform &#x3D;&#x3D; &quot;darwin&quot; ? &quot;*libboringssl*&quot; : &quot;*libssl*&quot;, [&quot;SSL_read&quot;, &quot;SSL_write&quot;, &quot;SSL_get_fd&quot;, &quot;SSL_get_session&quot;, &quot;SSL_SESSION_get_id&quot;]], &#x2F;&#x2F; for ios and Android</span><br><span class="line">[Process.platform &#x3D;&#x3D; &quot;darwin&quot; ? &quot;*libsystem*&quot; : &quot;*libc*&quot;, [&quot;getpeername&quot;, &quot;getsockname&quot;, &quot;ntohs&quot;, &quot;ntohl&quot;]]</span><br></pre></td></tr></table></figure><p>并将明文数据使用<code>RPC</code>传输到电脑上，使用<code>hexdump</code>在<code>python</code>的控制台进行输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if verbose:</span><br><span class="line">    src_addr &#x3D; socket.inet_ntop(socket.AF_INET,</span><br><span class="line">                                struct.pack(&quot;&gt;I&quot;, p[&quot;src_addr&quot;]))</span><br><span class="line">    dst_addr &#x3D; socket.inet_ntop(socket.AF_INET,</span><br><span class="line">                                struct.pack(&quot;&gt;I&quot;, p[&quot;dst_addr&quot;]))</span><br><span class="line">    print(&quot;SSL Session: &quot; + p[&quot;ssl_session_id&quot;])</span><br><span class="line">    print(&quot;[%s] %s:%d --&gt; %s:%d&quot; % (</span><br><span class="line">        p[&quot;function&quot;],</span><br><span class="line">        src_addr,</span><br><span class="line">        p[&quot;src_port&quot;],</span><br><span class="line">        dst_addr,</span><br><span class="line">        p[&quot;dst_port&quot;]))</span><br><span class="line">    hexdump.hexdump(data)</span><br></pre></td></tr></table></figure><p>或者保存至<code>pcap</code>文件，以供后续进一步分析。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">def log_pcap(pcap_file, ssl_session_id, function, src_addr, src_port,</span><br><span class="line">                dst_addr, dst_port, data):</span><br><span class="line">    &quot;&quot;&quot;Writes the captured data to a pcap file.</span><br><span class="line">    Args:</span><br><span class="line">        pcap_file: The opened pcap file.</span><br><span class="line">        ssl_session_id: The SSL session ID for the communication.</span><br><span class="line">        function: The function that was intercepted (&quot;SSL_read&quot; or &quot;SSL_write&quot;).</span><br><span class="line">        src_addr: The source address of the logged packet.</span><br><span class="line">        src_port: The source port of the logged packet.</span><br><span class="line">        dst_addr: The destination address of the logged packet.</span><br><span class="line">        dst_port: The destination port of the logged packet.</span><br><span class="line">        data: The decrypted packet data.</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    t &#x3D; time.time()</span><br><span class="line"> </span><br><span class="line">    if ssl_session_id not in ssl_sessions:</span><br><span class="line">        ssl_sessions[ssl_session_id] &#x3D; (random.randint(0, 0xFFFFFFFF),</span><br><span class="line">                                        random.randint(0, 0xFFFFFFFF))</span><br><span class="line">    client_sent, server_sent &#x3D; ssl_sessions[ssl_session_id]</span><br><span class="line"> </span><br><span class="line">    if function &#x3D;&#x3D; &quot;SSL_read&quot;:</span><br><span class="line">        seq, ack &#x3D; (server_sent, client_sent)</span><br><span class="line">    else:</span><br><span class="line">        seq, ack &#x3D; (client_sent, server_sent)</span><br><span class="line"> </span><br><span class="line">    for writes in (</span><br><span class="line">            # PCAP record (packet) header</span><br><span class="line">            (&quot;&#x3D;I&quot;, int(t)),  # Timestamp seconds</span><br><span class="line">            (&quot;&#x3D;I&quot;, int((t * 1000000) % 1000000)),  # Timestamp microseconds</span><br><span class="line">            (&quot;&#x3D;I&quot;, 40 + len(data)),  # Number of octets saved</span><br><span class="line">            (&quot;&#x3D;i&quot;, 40 + len(data)),  # Actual length of packet</span><br><span class="line">            # IPv4 header</span><br><span class="line">            (&quot;&gt;B&quot;, 0x45),  # Version and Header Length</span><br><span class="line">            (&quot;&gt;B&quot;, 0),  # Type of Service</span><br><span class="line">            (&quot;&gt;H&quot;, 40 + len(data)),  # Total Length</span><br><span class="line">            (&quot;&gt;H&quot;, 0),  # Identification</span><br><span class="line">            (&quot;&gt;H&quot;, 0x4000),  # Flags and Fragment Offset</span><br><span class="line">            (&quot;&gt;B&quot;, 0xFF),  # Time to Live</span><br><span class="line">            (&quot;&gt;B&quot;, 6),  # Protocol</span><br><span class="line">            (&quot;&gt;H&quot;, 0),  # Header Checksum</span><br><span class="line">            (&quot;&gt;I&quot;, src_addr),  # Source Address</span><br><span class="line">            (&quot;&gt;I&quot;, dst_addr),  # Destination Address</span><br><span class="line">            # TCP header</span><br><span class="line">            (&quot;&gt;H&quot;, src_port),  # Source Port</span><br><span class="line">            (&quot;&gt;H&quot;, dst_port),  # Destination Port</span><br><span class="line">            (&quot;&gt;I&quot;, seq),  # Sequence Number</span><br><span class="line">            (&quot;&gt;I&quot;, ack),  # Acknowledgment Number</span><br><span class="line">            (&quot;&gt;H&quot;, 0x5018),  # Header Length and Flags</span><br><span class="line">            (&quot;&gt;H&quot;, 0xFFFF),  # Window Size</span><br><span class="line">            (&quot;&gt;H&quot;, 0),  # Checksum</span><br><span class="line">            (&quot;&gt;H&quot;, 0)):  # Urgent Pointer</span><br><span class="line">        pcap_file.write(struct.pack(writes[0], writes[1]))</span><br><span class="line">    pcap_file.write(data)</span><br><span class="line"> </span><br><span class="line">    if function &#x3D;&#x3D; &quot;SSL_read&quot;:</span><br><span class="line">        server_sent +&#x3D; len(data)</span><br><span class="line">    else:</span><br><span class="line">        client_sent +&#x3D; len(data)</span><br><span class="line">    ssl_sessions[ssl_session_id] &#x3D; (client_sent, server_sent)</span><br></pre></td></tr></table></figure><p>由于完成度已经相当高了，在构建安卓应用层抓包通杀脚本时，应当尽可能复用其已经实现好的“基础设施”，只要为其再补上明文数据即可，而这明文数据从哪里来？根据多轮<code>trace</code>可以得知，明文数据的收发包接口，正是由<code>java.net.SocketOutputStream.socketWrite0</code>和<code>java.net.SocketInputStream.socketRead0</code>这两个<code>API</code>负责的，当然其实二者还有很多上层调用的接口，在选择分析的接口时，应尽量选择离<code>native</code>层更近的、并且在更多安卓版本上适用的，比如这两个API在安卓7、8、9、10上是通用和不变的，以降低工作量。</p><p> 最后的任务就是与<code>SSL_read</code>和<code>SSL_write</code>一样，根据收发的函数、找到收发的IP地址和端口，而正好两个API均有<code>socket</code>的实例域，提供了收发包的IP地址和端口信息。</p><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/722120_STFX4X9F2XQHM4F.png" alt="img"></p><p>最终就是取出这些信息，构造与<code>SSL</code>一样发给电脑即可，需要注意的是<code>Java</code>的<code>[B</code>需要手动转化成<code>JavaScript</code>的<code>ByteArray</code>还是略微复杂的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">if (Java.available) &#123;</span><br><span class="line">  Java.perform(function () &#123;</span><br><span class="line">    Java.use(&quot;java.net.SocketOutputStream&quot;).socketWrite0.overload(&#39;java.io.FileDescriptor&#39;, &#39;[B&#39;, &#39;int&#39;, &#39;int&#39;).implementation &#x3D; function (fd, bytearry, offset, byteCount) &#123;</span><br><span class="line">      var result &#x3D; this.socketWrite0(fd, bytearry, offset, byteCount);</span><br><span class="line">      var message &#x3D; &#123;&#125;;</span><br><span class="line">      message[&quot;function&quot;] &#x3D; &quot;HTTP_send&quot;;</span><br><span class="line">      message[&quot;ssl_session_id&quot;] &#x3D; &quot;&quot;;</span><br><span class="line">      message[&quot;src_addr&quot;] &#x3D; ntohl(ipToNumber((this.socket.value.getLocalAddress().toString().split(&quot;:&quot;)[0]).split(&quot;&#x2F;&quot;).pop()));</span><br><span class="line">      message[&quot;src_port&quot;] &#x3D; parseInt(this.socket.value.getLocalPort().toString());</span><br><span class="line">      message[&quot;dst_addr&quot;] &#x3D; ntohl(ipToNumber((this.socket.value.getRemoteSocketAddress().toString().split(&quot;:&quot;)[0]).split(&quot;&#x2F;&quot;).pop()));</span><br><span class="line">      message[&quot;dst_port&quot;] &#x3D; parseInt(this.socket.value.getRemoteSocketAddress().toString().split(&quot;:&quot;).pop());</span><br><span class="line">      var ptr &#x3D; Memory.alloc(byteCount);</span><br><span class="line">      for (var i &#x3D; 0; i &lt; byteCount; ++i)</span><br><span class="line">        Memory.writeS8(ptr.add(i), bytearry[offset + i]);</span><br><span class="line">      send(message, Memory.readByteArray(ptr, byteCount))</span><br><span class="line">      return result;</span><br><span class="line">    &#125;</span><br><span class="line">    Java.use(&quot;java.net.SocketInputStream&quot;).socketRead0.overload(&#39;java.io.FileDescriptor&#39;, &#39;[B&#39;, &#39;int&#39;, &#39;int&#39;, &#39;int&#39;).implementation &#x3D; function (fd, bytearry, offset, byteCount, timeout) &#123;</span><br><span class="line">      var result &#x3D; this.socketRead0(fd, bytearry, offset, byteCount, timeout);</span><br><span class="line">      var message &#x3D; &#123;&#125;;</span><br><span class="line">      message[&quot;function&quot;] &#x3D; &quot;HTTP_recv&quot;;</span><br><span class="line">      message[&quot;ssl_session_id&quot;] &#x3D; &quot;&quot;;</span><br><span class="line">      message[&quot;src_addr&quot;] &#x3D; ntohl(ipToNumber((this.socket.value.getRemoteSocketAddress().toString().split(&quot;:&quot;)[0]).split(&quot;&#x2F;&quot;).pop()));</span><br><span class="line">      message[&quot;src_port&quot;] &#x3D; parseInt(this.socket.value.getRemoteSocketAddress().toString().split(&quot;:&quot;).pop());</span><br><span class="line">      message[&quot;dst_addr&quot;] &#x3D; ntohl(ipToNumber((this.socket.value.getLocalAddress().toString().split(&quot;:&quot;)[0]).split(&quot;&#x2F;&quot;).pop()));</span><br><span class="line">      message[&quot;dst_port&quot;] &#x3D; parseInt(this.socket.value.getLocalPort());</span><br><span class="line">      if (result &gt; 0) &#123;</span><br><span class="line">        var ptr &#x3D; Memory.alloc(result);</span><br><span class="line">        for (var i &#x3D; 0; i &lt; result; ++i)</span><br><span class="line">          Memory.writeS8(ptr.add(i), bytearry[offset + i]);</span><br><span class="line">        send(message, Memory.readByteArray(ptr, result))</span><br><span class="line">      &#125;</span><br><span class="line">      return result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>One more thing，虽然直接调用native层Socket的应用框架几乎没有；但是Javs层的Socket API是可以进一步下沉到C层的Socket，以支援so文件的socket抓包。以<code>java.net.SocketOutputStream.socketWrite0</code>举例，其native层的实现为<code>JNIEXPORT void JNICALL 55SocketOutputStream_socketWrite0(JNIEnv *env, jobject this,jobject fdObj,jbyteArray data,jint off, jint len)</code>（<a href="http://androidxref.com/8.1.0_r33/xref/libcore/ojluni/src/main/native/SocketOutputStream.c#54" target="_blank" rel="noopener">地址</a>），其核心为一句话<code>int n = NET_Send(fd, bufP + loff, llen, 0);</code>，进一步追踪<code>NET_Send</code>可以在<code>linux_close.cpp</code>文件中找到其实现(<a href="http://androidxref.com/8.1.0_r33/xref/libcore/ojluni/src/main/native/linux_close.cpp#126" target="_blank" rel="noopener">地址</a>)，本质上也是<code>libc</code>的<code>send、sendto、recv、recvfrom</code>这些，因此可以直接hook这些接口，捕获该进程的所有通信流量。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">int NET_Read(int s, void* buf, size_t len) &#123;</span><br><span class="line">    BLOCKING_IO_RETURN_INT( s, recv(s, buf, len, 0) );</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">int NET_ReadV(int s, const struct iovec * vector, int count) &#123;</span><br><span class="line">    BLOCKING_IO_RETURN_INT( s, readv(s, vector, count) );</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">int NET_RecvFrom(int s, void *buf, int len, unsigned int flags,</span><br><span class="line">       struct sockaddr *from, int *fromlen) &#123;</span><br><span class="line">    socklen_t socklen &#x3D; *fromlen;</span><br><span class="line">    BLOCKING_IO_RETURN_INT( s, recvfrom(s, buf, len, flags, from, &amp;socklen) );</span><br><span class="line">    *fromlen &#x3D; socklen;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">int NET_Send(int s, void *msg, int len, unsigned int flags) &#123;</span><br><span class="line">    BLOCKING_IO_RETURN_INT( s, send(s, msg, len, flags) );</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">int NET_WriteV(int s, const struct iovec * vector, int count) &#123;</span><br><span class="line">    BLOCKING_IO_RETURN_INT( s, writev(s, vector, count) );</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">int NET_SendTo(int s, const void *msg, int len,  unsigned  int</span><br><span class="line">       flags, const struct sockaddr *to, int tolen) &#123;</span><br><span class="line">    BLOCKING_IO_RETURN_INT( s, sendto(s, msg, len, flags, to, tolen) );</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">int NET_Accept(int s, struct sockaddr *addr, int *addrlen) &#123;</span><br><span class="line">    socklen_t socklen &#x3D; *addrlen;</span><br><span class="line">    BLOCKING_IO_RETURN_INT( s, accept(s, addr, &amp;socklen) );</span><br><span class="line">    *addrlen &#x3D; socklen;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">int NET_Connect(int s, struct sockaddr *addr, int addrlen) &#123;</span><br><span class="line">    BLOCKING_IO_RETURN_INT( s, connect(s, addr, addrlen) );</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">#ifndef USE_SELECT</span><br><span class="line">int NET_Poll(struct pollfd *ufds, unsigned int nfds, int timeout) &#123;</span><br><span class="line">    BLOCKING_IO_RETURN_INT( ufds[0].fd, poll(ufds, nfds, timeout) );</span><br><span class="line">&#125;</span><br><span class="line">#else</span><br><span class="line">int NET_Select(int s, fd_set *readfds, fd_set *writefds,</span><br><span class="line">               fd_set *exceptfds, struct timeval *timeout) &#123;</span><br><span class="line">    BLOCKING_IO_RETURN_INT( s-1,</span><br><span class="line">                            select(s, readfds, writefds, exceptfds, timeout) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只是如果hook native层的这些接口的话，会混进openssl/boringssl的经过加密的流量，届时会比较难以区分，所以其实duck不必下降到native层，Java层的通信足以覆盖99%以上的场景（这个百分比是我估计的）。</p><p>最终也就是现在的效果：r0capture：安卓应用层抓包通杀脚本，<a href="https://github.com/r0ysue/r0capture" target="_blank" rel="noopener">地址：https://github.com/r0ysue/r0capture</a></p><ul><li>仅限安卓平台，测试安卓7、8、9、10 可用 ；</li><li>无视所有证书校验或绑定，不用考虑任何证书的事情；</li><li>通杀TCP/IP四层模型中的应用层中的全部协议；</li><li>通杀协议包括：Http,WebSocket,Ftp,Xmpp,Imap,Smtp,Protobuf等等、以及它们的SSL版本；</li><li>通杀所有应用层框架，包括HttpUrlConnection、Okhttp1/3/4、Retrofit/Volley等等；</li></ul><p>用法</p><ul><li>Spawn 模式：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python3 r0capture.py -U -f com.qiyi.video</span><br></pre></td></tr></table></figure><ul><li>Attach 模式，抓包内容保存成pcap文件供后续分析：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python3 r0capture.py -U com.qiyi.video -p iqiyi.pcap</span><br></pre></td></tr></table></figure><p>建议使用Attach模式，从感兴趣的地方开始抓包，并且保存成pcap文件，供后续使用Wireshark进行分析。</p><blockquote><p>PS：用来抓注册包，效果尤佳。</p></blockquote><p> <img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/722120_AJ9VJPVCAF5K8AP.png" alt="img"></p><p>To-do：</p><ol><li>此处还是有部分开发实力过强的大厂或框架，采用的是自身的SSL框架，比如<a href="https://mabin004.github.io/2020/07/24/%E8%87%AA%E5%8A%A8%E5%AE%9A%E4%BD%8Dwebview%E4%B8%AD%E7%9A%84SLL-read%E5%92%8CSSL-write/" target="_blank" rel="noopener">WebView、小程序</a>或<a href="https://bbs.pediy.com/thread-261941.htm" target="_blank" rel="noopener">Flutter</a>，这部分目前暂未支持。当然这部分App也是少数。</li><li>暂不支持HTTP/2、或HTTP/3，该部分API在安卓系统上暂未普及或布署，为App自带，无法进行通用hook。</li><li>各种模拟器架构、实现、环境较为复杂，建议珍爱生命、使用真机。</li><li>暂未添加多进程支持，比如:service或:push等子进程，可以使用Frida的Child-gating来支持一下。</li><li>支持多进程之后要考虑<code>pcap</code>文件的写入锁问题，可以用<code>frida-tool</code>的<a href="https://github.com/frida/frida-tools/blob/75c2af408fa2b8450b87565268b2671630451f45/frida_tools/application.py#L581" target="_blank" rel="noopener"><code>Reactor</code>线程锁</a>来支持一下。</li></ol><blockquote><p>TCP/IP中可以实现的部分：</p><ul><li><p>网络层：可以拿到所有的收发包。效果同Wireshark。如果是明文，其实效果跟传输层是一样的。非明文、跟传输层也是一样的。</p></li><li><p>传输层：可以拿到所有（应用层）的收发包，明文→明文；<code>java.net.SocketInputStream.socketRead0</code>、<code>java.net.SocketOutputStream.socketWrite0</code>都是native函数，意味着</p></li><li><p>应用层非明文→非明文：<code>SSLInputStream.read</code></p></li><li><p>应用层2：<a href="https://github.com/dpnishant/appmon/blob/45db2110e16180e3313f2fd2791b81d660c6e1d9/scripts/Android/Network/HTTP.js#L27" target="_blank" rel="noopener">com.android.okhttp.internal.http.HttpURLConnectionImpl</a></p></li></ul></blockquote><h3 id="SSL"><a href="#SSL" class="headerlink" title="SSL"></a>SSL</h3><p>安装HttpSocket</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">objection -g com.onejane.httpsocket explore</span><br><span class="line">android hooking search ssl  将所有打印出的类放到sslandroid8.txt中，前面批量加上android hooking watch class </span><br><span class="line">objection -g com.onejane.httpsocket explore -c sslandroid8.txt  批量hook，报错ClassLoader就删除包括ClassLoader类</span><br></pre></td></tr></table></figure><blockquote><p>android hooking watch class com.android.org.conscrypt.OpenSSLBIOInputStream<br>android hooking watch class com.android.org.conscrypt.OpenSSLCipher<br>android hooking watch class com.android.org.conscrypt.OpenSSLCipher$EVP_CIPHER<br>android hooking watch class com.android.org.conscrypt.OpenSSLCipher​$EVP_CIPHER​$AES<br>android hooking watch class com.android.org.conscrypt.OpenSSLCipher​$EVP_CIPHER​$AES​$CBC<br>android hooking watch class com.android.org.conscrypt.OpenSSLCipher$EVP_CIPHER$AES$CBC$PKCS5Padding<br>android hooking watch class com.android.org.conscrypt.OpenSSLCipher$EVP_CIPHER$AES_BASE<br>android hooking watch class com.android.org.conscrypt.OpenSSLContextImpl</p><p>…</p></blockquote><p>在安卓8上结果</p><blockquote><p>(agent) [lrxbzy1b2ea] Called javax.net.ssl.HttpsURLConnection.getDefaultHostnameVerifier()<br>(agent) [lrxbzy1b2ea] Called javax.net.ssl.HttpsURLConnection.getDefaultSSLSocketFactory()<br>(agent) [lrxbzy1b2ea] Called javax.net.ssl.HttpsURLConnection.getDefaultSSLSocketFactory()<br>(agent) [nrgnn66lv3e] Called com.android.org.conscrypt.OpenSSLSocketImpl.isClosed()<br>(agent) [nrgnn66lv3e] Called com.android.org.conscrypt.OpenSSLSocketImpl.isInputShutdown()<br>(agent) [nrgnn66lv3e] Called com.android.org.conscrypt.OpenSSLSocketImpl.isOutputShutdown()<br>(agent) [42lol483nwl] Called com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLOutputStream.write([B, int, int)<br>(agent) [nrgnn66lv3e] Called com.android.org.conscrypt.OpenSSLSocketImpl.isClosed()<br>(agent) [43hq04cbdn1] Called com.android.org.conscrypt.SslWrapper.write(java.io.FileDescriptor, [B, int, int, int)<br>(agent) [yz4ikx9fcpb] Called com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLInputStream.read([B, int, int)<br>(agent) [nrgnn66lv3e] Called com.android.org.conscrypt.OpenSSLSocketImpl.isClosed()<br>(agent) [43hq04cbdn1] Called com.android.org.conscrypt.SslWrapper.read(java.io.FileDescriptor, [B, int, int, int)</p><p>android hooking watch class_method com.android.org.conscrypt.ConscryptFileDescriptorSocket.$init</p></blockquote><p>在安卓10上结果</p><blockquote><p>(agent) [4816499695697] Called javax.net.ssl.HttpsURLConnection.getDefaultHostnameVerifier()<br>com.roysue.httpsocket on (google: 10) [usb] #<br>(agent) [4816499695697] Called javax.net.ssl.HttpsURLConnection.getDefaultSSLSocketFactory()<br>(agent) [4816499695697] Called javax.net.ssl.HttpsURLConnection.getDefaultSSLSocketFactory()<br>com.roysue.httpsocket on (google: 10) [usb] # (agent) [2575726777846] Called com.android.org.conscrypt.OpenSSLSocketImpl.isClosed()<br>(agent) [2575726777846] Called com.android.org.conscrypt.OpenSSLSocketImpl.isInputShutdown()<br>(agent) [2575726777846] Called com.android.org.conscrypt.OpenSSLSocketImpl.isOutputShutdown()<br>(agent) [4979599214099] Called com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLOutputStream.write([B, int, int)<br>(agent) [2575726777846] Called com.android.org.conscrypt.OpenSSLSocketImpl.isClosed()<br>(agent) [1105531481296] Called com.android.org.conscrypt.NativeSsl.write(java.io.FileDescriptor, [B, int, int, int)<br>(agent) [1105531481296] Called com.android.org.conscrypt.NativeSsl.isClosed()<br>(agent) [7367730933988] Called com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLInputStream.read([B, int, int)<br>(agent) [2575726777846] Called com.android.org.conscrypt.OpenSSLSocketImpl.isClosed()<br>(agent) [1105531481296] Called com.android.org.conscrypt.NativeSsl.read(java.io.FileDescriptor, [B, int, int, int)<br>(agent) [1105531481296] Called com.android.org.conscrypt.NativeSsl.isClosed()</p></blockquote><p><code>frida -UF -l hookSocket.js</code> 打印http抓包的结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plugin wallbreaker objectsearch com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLOutputStream</span><br><span class="line">plugin wallbreaker objectdump --fullname 0x3486</span><br></pre></td></tr></table></figure><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/image-20210516124228857.png" alt="image-20210516124228857"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">function hook_SSLsocketandroid8()&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        console.log(&quot;hook_SSLsocket&quot;)</span><br><span class="line">        </span><br><span class="line">        Java.use(&quot;com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLOutputStream&quot;).write.overload(&#39;[B&#39;, &#39;int&#39;, &#39;int&#39;).implementation &#x3D; function(bytearry,int1,int2)&#123;</span><br><span class="line">            var result &#x3D; this.write(bytearry,int1,int2);</span><br><span class="line">            &#x2F;&#x2F; console.log(&quot;HTTPS write result,bytearry,int1,int2&#x3D;&gt;&quot;,result,bytearry,int1,int2)</span><br><span class="line">            &#x2F;&#x2F; var ByteString &#x3D; Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);</span><br><span class="line">            &#x2F;&#x2F; console.log(&quot;bytearray contents&#x3D;&gt;&quot;, ByteString.of(bytearry).hex())</span><br><span class="line">            &#x2F;&#x2F;console.log(jhexdump(bytearry,int1,int2));</span><br><span class="line">            &#x2F;&#x2F; console.log(jhexdump(bytearry));</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; com.android.org.conscrypt.ConscryptFileDescriptorSocket this$0</span><br><span class="line">            console.log(this.this$0.value.sslSession.value.peerHost.value)</span><br><span class="line">            console.log(this.this$0.value.sslSession.value.peerPort.value)</span><br><span class="line">            console.log(this.this$0.value.sslSession.value.getProtocol())</span><br><span class="line">            console.log(this.this$0.value.sslSession.value.getRequestedServerName())</span><br><span class="line">            console.log(JSON.stringify( this.this$0.value.sslSession.value.getStatusResponses()))</span><br><span class="line">            console.log(this.this$0.value.sslSession.value.getValueNames().toString())</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">                </span><br><span class="line">        &#x2F;&#x2F; Java.use(&quot;com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLInputStream&quot;).read.overload(&#39;[B&#39;, &#39;int&#39;, &#39;int&#39;).implementation &#x3D; function(bytearry,int1,int2)&#123;</span><br><span class="line">        &#x2F;&#x2F;     var result &#x3D; this.read(bytearry,int1,int2);</span><br><span class="line">        &#x2F;&#x2F;     console.log(&quot;HTTPS read result,bytearry,int1,int2&#x3D;&gt;&quot;,result,bytearry,int1,int2)</span><br><span class="line">        &#x2F;&#x2F;     var ByteString &#x3D; Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);</span><br><span class="line">        &#x2F;&#x2F;     console.log(&quot;bytearray contents&#x3D;&gt;&quot;, ByteString.of(bytearry).hex())</span><br><span class="line">        &#x2F;&#x2F;     &#x2F;&#x2F;console.log(jhexdump(bytearry,int1,int2));</span><br><span class="line">        &#x2F;&#x2F;     &#x2F;&#x2F; console.log(jhexdump(bytearry));</span><br><span class="line">        &#x2F;&#x2F;     return result;</span><br><span class="line">        &#x2F;&#x2F; &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>frida 14</p><p>android hooking watch class_method com.android.org.conscrypt.ConscryptFileDescriptorSocket.$init</p><p>objection -g com.onejane.httpsocket explore -s “android hooking watch class_method com.android.org.conscrypt.ConscryptFileDescriptorSocket.$init”</p></blockquote><h1 id="File"><a href="#File" class="headerlink" title="File"></a>File</h1><p><a href="https://github.com/dpnishant/appmon" target="_blank" rel="noopener">appmon</a>中用到的API。12.8.0报错就切到14.*,<code>frida -UF -l HTTP.js</code>和<code>frida -UF -l Storage.js</code>和<code>frida -UF -l SharedPreferences.js</code></p><p><a href="https://github.com/MobSF/Mobile-Security-Framework-MobSF" target="_blank" rel="noopener">Mobile-Security-Framework-MobSF</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">objection -g comoolapk.market explore -s &quot;android hooking watch class android.content.ContextWrapper&quot;  下载app查看agent用到的api</span><br><span class="line">android hooking watch class_method android.content.ContextWrapper.getDataDir --dump-args --dump-backtrace --dump-return</span><br><span class="line">android hooking watch class_method android.content.ContextWrapper.getCacheDir --dump-args --dump-backtrace --dump-return</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">frida-ps -U|grep -i gravity</span><br><span class="line">objection -g com.ceco.oreo.gravitybox explore</span><br><span class="line">android hooking watch class android.app.SharedPreferencesImpl</span><br><span class="line">android hooking watch class_method android.app.SharedPreferencesImpl.getString --dump-args --dump-backtrace --dump-return</span><br></pre></td></tr></table></figure><h2 id="通杀"><a href="#通杀" class="headerlink" title="通杀"></a>通杀</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">objection -g comoolapk.market explore</span><br><span class="line">android hooking search classes File</span><br><span class="line">android hooking watch class java.io.File</span><br><span class="line">android hooking watch class_method java.io.File.getPath --dump-args --dump-backtrace --dump-return</span><br><span class="line">android hooking watch class_method java.io.File.delete --dump-args --dump-backtrace --dump-return</span><br><span class="line">android hooking watch class_method java.io.File.exists --dump-args --dump-backtrace --dump-return</span><br><span class="line">android hooking watch class_method java.io.File.list --dump-args --dump-backtrace --dump-return</span><br><span class="line">android hooking watch class_method java.io.File.getName --dump-args --dump-backtrace --dump-return</span><br><span class="line">cat objection.log | grep Return</span><br></pre></td></tr></table></figure><blockquote><p>java.io.File<br>java.lang.String</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android hooking watch class java.lang.String </span><br><span class="line">android hooking watch class_method java.lang.String.toString --dump-args --dump-return  安卓8</span><br><span class="line">android hooking watch class_method java.lang.String.equals --dump-args --dump-return  安卓10</span><br><span class="line">android hooking watch class_method java.lang.StringBuilder.$init --dump-args --dump-return</span><br><span class="line">android hooking watch class android.telephony.TelephonyManager  获取硬件信息</span><br><span class="line">plugin wallbreaker objectsearch android.telephony.TelephonyManager</span><br><span class="line">plugin wallbreaker objectdump 0x4563</span><br><span class="line">plugin wallbreaker classdump android.os.Build</span><br><span class="line">android hooking watch class_method android.telephony.TelephonyManager.getDeviceId --dump-args --dump-backtrace --dump-return</span><br><span class="line">frida -U -f com.coolapk.market -l File.js --no-pause -o file.txt</span><br><span class="line">frida -UF -l File.js --no-pause -o file.txt</span><br></pre></td></tr></table></figure><p><a href="https://mabin004.github.io/2018/12/20/%E5%88%A9%E7%94%A8Frida%E4%BF%AE%E6%94%B9Android%E8%AE%BE%E5%A4%87%E7%9A%84%E5%94%AF%E4%B8%80%E6%A0%87%E5%BF%97%E7%AC%A6/" target="_blank" rel="noopener">利用Frida修改Android设备的唯一标识符</a></p><p>修改Build.java</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private static String getString(String property) &#123;</span><br><span class="line">    String result &#x3D; SystemProperties.get(property, UNKNOWN) ;</span><br><span class="line">    if(property.equals(&quot;ro.product.brand&quot;))&#123;</span><br><span class="line">        result &#x3D; new String(&quot;r0ysueBRAND&quot;);</span><br><span class="line">    &#125;else if(property.equals((&quot;ro.product.manufacturer&quot;)))&#123;</span><br><span class="line">        result &#x3D; new String(&quot;r0ysueMANUFACTUERER&quot;);</span><br><span class="line">    &#125;else if(property.equals(&quot;ro.product.board&quot;))&#123;</span><br><span class="line">        result &#x3D; new String(&quot;r0ysueBOARD&quot;);</span><br><span class="line">    &#125;else if(property.equals(&quot;no.such.thing&quot;))&#123;</span><br><span class="line">        result &#x3D; new String(&quot;r0ysueAAAABBBBCCCCDDDD&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    Exception e &#x3D; new Exception(&quot;r0ysueFINGERPRINT&quot;);</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line">@RequiresPermission(Manifest.permission.READ_PHONE_STATE)</span><br><span class="line">public static String getSerial() &#123;</span><br><span class="line">    IDeviceIdentifiersPolicyService service &#x3D; IDeviceIdentifiersPolicyService.Stub</span><br><span class="line">            .asInterface(ServiceManager.getService(Context.DEVICE_IDENTIFIERS_SERVICE));</span><br><span class="line">    try &#123;</span><br><span class="line">        String result &#x3D;service.getSerial();</span><br><span class="line"></span><br><span class="line">        return &quot;r0ysueserial1234&quot;;</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">        e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">    return UNKNOWN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改TelephonyManager.java</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@RequiresPermission(android.Manifest.permission.READ_PHONE_STATE)</span><br><span class="line">public String getSimSerialNumber(int subId) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        IPhoneSubInfo info &#x3D; getSubscriberInfo();</span><br><span class="line">        String resutlt &#x3D; info.getIccSerialNumberForSubscriber(subId, mContext.getOpPackageName());</span><br><span class="line">        if (info &#x3D;&#x3D; null)</span><br><span class="line">            return null;</span><br><span class="line">        return &quot;r0ysueSERIALAAAABBBB&quot;;</span><br><span class="line">    &#125; catch (RemoteException ex) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125; catch (NullPointerException ex) &#123;</span><br><span class="line">        &#x2F;&#x2F; This could happen before phone restarts due to crashing</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@Deprecated</span><br><span class="line">@RequiresPermission(android.Manifest.permission.READ_PHONE_STATE)</span><br><span class="line">public String getDeviceId() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        ITelephony telephony &#x3D; getITelephony();</span><br><span class="line">        String result &#x3D; telephony.getDeviceId(mContext.getOpPackageName());</span><br><span class="line">        if (telephony &#x3D;&#x3D; null)</span><br><span class="line">            return null;</span><br><span class="line">        return &quot;r0ysueIMEI&quot;;</span><br><span class="line">    &#125; catch (RemoteException ex) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125; catch (NullPointerException ex) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>. build/envsetup.sh</p><p>lunch aosp_bullhead-user</p><p>m</p><p>替换编译生成img到官方镜像包中，重新打包成image-bullhead-opm1.171019.011.zip</p><p>./flash-all.sh</p></blockquote><p><a href="https://mabin004.github.io/2018/12/12/%E6%8C%87%E7%BA%B9/" target="_blank" rel="noopener">指纹识别技术安全分析</a></p><blockquote><p>对抗 不检测root，检测aosp，正常人不会用aosp，<code>App</code>可以通过判断java.net.NetworkInterface.getName()是否等于“tun0”或“ppp0”来判断是否存在VPN。Bypass也很简单，hook该api使其返回“rmnet_data1”，即可达到过vpn检测目的。</p></blockquote><p><a href="https://github.com/WalterInSH/risk-management-note" target="_blank" rel="noopener">风险控制笔记</a></p><h1 id="自制沙箱"><a href="#自制沙箱" class="headerlink" title="自制沙箱"></a>自制沙箱</h1><p><a href="https://bbs.pediy.com/thread-225717.html#msg_header_h2_22" target="_blank" rel="noopener">检测Android虚拟机的方法和代码实现</a></p><p><a href="https://www.anquanke.com/post/id/199898" target="_blank" rel="noopener">2020年安卓源码编译指南</a></p><p><a href="https://bbs.pediy.com/thread-255212.html" target="_blank" rel="noopener">Android 应用多开对抗实践</a></p><p>使用手机连接charles的代理，chsl.pro/ssl安装证书。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;data&#x2F;misc&#x2F;user&#x2F;0&#x2F;cacerts-added  查看新安装的证书a27a90a2.0</span><br><span class="line">cp a27a90a2.0 &#x2F;sdcard&#x2F;Download</span><br><span class="line">cd Desktop&#x2F;asop810r1&#x2F;system&#x2F;ca-certificates&#x2F;files</span><br><span class="line">adb pull &#x2F;sdcard&#x2F;Download&#x2F;a27a90a2.0</span><br><span class="line">. build&#x2F;envsetup.sh</span><br><span class="line">lunch aosp_bullhead-user  编译，没有root，使用user-debug有root</span><br></pre></td></tr></table></figure><p>修改<a href="http://androidxref.com/8.1.0_r33/xref/libcore/ojluni/src/main/java/java/security/KeyStore.java" target="_blank" rel="noopener">KeyStore.java</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public final void load(InputStream stream, char[] password)</span><br><span class="line">        throws IOException, NoSuchAlgorithmException, CertificateException &#123;</span><br><span class="line">    if (password !&#x3D; null) &#123;</span><br><span class="line">        String inputPASSWORD &#x3D; new String(password);</span><br><span class="line">        Class logClass &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            logClass &#x3D; this.getClass().getClassLoader().loadClass(&quot;android.util.Log&quot;);</span><br><span class="line">        &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        Method loge &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            loge &#x3D; logClass.getMethod(&quot;e&quot;, String.class, String.class);</span><br><span class="line">        &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            loge.invoke(null, &quot;r0ysueKeyStoreLoad&quot;, &quot;KeyStore load PASSWORD is &#x3D;&gt; &quot; + inputPASSWORD);</span><br><span class="line">            Exception e &#x3D; new Exception(&quot;r0ysueKeyStoreLoad&quot;);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Date now &#x3D; new Date();</span><br><span class="line">        String currentTime &#x3D; String.valueOf(now.getTime());</span><br><span class="line">        FileOutputStream fos &#x3D; new FileOutputStream(&quot;&#x2F;sdcard&#x2F;Download&#x2F;&quot; + inputPASSWORD + currentTime);</span><br><span class="line">        byte[] b &#x3D; new byte[1024];</span><br><span class="line">        int length;</span><br><span class="line">        while ((length &#x3D; stream.read(b)) &gt; 0) &#123;</span><br><span class="line">            fos.write(b, 0, length);</span><br><span class="line">        &#125;</span><br><span class="line">        fos.flush();</span><br><span class="line">        fos.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    keyStoreSpi.engineLoad(stream, password);</span><br><span class="line">    initialized &#x3D; true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改SocketOutputStream.java</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">private void socketWrite(byte b[], int off, int len) throws IOException &#123;</span><br><span class="line">    if (len &lt;&#x3D; 0 || off &lt; 0 || len &gt; b.length - off) &#123;</span><br><span class="line">        if (len &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        throw new ArrayIndexOutOfBoundsException(&quot;len &#x3D;&#x3D; &quot; + len</span><br><span class="line">                + &quot; off &#x3D;&#x3D; &quot; + off + &quot; buffer length &#x3D;&#x3D; &quot; + b.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FileDescriptor fd &#x3D; impl.acquireFD();</span><br><span class="line">    try &#123;</span><br><span class="line">        BlockGuard.getThreadPolicy().onNetwork();</span><br><span class="line">        socketWrite0(fd, b, off, len);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if(len&gt;0)&#123;</span><br><span class="line">            byte[] input &#x3D; new byte[len];</span><br><span class="line">            System.arraycopy(b,off,input,0,len);</span><br><span class="line"></span><br><span class="line">            String inputString &#x3D; new String(input);</span><br><span class="line">            Class logClass &#x3D; null;</span><br><span class="line">            try &#123;</span><br><span class="line">                logClass &#x3D; this.getClass().getClassLoader().loadClass(&quot;android.util.Log&quot;);</span><br><span class="line">            &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            Method loge &#x3D; null;</span><br><span class="line">            try &#123;</span><br><span class="line">                loge &#x3D; logClass.getMethod(&quot;e&quot;,String.class,String.class);</span><br><span class="line">            &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                loge.invoke(null,&quot;r0ysueSOCKETrequest&quot;,&quot;Socket is &#x3D;&gt; &quot;+this.socket.toString());</span><br><span class="line">                loge.invoke(null,&quot;r0ysueSOCKETrequest&quot;,&quot;buffer is &#x3D;&gt; &quot;+inputString);</span><br><span class="line">                Exception e &#x3D; new Exception(&quot;r0ysueSOCKETrequest&quot;);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125; catch (SocketException se) &#123;</span><br><span class="line">        if (se instanceof sun.net.ConnectionResetException) &#123;</span><br><span class="line">            impl.setConnectionResetPending();</span><br><span class="line">            se &#x3D; new SocketException(&quot;Connection reset&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (impl.isClosedOrPending()) &#123;</span><br><span class="line">            throw new SocketException(&quot;Socket closed&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            throw se;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        impl.releaseFD();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;SocketOutputStream</span><br></pre></td></tr></table></figure><p>修改SocketInputStream.java</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">private int socketRead(FileDescriptor fd,</span><br><span class="line">                       byte b[], int off, int len,</span><br><span class="line">                       int timeout)</span><br><span class="line">    throws IOException &#123;</span><br><span class="line">    int result &#x3D; socketRead0(fd, b, off, len, timeout);</span><br><span class="line"></span><br><span class="line">    if(result&gt;0)&#123;</span><br><span class="line">        byte[] input &#x3D; new byte[result];</span><br><span class="line">        System.arraycopy(b,off,input,0,result);</span><br><span class="line"></span><br><span class="line">        String inputString &#x3D; new String(input);</span><br><span class="line">        Class logClass &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            logClass &#x3D; this.getClass().getClassLoader().loadClass(&quot;android.util.Log&quot;);</span><br><span class="line">        &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        Method loge &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            loge &#x3D; logClass.getMethod(&quot;e&quot;,String.class,String.class);</span><br><span class="line">        &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            loge.invoke(null,&quot;r0ysueSOCKETresponse&quot;,&quot;Socket is &#x3D;&gt; &quot;+this.socket.toString());</span><br><span class="line">            loge.invoke(null,&quot;r0ysueSOCKETresponse&quot;,&quot;buffer is &#x3D;&gt; &quot;+inputString);</span><br><span class="line">            Exception e &#x3D; new Exception(&quot;r0ysueSOCKETresponse&quot;);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改SslWrapper.java</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">int read(FileDescriptor fd, byte[] buf, int offset, int len, int timeoutMillis)</span><br><span class="line">            throws IOException &#123;</span><br><span class="line">        int result &#x3D; NativeCrypto.SSL_read(ssl, fd, handshakeCallbacks, buf, offset, len, timeoutMillis) ;</span><br><span class="line">        if(result&gt;0)&#123;</span><br><span class="line">            byte[] input &#x3D; new byte[result];</span><br><span class="line">            System.arraycopy(buf,offset,input,0,result);</span><br><span class="line">            String inputString &#x3D; new String(input);</span><br><span class="line">            Class logClass &#x3D; null;</span><br><span class="line">            try &#123;</span><br><span class="line">                logClass &#x3D; this.getClass().getClassLoader().loadClass(&quot;android.util.Log&quot;);</span><br><span class="line">            &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            Method loge &#x3D; null;</span><br><span class="line">            try &#123;</span><br><span class="line">                loge &#x3D; logClass.getMethod(&quot;e&quot;,String.class,String.class);</span><br><span class="line">            &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                loge.invoke(null,&quot;r0ysueSOCKETresponse&quot;,&quot;SSL is &#x3D;&gt;&quot;+this.handshakeCallbacks.toString());</span><br><span class="line">                loge.invoke(null,&quot;r0ysueSOCKETresponse&quot;,&quot;buffer is &#x3D;&gt; &quot;+inputString);</span><br><span class="line">                Exception e &#x3D; new Exception(&quot;r0ysueSOCKETresponse&quot;);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    void write(FileDescriptor fd, byte[] buf, int offset, int len, int timeoutMillis)</span><br><span class="line">            throws IOException &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if(len&gt;0)&#123;</span><br><span class="line">            byte[] input &#x3D; new byte[len];</span><br><span class="line">            System.arraycopy(buf,offset,input,0,len);</span><br><span class="line"></span><br><span class="line">            String inputString &#x3D; new String(input);</span><br><span class="line">            Class logClass &#x3D; null;</span><br><span class="line">            try &#123;</span><br><span class="line">                logClass &#x3D; this.getClass().getClassLoader().loadClass(&quot;android.util.Log&quot;);</span><br><span class="line">            &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            Method loge &#x3D; null;</span><br><span class="line">            try &#123;</span><br><span class="line">                loge &#x3D; logClass.getMethod(&quot;e&quot;,String.class,String.class);</span><br><span class="line">            &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                loge.invoke(null,&quot;r0ysueSSLrequest&quot;,&quot;SSL is &#x3D;&gt; &quot;+this.handshakeCallbacks.toString());</span><br><span class="line">                loge.invoke(null,&quot;r0ysueSSLrequest&quot;,&quot;buffer is &#x3D;&gt; &quot;+inputString);</span><br><span class="line">                Exception e &#x3D; new Exception(&quot;r0ysueSSLrequest&quot;);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        NativeCrypto.SSL_write(ssl, fd, handshakeCallbacks, buf, offset, len, timeoutMillis);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>编译好后，刷机，安装soul使用chales抓包,查看logcat中Keystore加载的Password，下载下来的证书改名为soul.p12安装实现App客户端证书文件和密码自吐</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make update-api  由于修改了文件，更新api</span><br><span class="line">m</span><br></pre></td></tr></table></figure><h1 id="甲方风控"><a href="#甲方风控" class="headerlink" title="甲方风控"></a>甲方风控</h1><p><a href="https://www.anquanke.com/post/id/197657#h2-9" target="_blank" rel="noopener">实用FRIDA进阶：内存漫游、hook anywhere、抓包</a></p><h2 id="r0capture"><a href="#r0capture" class="headerlink" title="r0capture"></a>r0capture</h2><p>git clone <a href="https://github.com/r0ysue/r0capture.git" target="_blank" rel="noopener">https://github.com/r0ysue/r0capture.git</a></p><blockquote><ul><li>仅限安卓平台，测试安卓7、8、9、10、11 可用 ；</li><li>无视所有证书校验或绑定，不用考虑任何证书的事情；</li><li>通杀TCP/IP四层模型中的应用层中的全部协议；</li><li>通杀协议包括：Http,WebSocket,Ftp,Xmpp,Imap,Smtp,Protobuf等等、以及它们的SSL版本；</li><li>通杀所有应用层框架，包括HttpUrlConnection、Okhttp1/3/4、Retrofit/Volley等等；</li><li>无视加固，不管是整体壳还是二代壳或VMP，不用考虑加固的事情；</li></ul></blockquote><p>python r0capture.py -U cn.soulapp.android -v</p><p>python r0capture.py -U -f com.qiyi.video -v</p><p>frida -UF -l hookSSLSocket.js</p><p>frida -U -f cn.soulapp.android -l saveClientCet.js –no-pause 增加客户端证书dump功能</p><p>adb pull /sdcard/Download/ff93e99.p12</p><p><a href="https://keystore-explorer.org/" target="_blank" rel="noopener">证书转换工具</a> 支持bks to p12 把安卓转成Charles支持的p12</p><p>charles-Proxy-SSL Proxying Settings-Client Certificates-Create Secure Store-设置自定义密码，配置Host/Port为*对任何IP任何端口使用该证书，Import P12-填入SSL Certificate Password,即抓到的key密码</p><p><strong>为沙箱增加调用栈dump证书</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">function hook_KeyStore_load() &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        var ByteString &#x3D; Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);</span><br><span class="line">        var myArray&#x3D;new Array(1024);</span><br><span class="line">        var i &#x3D; 0</span><br><span class="line">        for (i &#x3D; 0; i &lt; myArray.length; i++) &#123;</span><br><span class="line">            myArray[i]&#x3D; 0x0;</span><br><span class="line">         &#125;</span><br><span class="line">        var buffer &#x3D; Java.array(&#39;byte&#39;,myArray);</span><br><span class="line">        </span><br><span class="line">        var StringClass &#x3D; Java.use(&quot;java.lang.String&quot;);</span><br><span class="line">        var KeyStore &#x3D; Java.use(&quot;java.security.KeyStore&quot;);</span><br><span class="line">        KeyStore.load.overload(&#39;java.security.KeyStore$LoadStoreParameter&#39;).implementation &#x3D; function (arg0) &#123;</span><br><span class="line">            console.log(Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new()));</span><br><span class="line"></span><br><span class="line">            console.log(&quot;KeyStore.load1:&quot;, arg0);</span><br><span class="line">            this.load(arg0);</span><br><span class="line">        &#125;;</span><br><span class="line">        KeyStore.load.overload(&#39;java.io.InputStream&#39;, &#39;[C&#39;).implementation &#x3D; function (arg0, arg1) &#123;</span><br><span class="line">            console.log(Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new()));</span><br><span class="line"></span><br><span class="line">            console.log(&quot;KeyStore.load2:&quot;, arg0, arg1 ? StringClass.$new(arg1) : null);</span><br><span class="line"></span><br><span class="line">            if (arg0)&#123;</span><br><span class="line">                var file &#x3D;  Java.use(&quot;java.io.File&quot;).$new(&quot;&#x2F;sdcard&#x2F;Download&#x2F;&quot;+ String(arg0)+&quot;.p12&quot;);</span><br><span class="line">                var out &#x3D; Java.use(&quot;java.io.FileOutputStream&quot;).$new(file);</span><br><span class="line">                var r;</span><br><span class="line">                while( (r &#x3D; arg0.read(buffer)) &gt; 0)&#123;</span><br><span class="line">                    out.write(buffer,0,r)</span><br><span class="line">                &#125;</span><br><span class="line">                console.log(&quot;save success!&quot;)</span><br><span class="line">                out.close()</span><br><span class="line">            &#125;</span><br><span class="line">            this.load(arg0, arg1);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        console.log(&quot;hook_KeyStore_load...&quot;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; android.content.res.AssetManager$AssetInputStream@9b10ad6 bxMAFPL9gc@ntKTqmV@A</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; android.content.res.AssetManager$AssetInputStream@41ce8f6 &#125;%2R+\OSsjpP!w%X</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; android.content.res.AssetManager$AssetInputStream@54858e6 cods.org.cn</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重新使用charles即可抓到soul包</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">objection -g cn.soulapp.android explore </span><br><span class="line">android hooking search classes keystore  将打印的类放到文keystore.txt件中，批量hook,前面加上android hooking watch class</span><br><span class="line">objection -g cn.soulapp.android explore  -c keystore.txt</span><br><span class="line">plugin wallbreaker objectsearch java.security.KeyStore$PrivateKeyEntry</span><br><span class="line">plugin wallbreaker objectdump --fullname 0x0123u</span><br><span class="line">android hooking watch class_method java.security.KeyStore$PrivateKeyEntry.getCertificateChain --dump-args --dump-backtrace --dump-return</span><br><span class="line">android hooking watch class_method java.security.KeyStore$PrivateKeyEntry.getPrivateKey --dump-args --dump-backtrace --dump-return</span><br></pre></td></tr></table></figure><p><a href="https://gitee.com/Barryda/QtScrcpy" target="_blank" rel="noopener">QtScrCpy 手机投屏 Linux版</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install libsdl2-2.0-0</span><br><span class="line">.&#x2F;run x</span><br></pre></td></tr></table></figure><p><strong>为沙箱增加客户端证书DUMP的功能</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f cn.soulapp.android -l 2021trace.js --no-pause -o traceresult.txt   查看java.security.KeyStore$PrivateKeyEntry的调用栈</span><br><span class="line">objection -g cn.soulapp.android explore </span><br><span class="line">plugin load &#x2F;root&#x2F;Desktop&#x2F;Wallbreaker</span><br><span class="line">plugin wallbreaker objectsearch java.security.KeyStore$PrivateKeyEntry</span><br><span class="line">plugin wallbreaker objectdump --fullname 0x123f  查看KeyStore$PrivateKeyEntry类的privateKey和publicKey</span><br><span class="line">android heap search instances java.security.KeyStore$PrivateKeyEntry</span><br><span class="line">android heap execute 0x2ce7 getPrivateKey()  主动调用</span><br></pre></td></tr></table></figure><p>js实现,<code>frida -U- f cn.soulapp.android -l savePrivateKey.js --no-pause</code> 打开app后查看/data/local/tmp/soul下的证书文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">setImmediate(function () &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        console.log(&quot;Entering&quot;)</span><br><span class="line">        Java.use(&quot;java.security.KeyStore$PrivateKeyEntry&quot;).getPrivateKey.implementation &#x3D; function () &#123;</span><br><span class="line">            console.log(&quot;Calling java.security.KeyStore$PrivateKeyEntry.getPrivateKey method &quot;)</span><br><span class="line">            var result &#x3D; this.getPrivateKey()</span><br><span class="line">            console.log(&quot;toString result is &#x3D;&gt; &quot;, result.toString())</span><br><span class="line">            storeP12(this.getPrivateKey(),this.getCertificate(),&#39;&#x2F;data&#x2F;local&#x2F;tmp&#x2F;soul&#39;+uuid(10,16)+&#39;.p12&#39;,&#39;hello&#39;);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">        Java.use(&quot;java.security.KeyStore$PrivateKeyEntry&quot;).getCertificateChain.implementation &#x3D; function () &#123;</span><br><span class="line">            console.log(&quot;Calling java.security.KeyStore$PrivateKeyEntry.getCertificateChain method &quot;)</span><br><span class="line">            var result &#x3D; this.getCertificateChain()</span><br><span class="line">            storeP12(this.getPrivateKey(),this.getCertificate(),&#39;&#x2F;data&#x2F;local&#x2F;tmp&#x2F;soul&#39;+uuid(10,16)+&#39;.p12&#39;,&#39;hello&#39;);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">function storeP12(pri, p7, p12Path, p12Password) &#123;</span><br><span class="line">    var X509Certificate &#x3D; Java.use(&quot;java.security.cert.X509Certificate&quot;)</span><br><span class="line">    var p7X509 &#x3D; Java.cast(p7, X509Certificate);</span><br><span class="line">    var chain &#x3D; Java.array(&quot;java.security.cert.X509Certificate&quot;, [p7X509])</span><br><span class="line">    var ks &#x3D; Java.use(&quot;java.security.KeyStore&quot;).getInstance(&quot;PKCS12&quot;, &quot;BC&quot;);</span><br><span class="line">    ks.load(null, null);</span><br><span class="line">    ks.setKeyEntry(&quot;client&quot;, pri, Java.use(&#39;java.lang.String&#39;).$new(p12Password).toCharArray(), chain);</span><br><span class="line">    try &#123;</span><br><span class="line">        var out &#x3D; Java.use(&quot;java.io.FileOutputStream&quot;).$new(p12Path);</span><br><span class="line">        ks.store(out, Java.use(&#39;java.lang.String&#39;).$new(p12Password).toCharArray())</span><br><span class="line">    &#125; catch (exp) &#123;</span><br><span class="line">        console.log(exp)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">function uuid(len, radix) &#123;</span><br><span class="line">    var chars &#x3D; &#39;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&#39;.split(&#39;&#39;);</span><br><span class="line">    var uuid &#x3D; [], i;</span><br><span class="line">    radix &#x3D; radix || chars.length;</span><br><span class="line"></span><br><span class="line">    if (len) &#123;</span><br><span class="line">        &#x2F;&#x2F; Compact form</span><br><span class="line">        for (i &#x3D; 0; i &lt; len; i++) uuid[i] &#x3D; chars[0 | Math.random() * radix];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; rfc4122, version 4 form</span><br><span class="line">        var r;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; rfc4122 requires these characters</span><br><span class="line">        uuid[8] &#x3D; uuid[13] &#x3D; uuid[18] &#x3D; uuid[23] &#x3D; &#39;-&#39;;</span><br><span class="line">        uuid[14] &#x3D; &#39;4&#39;;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Fill in random data. At i&#x3D;&#x3D;19 set the high bits of clock sequence as</span><br><span class="line">        &#x2F;&#x2F; per rfc4122, sec. 4.1.5</span><br><span class="line">        for (i &#x3D; 0; i &lt; 36; i++) &#123;</span><br><span class="line">            if (!uuid[i]) &#123;</span><br><span class="line">                r &#x3D; 0 | Math.random() * 16;</span><br><span class="line">                uuid[i] &#x3D; chars[(i &#x3D;&#x3D; 19) ? (r &amp; 0x3) | 0x8 : r];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return uuid.join(&#39;&#39;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>adb pull /data/local/tmp</code> 使用KeyStore Explorer打开，密码是hello</p><p>charles-手机连接代理-SSL Proxying Settings-Client Certificates-Add-Import P12-密码hello-Host和Port配置*，启动Postern,启动soul成功抓包</p><p>adb install dida.apk 通过top查看包名<code>cn.ticktick.task</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objection -g cn.ticktick.task explore -s &quot;android hooking watch class_method java.io.File.\$init --dump-args --dump-return --dump-backtrace&quot;</span><br></pre></td></tr></table></figure><p><code>frida -U -f cn.ticktick.task -l sslpinninghelper.js --no-pause</code> 打印证书路径</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">setImmediate(function()&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        Java.use(&quot;java.io.File&quot;).$init.overload(&#39;java.io.File&#39;, &#39;java.lang.String&#39;).implementation &#x3D; function(file,cert)&#123;</span><br><span class="line">            var result &#x3D; this.$init(file,cert)</span><br><span class="line">            var stack &#x3D; Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new());</span><br><span class="line">            </span><br><span class="line">            if(file.getPath().indexOf(&quot;cacert&quot;)&gt;0 &amp;&amp; stack.indexOf(&quot;X509TrustManagerExtensions.checkServerTrusted&quot;)&gt; 0)&#123;</span><br><span class="line">                console.log(&quot;path,cart&quot;,file.getPath(), cert)</span><br><span class="line">                console.log(stack);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>SSL pinning helper 帮助定位证书绑定的关键代码，在服务器校验客户端的情形下，帮助dump客户端证书，并保存为p12的格式</p><p>pm -l | grep -i soul</p><p>pm -l | grep -i ticktick</p><p>pip install hexdump</p><p>python r0capture.py -U -f cn.soulapp.android -v &gt;&gt;sout.txt 重新抓包，frida 14.0.8</p><p>python r0capture.py -U -f cn.ticktick.task -v &gt;&gt;tick.txt</p><h1 id="框架层抓包"><a href="#框架层抓包" class="headerlink" title="框架层抓包"></a>框架层抓包</h1><p>沙箱SslWrapper.java 的修改等同于hook <code>Java.use(&quot;com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLInputStream&quot;).read.overload(&#39;[B&#39;, &#39;int&#39;, &#39;int&#39;)</code>实现定位收发包函数的功能。</p><p>基于trace的内存漫游确认<code>Java.use(&quot;java.security.KeyStore$PrivateKeyEntry&quot;).getCertificateChain</code>客户端证书dump导出功能。</p><p>增加混淆后的SSLping代码定位功能<code>stack.indexOf(&quot;X509TrustManagerExtensions.checkServerTrusted&quot;)</code></p><p>抓包沙箱植入根证书绕过客户端校验服务器，<code>cd aosp810r1/system/ca-certificates/files</code> 根证书目录，将charles的证书下载到该文件目录下，编译生成镜像，形成中间人</p><p>抓包沙箱导出客户端证书绕过服务器校验客户端，<a href="http://androidxref.com/8.1.0_r33/xref/libcore/ojluni/src/main/java/java/security/KeyStore.java" target="_blank" rel="noopener">KeyStore.java</a>有个内部方法PrivateKeyEntry</p><p>KeyStore.java 去除上面自制沙箱时 <code>public final void load(InputStream stream, char[] password)</code>的修改</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">public PrivateKey getPrivateKey() &#123;</span><br><span class="line"></span><br><span class="line">            String p12Password &#x3D; &quot;r0ysue&quot;;</span><br><span class="line">            Date now &#x3D; new Date();</span><br><span class="line">            String currentTime &#x3D; String.valueOf(now.getTime());</span><br><span class="line">            String p12Path &#x3D; &quot;&#x2F;sdcard&#x2F;Download&#x2F;tmp&quot;  + currentTime + &quot;.p12&quot;;</span><br><span class="line"></span><br><span class="line">            X509Certificate p7X509 &#x3D; (X509Certificate) chain[0];</span><br><span class="line">            Certificate[] mychain &#x3D; new Certificate[]&#123;p7X509&#125;;</span><br><span class="line">            &#x2F;&#x2F; 生成一个空的p12证书</span><br><span class="line">            KeyStore myks &#x3D; null;</span><br><span class="line">            try &#123;</span><br><span class="line">                myks &#x3D; KeyStore.getInstance(&quot;PKCS12&quot;, &quot;BC&quot;);</span><br><span class="line">            &#125; catch (KeyStoreException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; catch (NoSuchProviderException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                myks.load(null, null);</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; catch (NoSuchAlgorithmException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; catch (CertificateException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; 将服务器返回的证书导入到p12中去</span><br><span class="line">            try &#123;</span><br><span class="line">                myks.setKeyEntry(&quot;client&quot;, privKey, p12Password.toCharArray(), mychain);</span><br><span class="line">            &#125; catch (KeyStoreException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; 加密保存p12证书</span><br><span class="line">            FileOutputStream fOut &#x3D; null;</span><br><span class="line">            try &#123;</span><br><span class="line">                fOut &#x3D; new FileOutputStream(p12Path);</span><br><span class="line">            &#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                myks.store(fOut, p12Password.toCharArray());</span><br><span class="line">            &#125; catch (KeyStoreException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; catch (NoSuchAlgorithmException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; catch (CertificateException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return privKey;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>抓包沙箱之定位(混淆后的)SSLpinning代码，修改File.java,去除上面</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">public File(File parent, String child) &#123;</span><br><span class="line">        if (child &#x3D;&#x3D; null) &#123;</span><br><span class="line">            throw new NullPointerException();</span><br><span class="line">        &#125;</span><br><span class="line">        if (parent !&#x3D; null) &#123;</span><br><span class="line">            if (parent.path.equals(&quot;&quot;)) &#123;</span><br><span class="line">                this.path &#x3D; fs.resolve(fs.getDefaultParent(),</span><br><span class="line">                        fs.normalize(child));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                this.path &#x3D; fs.resolve(parent.path,</span><br><span class="line">                        fs.normalize(child));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            this.path &#x3D; fs.normalize(child);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Class logClass &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            logClass &#x3D; this.getClass().getClassLoader().loadClass(&quot;android.util.Log&quot;);</span><br><span class="line">        &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        Method loge &#x3D; null;</span><br><span class="line">        Method getStackTraceString &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">&#x2F;&#x2F;            loge &#x3D; logClass.getMethod(&quot;e&quot;, String.class, String.class);</span><br><span class="line">            getStackTraceString &#x3D; logClass.getMethod(&quot;getStackTraceString&quot;,Throwable.class);</span><br><span class="line">        &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">&#x2F;&#x2F;            loge.invoke(null, &quot;r0ysueKeyStoreLoad&quot;, &quot;KeyStore load PASSWORD is &#x3D;&gt; &quot; + inputPASSWORD);</span><br><span class="line">            String stack &#x3D; (String)getStackTraceString.invoke(null,new Throwable());</span><br><span class="line">            if (parent.getPath().indexOf(&quot;cacert&quot;) &gt;&#x3D; 0 &amp;&amp;</span><br><span class="line">                    stack.indexOf(&quot;X509TrustManagerExtensions.checkServerTrusted&quot;) &gt;&#x3D; 0) &#123;</span><br><span class="line">                Exception e &#x3D; new Exception(&quot;r0ysueFileSSLpinning&quot;);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        this.prefixLength &#x3D; fs.prefixLength(this.path);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>编译刷机</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lunch aosp_bullhead-user</span><br><span class="line">m  编译完更新system.img到官方镜像bullhead刷机</span><br></pre></td></tr></table></figure><p>默认系统报错<code>400 No required SSL certificate was sent</code>,导入证书到SSLProxying Setting才能正确抓到soul包</p><p>绕过滴答 <code>frida -U -f cn.ticktick.task -l bypassPinning.js --no-pause</code>默认报错<code>trust the Charles Root Certificate</code> ,客户端收到charles的证书，计算公钥hash后比对结果决定发请求结果。</p><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/image-20210528110037286.png" alt="image-20210528110037286"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">setImmediate(function()&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        console.log(&quot;Bypassing&quot;)</span><br><span class="line">        Java.use(&quot;z1.g&quot;).a.implementation &#x3D; function()&#123;</span><br><span class="line">            console.log(&quot;called here&quot;)</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h1 id="HTTPS客户端证书多重证书绑定"><a href="#HTTPS客户端证书多重证书绑定" class="headerlink" title="HTTPS客户端证书多重证书绑定"></a>HTTPS客户端证书多重证书绑定</h1><h2 id="咪咕视频"><a href="#咪咕视频" class="headerlink" title="咪咕视频"></a>咪咕视频</h2><p>登录抓包，<code>SSL handshake with client failed: An unknown issue occurred processing the certificate (certificate_unknown)</code>从抓包发现证书 绑定,可能客户端只信任信任的公钥签名，不信任就不允许，停止客户端访问的证书绑定。客户端发了，我们已经绕过了校验，把自己公钥发给charles，charles用自己私钥解开客户端的公钥发现不正常的结果。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dumpsys activity top  查看包名 com.ophone.reader.ui</span><br><span class="line">objection -g com.ophone.reader.ui explore</span><br><span class="line">android sslpinning disable  需要在启动时运行</span><br><span class="line">objection -g com.ophone.reader.ui explore -s &quot;android sslpinning disable&quot;  在点我登录页面触发解绑定，如果崩溃</span><br><span class="line">objection -g com.ophone.reader.ui explore  在点我登录时开始漫游</span><br><span class="line">android sslpinning disable   解绑定后再获取验证码，再抓包</span><br></pre></td></tr></table></figure><p>证书绑定的逻辑没有hook掉：”at <a href="http://com.bangcle.andjni.jnilib.cl/" target="_blank" rel="noopener">com.bangcle.andjni.JniLib.cL</a>(Native Method)” → 只有逆代码来过证书绑定</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python r0capture.py -U com.ophone.reader.ui -v -p migu.pcap  关闭postern抓包,获取验证码没有更新log，说明没有一些底层的框架</span><br></pre></td></tr></table></figure><p>通过wireshark查看migu.pcap结果，发现也没有关键性信息，抓包也抓不到。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">python r0capture.py -U -f com.ophone.reader.ui -v  尝试导出证书</span><br><span class="line">frida -U -f com.ophone.reader.ui -l script.js --no-pause</span><br><span class="line">adb shell 查看sdcard&#x2F;Download下的证书</span><br><span class="line">adb pull &#x2F;sdcard&#x2F;Download&#x2F;ophone 下的证书导入到Charles的SSL Proxying Settings中，打开postern抓包</span><br><span class="line">objection -g com.ophone.reader.ui explore  在点我登录时开始漫游</span><br><span class="line">android sslpinning disable   解绑定后再获取验证码抓包即可获取passport.migu.cn:8443的包信息</span><br></pre></td></tr></table></figure><blockquote><p>SSL handshake with server failed - Remote host terminated the handshake<br>The remote SSL server rejected the connection. The server may require a specific certificate or cipher not supported by Charles.</p></blockquote><p>过客户端证书后发现更多证书绑定,<a href="https://github.com/WooyunDota/DroidDrops/blob/master/2018/Frida.Android.Practice.md" target="_blank" rel="noopener">Frida.Android.Practice</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objection -g com.ophone.reader.ui explore -s &quot;android sslpinning disable&quot;</span><br></pre></td></tr></table></figure><p>git clone <a href="https://github.com/WooyunDota/DroidSSLUnpinning.git" target="_blank" rel="noopener">https://github.com/WooyunDota/DroidSSLUnpinning.git</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f com.ophone.reader.ui -l hooks.js --no-pause   抓发送验证码包依旧有请求失败</span><br></pre></td></tr></table></figure><p><a href="https://bbs.pediy.com/thread-265160.htm" target="_blank" rel="noopener">FRIDA 使用经验交流分享</a>，git clone <a href="https://github.com/deathmemory/FridaContainer.git" target="_blank" rel="noopener">https://github.com/deathmemory/FridaContainer.git</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd utils&#x2F;android</span><br><span class="line">frida -U -f com.ophone.reader.ui -l multi_unpinning.js --no-pause</span><br><span class="line">objection -g com.ophone.reader.ui explore -s &quot;android hooking watch class_method java.io.File.\$init --dump-args --dump-backtrace --dump-return&quot;  查看证书</span><br><span class="line">frida -U -f com.ophone.reader.ui -l trace.js --no-pause -o ophone.txt 修改trace.js中traceClass(&quot;java.io.File&quot;),在traceClass中修改targets&#x3D;[]只trace init方法,在traceMethod中打开调用栈android.util.log，发送验证码后查看文件,搜索cacert查看调用栈</span><br></pre></td></tr></table></figure><p><img src="/2021/05/06/frida%E6%B2%99%E7%AE%B1%E8%87%AA%E5%90%90%E5%AE%9E%E7%8E%B0/image-20210528115202167.png" alt="image-20210528115202167"></p><h2 id="北京银行"><a href="#北京银行" class="headerlink" title="北京银行"></a>北京银行</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python r0capture.py -U -f com.bankofbeijing.mobilebanking -v</span><br><span class="line">.&#x2F;hluda-server-14.2.1-android-arm64</span><br><span class="line">frida -U -f com.bankofbeijing.mobilebanking -l script.js --no-pause -o bjbank.txt</span><br><span class="line">frida -U -f com.bankofbeijing.mobilebanking -l trace.js --no-pause -o bjbank2.txt  打开traceClass(&quot;java.security.KeyStore$PrivateKeyEntry&quot;)</span><br></pre></td></tr></table></figure><p>加固厂商自定义开发的证书绑定对抗很难被攻克。</p></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="mailto:undefined">J</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="http://onejane.github.io/2021/05/06/frida沙箱自吐实现/">http://onejane.github.io/2021/05/06/frida沙箱自吐实现/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://onejane.github.io">J</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/objection/">objection</a><a class="post-meta__tags" href="/tags/frida/">frida</a><a class="post-meta__tags" href="/tags/ssl/">ssl</a><a class="post-meta__tags" href="/tags/aosp/">aosp</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="http://onejane.gitee.io/picture/alipay.png"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="http://onejane.gitee.io/picture/wx.png"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share pull-right" data-disabled="google,facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/05/09/Redis%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"><i class="fa fa-chevron-left"></i> <span>Redis快速入门</span></a></div><div class="next-post pull-right"><a href="/2021/05/04/%E9%AD%94%E6%94%B9%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/"><span>魔改系统源码编译</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify=!1,verify=!1,record_ip=!1,GUEST_INFO=["nick","mail","link"],guest_info="nick,mail,link".split(",").filter(function(i){return-1<GUEST_INFO.indexOf(i)});guest_info=0==guest_info.length?GUEST_INFO:guest_info,window.valine=new Valine({el:"#vcomment",notify:notify,verify:verify,recordIP:record_ip,appId:"cWLsquGr5PNi33OWXNhzerep-gzGzoHsz",appKey:"S35phfCSbm8dAG9LpOc5rjm3",placeholder:"一起来吹牛逼好吗！",avatar:"mm",guest_info:guest_info,pageSize:"10",lang:"zh-cn"})</script></div></div><footer class="footer-bg" style="background-image:url(http://onejane.gitee.io/picture/kali.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 By J</div><div class="framework-info"><span>驱动 -</span> <a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 -</span> <a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script>/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)&&($("#nav").addClass("is-mobile"),$("footer").addClass("is-mobile"),$("#top-container").addClass("is-mobile"))</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49b1f5">hexo-generator-search</a> <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>