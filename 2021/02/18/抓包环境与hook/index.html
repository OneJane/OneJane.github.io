<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="抓包环境与hook"><meta name="keywords" content="postern,charles,burpsuite"><meta name="author" content="J"><meta name="copyright" content="J"><title>抓包环境与hook | 万物皆可逆向</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?a345f534c85363668f09d4d5c6a9ee81";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-111479568-4","auto"),ga("send","pageview")</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer="defer"></script><script>var GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容:${query}"}},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},hexoVersion:"4.2.1"}</script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#篇幅有限"><span class="toc-number">1.</span> <span class="toc-text">篇幅有限</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Http抓包"><span class="toc-number">2.</span> <span class="toc-text">Http抓包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#基本原理"><span class="toc-number">2.1.</span> <span class="toc-text">基本原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境搭建"><span class="toc-number">2.2.</span> <span class="toc-text">环境搭建</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Https和Socks5抓包"><span class="toc-number">3.</span> <span class="toc-text">Https和Socks5抓包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#开启https"><span class="toc-number">3.1.</span> <span class="toc-text">开启https</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开启socks5"><span class="toc-number">3.2.</span> <span class="toc-text">开启socks5</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Soul登录抓包"><span class="toc-number">3.2.1.</span> <span class="toc-text">Soul登录抓包</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hook"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">hook</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ssl-js"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">ssl.js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#开启hook"><span class="toc-number">3.2.1.3.</span> <span class="toc-text">开启hook</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#搜索证书"><span class="toc-number">3.2.1.4.</span> <span class="toc-text">搜索证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装证书"><span class="toc-number">3.2.1.5.</span> <span class="toc-text">安装证书</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#统一代码查询"><span class="toc-number">3.2.2.</span> <span class="toc-text">统一代码查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#国外app"><span class="toc-number">3.2.3.</span> <span class="toc-text">国外app</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hook抓包"><span class="toc-number">4.</span> <span class="toc-text">Hook抓包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#脱壳"><span class="toc-number">4.1.</span> <span class="toc-text">脱壳</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#批量hook"><span class="toc-number">4.2.</span> <span class="toc-text">批量hook</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Zentracer"><span class="toc-number">4.2.1.</span> <span class="toc-text">Zentracer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#案例"><span class="toc-number">4.3.</span> <span class="toc-text">案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#春水堂"><span class="toc-number">4.3.1.</span> <span class="toc-text">春水堂</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#爱奇艺"><span class="toc-number">4.3.2.</span> <span class="toc-text">爱奇艺</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hook-1"><span class="toc-number">4.3.2.1.</span> <span class="toc-text">hook</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ddms"><span class="toc-number">4.3.2.2.</span> <span class="toc-text">ddms</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#趣充"><span class="toc-number">4.3.3.</span> <span class="toc-text">趣充</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#滴答清单"><span class="toc-number">4.3.4.</span> <span class="toc-text">滴答清单</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#抓包总结"><span class="toc-number">5.</span> <span class="toc-text">抓包总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#kali-nethunter"><span class="toc-number">5.1.</span> <span class="toc-text">kali nethunter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#termux"><span class="toc-number">5.2.</span> <span class="toc-text">termux</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hook-2"><span class="toc-number">5.3.</span> <span class="toc-text">hook</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#抓包通杀"><span class="toc-number">6.</span> <span class="toc-text">抓包通杀</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#网络通讯协议分析"><span class="toc-number">7.</span> <span class="toc-text">网络通讯协议分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Java层"><span class="toc-number">7.1.</span> <span class="toc-text">Java层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#socket抓包"><span class="toc-number">7.1.1.</span> <span class="toc-text">socket抓包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ssl抓包"><span class="toc-number">7.1.2.</span> <span class="toc-text">ssl抓包</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jni层"><span class="toc-number">7.2.</span> <span class="toc-text">jni层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#socket抓包-1"><span class="toc-number">7.2.1.</span> <span class="toc-text">socket抓包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ssl抓包-1"><span class="toc-number">7.2.2.</span> <span class="toc-text">ssl抓包</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自编译openssl库抓包溯源"><span class="toc-number">7.3.</span> <span class="toc-text">自编译openssl库抓包溯源</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实战"><span class="toc-number">8.</span> <span class="toc-text">实战</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="http://onejane.gitee.io/picture/avatar.jpg"></div><div class="author-info__name text-center">J</div><div class="author-info__description text-center">逆向,爬虫</div><div class="follow-button"><a href="https://github.com/OneJane/" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">84</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">66</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">9</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友情链接</div><a class="author-info-links__name text-center" href="https://blog.csdn.net/welggy" target="_blank" rel="noopener">OneJane</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image:url(http://onejane.gitee.io/picture/kali.jpg)"><div id="page-header"> <span class="pull-left"><a id="site-name" href="/">万物皆可逆向</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i> <span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i> <span>搜索</span></a></span></div><div id="post-info"><div id="post-title">抓包环境与hook</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-02-18</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/">安卓逆向</a><div class="post-meta-wordcount"><span>字数总计:</span> <span class="word-count">16.6k</span><span class="post-meta__separator">|</span><span>阅读时长: 91 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><div id="vip-container"><h1 id="篇幅有限"><a href="#篇幅有限" class="headerlink" title="篇幅有限"></a>篇幅有限</h1><p>完整内容及源码关注公众号：ReverseCode，发送 <strong>冲</strong></p><p>1、<a href="http://aospxref.com/" target="_blank" rel="noopener">http://aospxref.com/</a><br>优点：更新速度快<br>缺点：历史版本较少</p><p>2、<a href="http://androidxref.com/" target="_blank" rel="noopener">http://androidxref.com/</a><br>优点：历史版本较多<br>缺点：更新速度慢</p><h1 id="Http抓包"><a href="#Http抓包" class="headerlink" title="Http抓包"></a>Http抓包</h1><h2 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h2><p><a href="https://tech.meituan.com/2017/03/17/shark-sdk.html" target="_blank" rel="noopener">美团点评移动网络优化实践</a>在http套ssl且加密内容成为https</p> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/网络七层模型.png" alt="image-20210219000224919" style="zoom:50%"><p>平时我们碰到的http和https都在应用层，socks在会话层，tcp和udp在传输层。ip在网络层。代理都是通过给wifi设置http代理的方式进行抓包，只是在应用层抓包，所以会被很轻易的检测到和绕过的。 很多应用会通过 <code>System.getProperty(“http.proxyHost”); System.getProperty(“http.proxyPort”);</code> 这两个API来查看当前系统是否挂了http代理，会很轻松的让你的抓包失效。 所以我们需要换一种方式来设置代理。就是设置vpn代理，vpn是属于网络层的，设置了vpn后，你的手机上ifconfig后会多一个接口，等于加了一个虚拟网卡，所有的流量都会从这走。应用层和传输层的请求都可以拿到，还不会被上面提及的两个api所检测。</p> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/七层网络.png" alt="七层网" style="zoom:80%"><p>图片视频处于应用层，http协议横跨应用层–表示层–会话层，socks、ssl属于会话层，IP属于网络层,端口属于传输层</p><p><strong>应用层Https抓包的根本原理</strong></p><p>HTTPS是包裹在SSL协议里的HTTP，APP-Charles客户端校验服务端，Charles-服务器是服务端校验客户端，400 Bad Request,No required SSL certificate was sent</p> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/抓包原理.png" alt="抓包原理" style="zoom:50%"><p>在开始 APP 分析时候我们提到使用 Charles 抓不到包，设置了 SSL 代理也没有用，当我们反编译分析脱壳后的dex找到构造请求的地方时，发现了真相，和 SSL 没有关系，是因 openConnection(Proxy.NO_PROXY)，使用<strong>vpn抓包</strong>后系统将多一个Interface，设置vpn代理，vpn是属于网络层的，设置了vpn后，你的手机上ifconfig后会多一个接口，等于加了一个虚拟网卡，所有的流量都会从这走。应用层和传输层的请求都可以拿到，还不会被上面提及的两个api所检测。</p><p><code>ip route show table 0|grep default</code> 手机路由表第一条降维打击网络层,任何api都必须经过路由解析http</p><p>不过<code>App</code>可以通过判断<code>java.net.NetworkInterface.getName()</code>是否等于“tun0”或“ppp0” 或者 <code>android.net.ConnectivityManager.getNetworkCapabilities</code>来判断是否存在VPN。Bypass也很简单，hook该api使其返回“rmnet_data1”，即可达到过vpn检测目的。</p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/%E6%A3%80%E6%B5%8BVPN.png" alt="检测VPN的API"></p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>tar zxf charles-proxy-4.6.1_amd64.tar.gz &amp;&amp; ./charles 通过<a href="https://www.charles.ren/" target="_blank" rel="noopener">注册码</a>注册或生成加权<a href="https://www.zzzmode.com/mytools/charles/" target="_blank" rel="noopener">jar包</a>破解，在Proxy中External Proxy Setting配置代理</p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/image-20220910100242242.png" alt="image-20220910100242242"></p><p>adb install 0714com.tunnelworkshop.postern_2018-10-07.apk</p><p><strong>网络设置</strong></p><p>主机连接无线网，虚拟机网络连接修改NAT设置桥接模式即可，不用勾选复制物理网络连接状态，保证手机192.168.0.100和虚拟机192.168.0.109和主机192.168.0.108互相ping通</p> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/虚拟网络设置.png" alt="虚拟网络设置" style="zoom:80%"><p><strong>配置Postern并启动VPN</strong></p><p>抓取所有应用层和传输层的包</p> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/设置postern.png" alt="Postern配置代理" style="zoom:80%"> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/Postern配置规则.png" alt="Postern配置规则" style="zoom:80%"><blockquote><p>如需安装https，需要开启SSL Proxying Settings-Enable SSL Proxying,设置规则*.*</p></blockquote><p><a href="https://blog.csdn.net/u014549283/article/details/81248886" target="_blank" rel="noopener"><strong>配置Burpsuite</strong></a></p><p>java -jar burp-loader-keygen.jar - Run - 复制License -EnterLicense Key - Manual Activition - Copy Request 到 Activation Request - 复制Activition Response到Paster response，在User options中设置Socks Proxy实现科学代理。</p> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/配置不限ip连接.png" alt="配置不限ip连接" style="zoom:80%"><p>配置Postern通过代理192.168.0.109:8080并重启VPN</p> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/burp抓包.png" alt="burp抓包设置过滤" style="zoom:80%"><p>openssl x509 -inform DER -in burpder1545.der -out burpder1545.pem 把der转化成pem，然后adb push到/sdcard/Download文件夹下，然后设置→安全性和位置信息→加密与凭据→从存储设备安装，选择pem证书，即可安装到用户用户信任区</p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/image-20220911162723623.png" alt="image-20220911162723623"></p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/75&e=1667231999&token=kIxbL07-8jAj8w1n4s9zv64FuZZNEATmlU_Vm6zDuteKBAJEiLcAmgoU_AfGpKecxIc=.jpeg" alt="img"></p><h1 id="Https和Socks5抓包"><a href="#Https和Socks5抓包" class="headerlink" title="Https和Socks5抓包"></a>Https和Socks5抓包</h1><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/image-20220910103407163.png" alt="image-20220910103407163"></p><p>抓住包出在明文状态的一切实际。种类：Http框架的hook，系统框架hook，中间人抓包。</p><blockquote><p>http+加密+认证+完整性保护=https是身披ssl的http</p></blockquote><p>HTTP未加密主要有这些不足</p><ul><li>通信使用明文(不加密),内容可能会被窃听</li><li>不验证通信方的身份,因此有可能遭遇伪装 DNS劫持-&gt;GFW翻墙</li><li>无法证明报文的完整性,所以有可能已遭篡改 运营商劫持-&gt;弹窗广告</li></ul><p><code>cat /etc/resolv.conf</code> 查看主机dns服务器</p><p><strong>通信的加密</strong><br>HTTP协议中没有加密机制,但可以通过和SSL( Secure Socket Layer,安全套接层)或TLS( Transport Layer Security,安全层传输协议)的组合使用,加密HTTP的通信内容。用SSL建立安全通信线路之后,就可以在这条线路上进行HTTP通信了。与SSL组合使用的HTTP被称为Https(HTTP Secure,超文本传输安全协议)或http over ssl。</p><p><strong>内容的加密</strong><br>由于HTTP协议中没有加密机制,那么就对HTTP协议传输的内容本身加密。即把HTTP报文里所含的内容进行加密处理在这种情况下,客户端需要对HTTP报文进行加密处理后再发送请求。诚然,为了做到有效的内容加密,前提是要求客户端和服务器同时具备加密和解密机制。主要应用在Web服务中。有一点必须引起注意,由于该方式不同于SSL或TLS将整个通信线路加密处理,所以内容仍有被篡改的风险。</p><p>设置-安全性和位置信息-加密与凭据-信任的凭据 查看安装在手机上的信任凭据</p> <img src="抓包环境与hook/https与http.png" alt="https与http" style="zoom:80%"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">objection -g com.android.settings explore</span><br><span class="line">memory list modules</span><br><span class="line">memory list exports libssl.so</span><br><span class="line">memory list exports libssl.so --json &quot;&#x2F;root&#x2F;libssl.txt&quot;  搜索rsa md5 aes sha非对称加解密</span><br></pre></td></tr></table></figure><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/%E5%85%AC%E7%A7%81%E9%92%A5%E5%8A%A0%E8%A7%A3%E5%AF%86.png" alt="HTTPS采用共享秘钥和公开秘钥混合加密"></p> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/t01c2d220dfd81d4d18.png" alt="img" style="zoom:67%"><h2 id="开启https"><a href="#开启https" class="headerlink" title="开启https"></a>开启https</h2><p>虚拟机启动charles，手机wifi设置代理192.168.0.109:8888，访问chls.pro/ssl安装证书</p><p>关闭代理，启动Postern代理192.168.0.109:8888并开启VPN</p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/chales%E5%BC%80%E5%90%AFssl%E6%8A%93%E5%8C%85.png" alt="chales开启ssl抓包"></p><p><code>adb install iqiyi_696.apk</code>启动爱奇艺抓包，虽然浏览器能抓到，但是依旧app抓不到，基于android 8.1+Magisk ,需要把个人证书放到系统根目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;data&#x2F;misc&#x2F;user&#x2F;0&#x2F;cacerts-added&#x2F;</span><br><span class="line">mount -o remount,rw &#x2F;</span><br><span class="line">chmod 777 *</span><br><span class="line">cp * &#x2F;etc&#x2F;security&#x2F;cacerts&#x2F;</span><br><span class="line">mount -o remount,ro &#x2F;</span><br></pre></td></tr></table></figure> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/证书放入根目录.png" alt="证书放入根目录" style="zoom:50%"><blockquote><p>Android将证书放入根目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;data&#x2F;misc&#x2F;user&#x2F;0&#x2F;cacerts-added&#x2F;</span><br><span class="line">mount -o rw,remount &#x2F;system</span><br><span class="line">chmod 777 *</span><br><span class="line">cp * &#x2F;etc&#x2F;security&#x2F;cacerts&#x2F;</span><br><span class="line">mount -o ro,remount &#x2F;system</span><br></pre></td></tr></table></figure></blockquote><h2 id="开启socks5"><a href="#开启socks5" class="headerlink" title="开启socks5"></a>开启socks5</h2><p>socket本质：收发包的接口，一条跑着RAW DATA的通道，纯binary，wireshark抓包本质上不是中间人抓包，网卡流量的dump转储下来。应用领域SSL+HTTP,SMPT/POP/IMAP,protobuf</p><p><a href="https://www.cnblogs.com/fundebugp/differences-of-tcp-and-udp.html" target="_blank" rel="noopener">一文搞懂TCP与UDP的区别</a></p><p><a href="https://www.52pojie.cn/forum.php?mod=viewthread&tid=1179834" target="_blank" rel="noopener"><strong>通过抓包和一点点经验分析携程的协议</strong></a></p><p><a href="https://bbs.pediy.com/thread-264283.html" target="_blank" rel="noopener">安卓应用层抓包通杀脚本</a></p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/image-20220912105555810.png" alt="image-20220912105555810"></p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/722120_5XMU3SB58Y5QA2K.png" alt="img"></p><p><a href="https://www.jianshu.com/p/2476c8858daf" target="_blank" rel="noopener">逆向XposedHook模块分析Hook检测过Vpn抓包原理！</a></p><p><a href="https://mp.weixin.qq.com/s/UixExZkPWHJAT3jAD2sJJg" target="_blank" rel="noopener">某抢票app逆向续篇之干掉vpn抓包检测</a></p><p>若依旧抓不全包，则使用Postern开启socks5抓包并配置规则开启VPN，charles配置socks抓包,本质在tcp层抓包。</p> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/Postern配置socks5.png" alt="Postern配置socks5" style="zoom:80%"> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/charles配置socks5.png" alt="charles配置socks5" style="zoom:80%"> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/socks5抓包.png" alt="socks5抓包" style="zoom:80%"><h3 id="Soul登录抓包"><a href="#Soul登录抓包" class="headerlink" title="Soul登录抓包"></a>Soul登录抓包</h3><p><code>adb install soul_channel_soul.apk</code> soul在登录时报错<code>400 No required SSL certificate was sent</code>，缺少证书，需要在charles中安装客户端证书获取服务器信任。</p> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/soul抓包报错.png" alt="soul抓包报错" style="zoom:80%"><h4 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h4><p>frida两种模式：attach在app启动之后进行hook， spawn未启动时就通过包名启动apk进行hook</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">android hooking search classes ssl</span><br><span class="line">android hooking watch class javax.net.ssl.SSLSession  文本中拼上前缀</span><br><span class="line">objection -g x.x.x explore -c a.txt</span><br></pre></td></tr></table></figure><p>完整实现</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">function hook_socket()&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        console.log(&quot;hook_socket;&quot;)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        Java.use(&quot;java.net.SocketOutputStream&quot;).write.overload(&#39;[B&#39;, &#39;int&#39;, &#39;int&#39;).implementation &#x3D; function(bytearry,int1,int2)&#123;</span><br><span class="line">            var result &#x3D; this.write(bytearry,int1,int2);</span><br><span class="line">            console.log(&quot;HTTP write result,bytearry,int1,int2&#x3D;&gt;&quot;,result,bytearry,int1,int2)</span><br><span class="line">            var ByteString &#x3D; Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);</span><br><span class="line">            console.log(&quot;bytearray contents&#x3D;&gt;&quot;, ByteString.of(bytearry).hex())</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        Java.use(&quot;java.net.SocketInputStream&quot;).read.overload(&#39;[B&#39;, &#39;int&#39;, &#39;int&#39;).implementation &#x3D; function(bytearry,int1,int2)&#123;</span><br><span class="line">            var result &#x3D; this.read(bytearry,int1,int2);</span><br><span class="line">            console.log(&quot;HTTP read result,bytearry,int1,int2&#x3D;&gt;&quot;,result,bytearry,int1,int2)</span><br><span class="line">            var ByteString &#x3D; Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);</span><br><span class="line">            console.log(&quot;bytearray contents&#x3D;&gt;&quot;, ByteString.of(bytearry).hex())</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function hook_SSLsocketandroid8()&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        console.log(&quot;hook_SSLsocket&quot;)</span><br><span class="line">        </span><br><span class="line">        Java.use(&quot;com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLOutputStream&quot;).write.overload(&#39;[B&#39;, &#39;int&#39;, &#39;int&#39;).implementation &#x3D; function(bytearry,int1,int2)&#123;</span><br><span class="line">            var result &#x3D; this.write(bytearry,int1,int2);</span><br><span class="line">            console.log(&quot;HTTPS write result,bytearry,int1,int2&#x3D;&gt;&quot;,result,bytearry,int1,int2)</span><br><span class="line">            var ByteString &#x3D; Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);</span><br><span class="line">            console.log(&quot;bytearray contents&#x3D;&gt;&quot;, ByteString.of(bytearry).hex())</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        Java.use(&quot;com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLInputStream&quot;).read.overload(&#39;[B&#39;, &#39;int&#39;, &#39;int&#39;).implementation &#x3D; function(bytearry,int1,int2)&#123;</span><br><span class="line">            var result &#x3D; this.read(bytearry,int1,int2);</span><br><span class="line">            console.log(&quot;HTTPS read result,bytearry,int1,int2&#x3D;&gt;&quot;,result,bytearry,int1,int2)</span><br><span class="line">            var ByteString &#x3D; Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);</span><br><span class="line">            console.log(&quot;bytearray contents&#x3D;&gt;&quot;, ByteString.of(bytearry).hex())</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function hook_SSLsocket2android10()&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        console.log(&quot; hook_SSLsocket2&quot;)</span><br><span class="line">        var ByteString &#x3D; Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);</span><br><span class="line">        Java.use(&quot;com.android.org.conscrypt.NativeCrypto&quot;).SSL_write.implementation &#x3D; function(long,NS,fd,NC,bytearray,int1,int2,int3)&#123;</span><br><span class="line">            var result &#x3D; this .SSL_write(long,NS,fd,NC,bytearray,int1,int2,int3);</span><br><span class="line">            console.log(&quot;SSL_write(long,NS,fd,NC,bytearray,int1,int2,int3),result&#x3D;&gt;&quot;,long,NS,fd,NC,bytearray,int1,int2,int3,result)</span><br><span class="line">            console.log(ByteString.of(bytearray).hex());</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">        Java.use(&quot;com.android.org.conscrypt.NativeCrypto&quot;).SSL_read.implementation &#x3D; function(long,NS,fd,NC,bytearray,int1,int2,int3)&#123;</span><br><span class="line">            var result &#x3D; this .SSL_read(long,NS,fd,NC,bytearray,int1,int2,int3);</span><br><span class="line">            console.log(&quot;SSL_read(long,NS,fd,NC,bytearray,int1,int2,int3),result&#x3D;&gt;&quot;,long,NS,fd,NC,bytearray,int1,int2,int3,result)</span><br><span class="line">            console.log(ByteString.of(bytearray).hex());</span><br><span class="line">            return result;</span><br><span class="line">        &#125;      </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function main()&#123;</span><br><span class="line">    console.log(&quot;Main&quot;)</span><br><span class="line">    hook_socket();</span><br><span class="line">    hook_SSLsocketandroid8();</span><br><span class="line">    &#x2F;&#x2F;hook_SSLsocket2android10();</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure><h4 id="ssl-js"><a href="#ssl-js" class="headerlink" title="ssl.js"></a>ssl.js</h4><p>过自签名证书</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function hook_KeyStore_load() &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        var StringClass &#x3D; Java.use(&quot;java.lang.String&quot;);</span><br><span class="line">        var KeyStore &#x3D; Java.use(&quot;java.security.KeyStore&quot;);</span><br><span class="line">        KeyStore.load.overload(&#39;java.security.KeyStore$LoadStoreParameter&#39;).implementation &#x3D; function (arg0) &#123;</span><br><span class="line">            console.log(Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new()));</span><br><span class="line"></span><br><span class="line">            console.log(&quot;KeyStore.load1:&quot;, arg0);</span><br><span class="line">            this.load(arg0);</span><br><span class="line">        &#125;;</span><br><span class="line">        KeyStore.load.overload(&#39;java.io.InputStream&#39;, &#39;[C&#39;).implementation &#x3D; function (arg0, arg1) &#123;</span><br><span class="line">            console.log(Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new()));</span><br><span class="line"></span><br><span class="line">            console.log(&quot;KeyStore.load2:&quot;, arg0, arg1 ? StringClass.$new(arg1) : null);</span><br><span class="line">            this.load(arg0, arg1);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        console.log(&quot;hook_KeyStore_load...&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(hook_KeyStore_load)</span><br></pre></td></tr></table></figure><h4 id="开启hook"><a href="#开启hook" class="headerlink" title="开启hook"></a>开启hook</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;data&#x2F;local&#x2F;tmp&#x2F;fs128arm64  开启frida-server</span><br><span class="line">pyenv local 3.8.0</span><br><span class="line">frida --version   版本一致为12.8.0</span><br><span class="line">top 查看soul的包名为cn.soulapp.android</span><br><span class="line">frida -U -f cn.soulapp.android -l ssl.js  通过attach进行hook公钥加解密的框架层api，打印密码用于解开证书用</span><br><span class="line">%resume  重新启动</span><br><span class="line">frida -U -f cn.soulapp.android -l ssl.js  --no-pause  通过spawn进行hook，证书公钥发送给服务器，从服务器获取session用私钥进行解密的api进行hook，属于自吐，查看terminal中的密码 &#125;%2R+\OSsjpP!w%X</span><br></pre></td></tr></table></figure><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/%E6%9F%A5%E7%9C%8BKeyStore.png" alt="查看KeyStore"></p><h4 id="搜索证书"><a href="#搜索证书" class="headerlink" title="搜索证书"></a>搜索证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">7z x soul_channel_soul.apk</span><br><span class="line">tree -NCfhl|grep -i p12 找到证书位置tree -NCfhl|grep -i bks</span><br><span class="line">或者objection -g cn.soulapp.android explore  如果报错查看frida的客户端和服务端版本是否匹配</span><br><span class="line">android hooking watch class_method java.io.File$init --dump-args 如果找不到文件</span><br><span class="line">exit并干掉app后</span><br><span class="line">objection -g cn.soulapp.android explore --start-command &quot;android hooking watch class_method java.io.File$init --dump-args&quot;</span><br><span class="line">du -h assets&#x2F;client.p12</span><br><span class="line">file assets&#x2F;client.p12</span><br><span class="line">thunar .  在windows上找到后双击导入私钥需要密码即刚才hook到的&#125;%2R+\OSsjpP!w%X  该证书的内容即可以全部显示</span><br></pre></td></tr></table></figure><h4 id="安装证书"><a href="#安装证书" class="headerlink" title="安装证书"></a>安装证书</h4><p>导入charles - Proxy- SSL Proxying Settings 添加客户端证书</p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%89%E5%85%A8%E5%AF%86%E7%A0%81admin.png" alt="自定义安全密码admin"></p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/%E5%AE%89%E8%A3%85%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%81%E4%B9%A6.png" alt="安装客户端证书"></p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/%E8%BE%93%E5%85%A5KeyStore.png" alt="输入KeyStore"></p><p>charls将对任意服务器发送该客户端证书 意味着用app访问所有的服务器 测试登录</p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/soul%E6%8A%93%E5%8C%85%E6%88%90%E5%8A%9F.png" alt="soul抓包成功"></p><h3 id="统一代码查询"><a href="#统一代码查询" class="headerlink" title="统一代码查询"></a>统一代码查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pm -l |grep -i ncs  查看包名</span><br><span class="line">frida -U -f com.ninemax.ncsearchnew -l hook_keystore.js --no-pause   证书下载到&#x2F;sdcard&#x2F;Download</span><br><span class="line">objection -g com.ninemax.ncsearchnew explore -s &quot;android sslpinning disable&quot;</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;WooyunDota&#x2F;DroidSSLUnpinning.git </span><br><span class="line">frida -U -f com.ninemax.ncsearchnew -l ObjectionUnpinningPlus&#x2F;hooks.js --no-pause</span><br></pre></td></tr></table></figure><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/image-20220912171345204.png" alt="image-20220912171345204"></p><h3 id="国外app"><a href="#国外app" class="headerlink" title="国外app"></a>国外app</h3><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/%E4%BB%A3%E7%90%86%E8%AE%BE%E7%BD%AE.png" alt="proxy-External proxy servers设置代理"></p><p>访问ip111.cn通过测试</p><h1 id="Hook抓包"><a href="#Hook抓包" class="headerlink" title="Hook抓包"></a>Hook抓包</h1><ul><li><p>缺点：不如抓包软件全面</p></li><li><p>优点：无视证书、基于HOOK直接得到参数、打调用栈得到参数的构成和来源</p></li></ul><blockquote><p>一般HTTPS：大部分只采用客户端校验服务器 iqiyi<br>双向绑定：很少会有服务器校验客户端 soul<br>SSL Cert Pinning：更少：趣充</p></blockquote><p>adb install movetv.apk 使用Postern和Charles开启socks5即可完整抓到注册登录的请求，部分https无法抓到</p><p>安装证书chls.pro/ssl并把把个人证书放到系统根目录，启动ssl抓包，关闭客户端证书的soulapp.cn,否则会误认为请求来自于soul，即可抓到https包。</p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/开启ssl.png" alt="开启ssl" style="zoom:80%"><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/%E5%85%B3%E9%97%ADsoul%E8%AF%81%E4%B9%A6.png" alt="关闭soul证书"></p><h2 id="脱壳"><a href="#脱壳" class="headerlink" title="脱壳"></a>脱壳</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;data&#x2F;local&#x2F;tmp&#x2F;fs128arm64 启动frida-server</span><br><span class="line">objection -g com.cz.babySister explore -P ~&#x2F;.objection&#x2F;plugins</span><br><span class="line">plugin dexdump dump</span><br></pre></td></tr></table></figure> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/movetv脱壳.png" alt="movetv脱壳" style="zoom:67%"><h2 id="批量hook"><a href="#批量hook" class="headerlink" title="批量hook"></a>批量hook</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">android hooking list classes    列出所有类</span><br><span class="line">android hooking list activities  查看所有activity</span><br><span class="line">cat ~&#x2F;.objection&#x2F;objection.log|grep -i httpurl </span><br><span class="line">cat objection.log|grep -i http  拿到所有关于http相关类，并将前面都加入命令android hooking wathc class存入hooklist.txt</span><br><span class="line">objection -g com.android.settings explore -c &quot;hooklist.txt&quot;  加载命令文件即可批量hook</span><br><span class="line">dumpsys activity top|grep baby  在shell中拿到包当前所在activity</span><br><span class="line">plugin wallbreaker objectsearch com.cz.babySister.activity.LoginActivity --fullname  搜索类信息地址</span><br><span class="line">android heap search instances com.cz.babySister.activity.LoginActivity  查看activity属性信息</span><br></pre></td></tr></table></figure><h3 id="Zentracer"><a href="#Zentracer" class="headerlink" title="Zentracer"></a>Zentracer</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;data&#x2F;local&#x2F;tmp&#x2F;fs1428arm64 开始frida-server</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;hluwa&#x2F;ZenTracer</span><br><span class="line">cd ZenTracer &amp;&amp; pyenv local 3.8.5</span><br><span class="line">python -m pip install --upgrade pip</span><br><span class="line">pip install PyQt5</span><br><span class="line">python ZenTracer.py  开始hook设置Match RegEx并开启Start</span><br></pre></td></tr></table></figure><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/Zentracer%E5%BC%80%E5%90%AFhook.png" alt="Zentracer开启hook"></p> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/登录注册.png" alt="登录注册" style="zoom:80%"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking watch class_method java.net.HttpURLConnection.getFollowRedirects --dump-args --dump-backtrace --dump-return  hook方法打印调用栈登录定位HTTPURLConnection.getFollowRedirects在com.cz.babySister.c.a.a调用</span><br></pre></td></tr></table></figure><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/%E5%AE%9A%E4%BD%8D%E5%87%BD%E6%95%B0%E6%94%B6%E5%8F%91%E5%8C%85%E7%B1%BB.png" alt="定位函数收发包类"></p><h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="春水堂"><a href="#春水堂" class="headerlink" title="春水堂"></a>春水堂</h3><p>adb install 春水堂_2.1.0.0强混淆.apk</p><ol><li>通过<code>objection -g org.sfjboldyvukzzlpp explore</code>内存漫游后访问视频，<code>cat objection.log|grep -i okhttp3</code>发现根本找不到相关http类信息</li><li>通过<code>apktool d 春水堂_2.1.0.0强混淆.apk</code>解包后搜索ok3信息<code>cd 春水堂_2.1.0.0强混淆 &amp;&amp; grep -ril &quot;okhttp3&quot; *</code>找到相关smali</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;data&#x2F;local&#x2F;tmp&#x2F;fs128arm64  启动 frida</span><br><span class="line">pyenv local 3.8.0</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;siyujie&#x2F;OkHttpLogger-Frida.git</span><br><span class="line">cd OkHttpLogger-Frida &amp;&amp; adb push okhttpfind.dex &#x2F;data&#x2F;local&#x2F;tmp  将dex文件放入手机并chmod 777</span><br><span class="line">frida -U -f org.sfjboldyvukzzlpp -l okhttp_poker.js --no-pause</span><br><span class="line">find() 查看是否使用okhttp并查看混淆结果</span><br></pre></td></tr></table></figure> <img src="抓包环境与hook/查看okhttp混淆结果.png" alt="查看okhttp混淆结果" style="zoom:80%"><p>将Find Result下的内容复制到okhttp_poker.js开头，替换原有混淆类名</p> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/替换混淆结果.png" alt="替换混淆结果" style="zoom:80%"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f org.sfjboldyvukzzlpp -l okhttp_poker.js --no-pause  退出后重新frida调用</span><br><span class="line">hold() 通杀所有okhttp混淆参数结果</span><br></pre></td></tr></table></figure> <img src="抓包环境与hook/通杀okhttp.png" alt="通杀okhttp" style="zoom:80%"><h3 id="爱奇艺"><a href="#爱奇艺" class="headerlink" title="爱奇艺"></a>爱奇艺</h3><p>charles证书放到根目录，可以通过magisk的move Certificates安装重启。客户端校验服务器。</p><h4 id="hook-1"><a href="#hook-1" class="headerlink" title="hook"></a>hook</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;BigFaceCat2017&#x2F;frida_ssl_logger.git  框架层的conscrypt本质上是走的native层的ssl抓包log</span><br><span class="line">adb install iqiyi_696.apk</span><br><span class="line">electron-ssr &amp;&amp; proxychains pip install hexdump   安装hexdump</span><br><span class="line">python ssl_logger.py -U -f com.qiyi.video &gt;&gt; iqiyi.txt  启动iqiyi并开启hook所有ssl信息保存到文件</span><br></pre></td></tr></table></figure><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/iqiyi%E6%8A%93%E5%8C%85.jpg" alt="ssl抓包iqiyi"></p><h4 id="ddms"><a href="#ddms" class="headerlink" title="ddms"></a>ddms</h4><p>xposed安装XAppDebug模块，开启debug，选中春水堂APP开启调试</p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/XAppDebug%E8%B0%83%E8%AF%95.png" alt="XAppDebug调试"></p><p>~/Android/Sdk/tools/monitor 启动ddms</p> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/选中进程进行方法剖析.png" alt="选中进程进行方法剖析" style="zoom:80%"><p>使用Trace based profiling，登录后停止方法剖析，搜索HttpURLConnection</p><h3 id="趣充"><a href="#趣充" class="headerlink" title="趣充"></a>趣充</h3><p>adb install -r -t quchong.apk</p><p>./charles 启动charles抓包注册获取验证码，设置了no proxy防抓包</p><p> <img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/image-20210707100228016.png" alt="image-20210707100228016"></p><p>服务器校验客户端证书 ： 400 No required SSL certificate was sent</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function replaceKill()&#123;</span><br><span class="line">	&#x2F;&#x2F; 替换掉崩掉时的内容，打印崩掉时的参数和pid，不执行崩掉的逻辑，让程序不要崩</span><br><span class="line">    console.log(&quot;Preventing from killing ...&quot;)</span><br><span class="line">    var kill_addr &#x3D; Module.findExportByName(&quot;libc.so&quot;, &quot;kill&quot;);</span><br><span class="line">    &#x2F;&#x2F; var kill &#x3D; new NativeFunction(kill_addr,&quot;int&quot;,[&#39;int&#39;,&#39;int&#39;]);</span><br><span class="line">    Interceptor.replace(kill_addr,new NativeCallback(function(arg0,arg1)&#123;</span><br><span class="line">        console.log(&quot;arg0&#x3D;&gt; &quot;,arg0)</span><br><span class="line">        console.log(&quot;arg1&#x3D;&gt; &quot;,arg1)</span><br><span class="line"></span><br><span class="line">    &#125;,&quot;int&quot;,[&#39;int&#39;,&#39;int&#39;]))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function main()&#123;</span><br><span class="line">    replaceKill()</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><p>frida -UF -l quchong.js 抓包获取注册验证码</p><p>frida -UF -l hookSocket.js -o quchong.txt</p><p>ps -ef|grep -i quchong 获取包名</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">objection -g com.whwy.equchong explore</span><br><span class="line">android hooking search classes okhttp</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;siyujie&#x2F;OkHttpLogger-Frida.git</span><br><span class="line">adb push okhttpfind.dex &#x2F;data&#x2F;local&#x2F;tmp  &amp;&amp; chmod 777 okhttpfind.dex</span><br><span class="line">frida -U -l okhttp_poker.js -f com.whwy.equchong --no-pause</span><br><span class="line">find()  查看是否被混淆后的okhttp的参数拷贝到okhttp_poker.js上面定义参数</span><br><span class="line">frida -UF -l okhttp_poker.js -o quchong.txt   attach模式操作发送验证码前启动hook</span><br><span class="line">frida -U -l okhttp_poker.js -f com.whwy.equchong --no-pause -o qichong.txt  spawn模式</span><br><span class="line">hold()   发送验证码抓包</span><br></pre></td></tr></table></figure><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/image-20210707105723540.png" alt="image-20210707105723540"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;过客户端校验服务器</span><br><span class="line">function hook_KeyStore_load() &#123;</span><br><span class="line">	&#x2F;&#x2F; hook证书 自吐证书密码和内容保存在sdcard中</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        var ByteString &#x3D; Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);</span><br><span class="line">        var myArray&#x3D;new Array(1024);</span><br><span class="line">        var i &#x3D; 0</span><br><span class="line">        for (i &#x3D; 0; i  myArray.length; i++) &#123;</span><br><span class="line">            myArray[i]&#x3D; 0x0;</span><br><span class="line">         &#125;</span><br><span class="line">        var buffer &#x3D; Java.array(&#39;byte&#39;,myArray);</span><br><span class="line">        </span><br><span class="line">        var StringClass &#x3D; Java.use(&quot;java.lang.String&quot;);</span><br><span class="line">        var KeyStore &#x3D; Java.use(&quot;java.security.KeyStore&quot;);</span><br><span class="line">        KeyStore.load.overload(&#39;java.security.KeyStore$LoadStoreParameter&#39;).implementation &#x3D; function (arg0) &#123;</span><br><span class="line">            console.log(Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new()));</span><br><span class="line"></span><br><span class="line">            console.log(&quot;KeyStore.load1:&quot;, arg0);</span><br><span class="line">            this.load(arg0);</span><br><span class="line">        &#125;;</span><br><span class="line">        KeyStore.load.overload(&#39;java.io.InputStream&#39;, &#39;[C&#39;).implementation &#x3D; function (arg0, arg1) &#123;</span><br><span class="line">            console.log(Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new()));</span><br><span class="line"></span><br><span class="line">            console.log(&quot;KeyStore.load2:&quot;, arg0, arg1 ? StringClass.$new(arg1) : null);</span><br><span class="line">            if (arg0)&#123;</span><br><span class="line">                var file &#x3D;  Java.use(&quot;java.io.File&quot;).$new(&quot;&#x2F;sdcard&#x2F;Download&quot;+ String(arg0)+&quot;.p12&quot;);</span><br><span class="line">                var out &#x3D; Java.use(&quot;java.io.FileOutputStream&quot;).$new(file);</span><br><span class="line">                var r;</span><br><span class="line">                while( (r &#x3D; arg0.read(buffer))  0)&#123;</span><br><span class="line">                    out.write(buffer,0,r)</span><br><span class="line">                &#125;</span><br><span class="line">                console.log(&quot;save success!&quot;)</span><br><span class="line">                out.close()</span><br><span class="line">            &#125;</span><br><span class="line">            this.load(arg0, arg1);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        console.log(hook_KeyStore_load...);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;过证书绑定 ssl pinning 对证书在代码中进行额外校验，</span><br><span class="line">function hook_ssl() &#123;</span><br><span class="line">    &#x2F;&#x2F; hook ssl 调用栈</span><br><span class="line">    Java.perform(function() &#123;</span><br><span class="line">        var ClassName &#x3D; &quot;com.android.org.conscrypt.Platform&quot;;</span><br><span class="line">        var Platform &#x3D; Java.use(ClassName);</span><br><span class="line">        var targetMethod &#x3D; &quot;checkServerTrusted&quot;;</span><br><span class="line">        var len &#x3D; Platform[targetMethod].overloads.length;</span><br><span class="line">        console.log(len);</span><br><span class="line">        for(var i &#x3D; 0; i  len; ++i) &#123;</span><br><span class="line">            Platform[targetMethod].overloads[i].implementation &#x3D; function () &#123;</span><br><span class="line">                console.log(&quot;class:&quot;, ClassName, &quot;target:&quot;, targetMethod, &quot;i:&quot;, i, arguments);</span><br><span class="line">                printStack(ClassName + . + targetMethod);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>frida -U -f com.whwy.equchong -l hook_keystore.js –no-pause -o quchong.txt 证书位置和密钥在KeyStore.load2后的/sdcard/Download</p><p>将p12证书拷贝出来，下载<a href="https://github.com/kaikramer/keystore-explorer/releases/download/v5.4.4/kse_5.4.4_all.deb" target="_blank" rel="noopener">kse_5.4.4_all.deb</a>，dpkg -i kse_2.4.4_all.deb，启动keystore explore打开p12证书，输入密码即可查看证书内容</p><p>右键-export-export key pair-输入密码 保存为p12，设置密码123456</p><p>charles-SSL Proxying Settings-Client Certificate-Import P12-导入导出的p12证书，密码为123456，Host Port配*表示所有发出去的包都用这个证书</p><p>启动Postern，配置charles抓包，重新注册获取验证码，依旧拿不到结果是，查看socket后的端口9443，在charles中配置9443端口，即可拿到完整加密请求结果</p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/image-20210707123859186.png" alt="image-20210707123859186"></p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/image-20220912112637488.png" alt="image-20220912112637488"></p><h3 id="滴答清单"><a href="#滴答清单" class="headerlink" title="滴答清单"></a>滴答清单</h3><p>启动charles抓包，发送验证码，查看OverView</p><p>证书绑定校验失败：Client closed the connection before a request was made.Possibly the SSL certificate was rejected.You may need to configure your browser or application to trust the Charles Root Certificate.See SSL Proxyinf in the Help menu.</p><p><a href="https://zhuanlan.zhihu.com/p/58308036" target="_blank" rel="noopener">Android SSL证书设置和锁定(SSL/TLS Pinning)</a>查看安卓设置-加密与凭据-信任的凭据</p><p>frida -U -f cn.ticktick.task -l quchong.js –no-pause 执行hook_ssl() 失败</p><p>objection -g cn.ticktick.task explore -s “android sslpinning disable” 失败</p><p>git clone <a href="https://github.com/WooyunDota/DroidSSLUnpinning.git" target="_blank" rel="noopener">https://github.com/WooyunDota/DroidSSLUnpinning.git</a></p><p>frida -U -f cn.ticktick.task -l hooks.js –no-pause 失败</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">objection -g cn.ticktick.task explore -s &quot;android hooking watch class_method java.io.File.$init --dump-args --dump-backtrace --dump-return&quot;  打开证书文件就初始化这个文件，hook该类,发送验证码</span><br><span class="line">plugin wallbreaker classdump z1.g</span><br><span class="line">plugin wallbreaker objectsearch z1.g </span><br><span class="line">plugin wallbreaker objectdump --fullname 0x24e6</span><br></pre></td></tr></table></figure><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/image-20220912194107785.png" alt="image-20220912194107785"></p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/image-20210707130643793.png" alt="image-20210707130643793"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd OkHttpLogger-Frida &amp;&amp; frida -U -f cn.ticktick.task -l okhttp_poker.js </span><br><span class="line">%resume</span><br><span class="line">find()  失败则不是ok3混淆,那么就是ok1</span><br></pre></td></tr></table></figure><p><a href="https://square.github.io/okhttp/4.x/okhttp/okhttp3/-certificate-pinner/" target="_blank" rel="noopener">https://square.github.io/okhttp/4.x/okhttp/okhttp3/-certificate-pinner/</a></p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/image-20210707132638475.png" alt="image-20210707132638475"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking list class_methods z1.g  其中有z1.g.a,在CertificatePinner中被混淆的</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function killCertificatePinner()&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        console.log(Beginning killCertificatePinner !...)</span><br><span class="line">        Java.use(z1.g).a.implementation &#x3D; function(str,list)&#123;</span><br><span class="line">            console.log(called z1.g.a ~)</span><br><span class="line">            return ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>frida -U -f cn.ticktick.task -l quchong.js –no-pause 发送注册短信过掉z1.g.a的ok1中的证书</p><h1 id="抓包总结"><a href="#抓包总结" class="headerlink" title="抓包总结"></a>抓包总结</h1><h2 id="kali-nethunter"><a href="#kali-nethunter" class="headerlink" title="kali nethunter"></a><a href="https://bt4g.org/search/nethunter-2020-3" target="_blank" rel="noopener">kali nethunter</a></h2><p>apt install jnettop nethogs htop 查看请求ip端口</p><blockquote><p>优点：直观、所见即所得<br>缺点：没有内容，粒度太粗，简单看下</p></blockquote><p>wireshark 使用NetHunter-Kex Manager-SETUP LOCAL SERVER 使用USER为root Start SERVER，启动NetHunter Kex的VNC连接界面kali，VNC Viewer也可以通过ip连接,图形化抓包</p><blockquote><p>优点：可以转储内容scp <a href="mailto:&#x72;&#x6f;&#x6f;&#x74;&#x40;&#x31;&#57;&#50;&#x2e;&#49;&#56;&#54;&#46;&#48;&#x2e;&#x32;&#x4c;">&#x72;&#x6f;&#x6f;&#x74;&#x40;&#x31;&#57;&#50;&#x2e;&#49;&#56;&#54;&#46;&#48;&#x2e;&#x32;&#x4c;</a>/root/a.pcap ./，存下来稍后分析<br>缺点：只能看明文，不能解加密协议</p></blockquote><p><a href="https://www.anquanke.com/post/id/205455" target="_blank" rel="noopener">ARM设备武器化指南·破·Kali.Nethunter.2020a.上手实操</a></p><h2 id="termux"><a href="#termux" class="headerlink" title="termux"></a>termux</h2><p>adb install termux &amp;&amp; pkg update &amp;&amp; pkg install tcpdump &amp;&amp; ln -s /data/data/com.termux/files/usr/bin/tcpdump /system/bin 并remount</p><blockquote><p>安卓7remount: mount -o rw,remount /system</p><p>安卓8remount:mount -o remount,rw /system</p></blockquote><p>mount -o remount.rw / 重新挂载，使用tcpdump开启抓包</p><p>优点：不需要刷<code>Nethunter</code><br>缺点：没有界面</p><h2 id="hook-2"><a href="#hook-2" class="headerlink" title="hook"></a>hook</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">objection -g com.onejane.httpsocket explore -P ~&#x2F;.objection&#x2F;plugins </span><br><span class="line">android hooking search classes socket  将打印的类存入hookSocket.txt</span><br><span class="line">sed -i -e &#39;s&#x2F;^&#x2F;android hooking watch class_method &#x2F;&#39;  hookSocket.txt  在以上的类前加入android hooking watch class_method</span><br><span class="line">sed -i s&#x2F;$&#x2F;&quot;.\$init&quot;&#x2F;  hookSocket.txt  在以上的类后加入.$init</span><br><span class="line">plugin wallbreaker objectsearch java.net.Socket  内存查找类 </span><br><span class="line">plugin wallbreaker objectdump --fullname 0x21f2  打印内存中的类</span><br><span class="line">plugin wallbreaker classdump --fullname java.net.InetAddress</span><br></pre></td></tr></table></figure><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/%E5%86%85%E5%AD%98%E6%BC%AB%E6%B8%B8.png" alt="内存漫游"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objection -g com.onejane.httpsocket explore -c ~&#x2F;root&#x2F;Desktop&#x2F;hookSocket.txt  -P ~&#x2F;.objection&#x2F;plugins  批量hook，如有报错就删除报错类</span><br></pre></td></tr></table></figure><p>分别使用http和https运行HttpSocket项目，通过frida批量hook以上整理的hookSocket.txt中的类</p><blockquote><p>HTTP<br>java.net.InetSocketAddress.InetSocketAddress(<a href="http://www.baidu.com/180.101.49.12" target="_blank" rel="noopener">www.baidu.com/180.101.49.12</a>, 80)<br>java.net.InetSocketAddress$InetSocketAddressHolder.InetSocketAddress$InetSocketAddressHolder((none), <a href="http://www.baidu.com/180.101.49.12" target="_blank" rel="noopener">www.baidu.com/180.101.49.12</a>, 80, (none))<br>java.net.InetSocketAddress.InetSocketAddress(/192.168.0.2, 43066)<br>java.net.InetSocketAddress$InetSocketAddressHolder.InetSocketAddress$InetSocketAddressHolder((none), /192.168.0.2, 43066, (none))<br>java.net.SocketInputStream.SocketInputStream(Socket[addr=<a href="http://www.baidu.com/180.101.49.12,port=80,localport=43066]" target="_blank" rel="noopener">www.baidu.com/180.101.49.12,port=80,localport=43066]</a>)<br>java.net.SocketOutputStream.SocketOutputStream(Socket[addr=<a href="http://www.baidu.com/180.101.49.12,port=80,localport=43066]" target="_blank" rel="noopener">www.baidu.com/180.101.49.12,port=80,localport=43066]</a>)<br>HTTPS<br>java.net.InetSocketAddress.InetSocketAddress(<a href="http://www.baidu.com/180.101.49.12" target="_blank" rel="noopener">www.baidu.com/180.101.49.12</a>, 443)<br>java.net.Socket$2.Socket$2(Socket[address=<a href="http://www.baidu.com/180.101.49.12,port=443,localPort=44405]" target="_blank" rel="noopener">www.baidu.com/180.101.49.12,port=443,localPort=44405]</a>)<br>java.net.SocketInputStream.SocketInputStream(Socket[addr=<a href="http://www.baidu.com/180.101.49.12,port=443,localport=44405]" target="_blank" rel="noopener">www.baidu.com/180.101.49.12,port=443,localport=44405]</a>)<br>java.net.SocketOutputStream.SocketOutputStream(Socket[addr=<a href="http://www.baidu.com/180.101.49.12,port=443,localport=44405]" target="_blank" rel="noopener">www.baidu.com/180.101.49.12,port=443,localport=44405]</a>)<br>com.android.org.conscrypt.ConscryptFileDescriptorSocket.ConscryptFileDescriptorSocket(Socket[address=<a href="http://www.baidu.com/180.101.49.12,port=443,localPort=44405]" target="_blank" rel="noopener">www.baidu.com/180.101.49.12,port=443,localPort=44405]</a>, <a href="http://www.baidu.com/" target="_blank" rel="noopener">www.baidu.com</a>, 443, true, com.android.org.conscrypt.SSLParametersImpl@2ccad02)<br>com.android.org.conscrypt.OpenSSLSocketImpl.OpenSSLSocketImpl(Socket[address=<a href="http://www.baidu.com/180.101.49.12,port=443,localPort=44405]" target="_blank" rel="noopener">www.baidu.com/180.101.49.12,port=443,localPort=44405]</a>, <a href="http://www.baidu.com/" target="_blank" rel="noopener">www.baidu.com</a>, 443, true)<br>com.android.org.conscrypt.AbstractConscryptSocket.AbstractConscryptSocket(Socket[address=<a href="http://www.baidu.com/180.101.49.12,port=443,localPort=44405]" target="_blank" rel="noopener">www.baidu.com/180.101.49.12,port=443,localPort=44405]</a>, <a href="http://www.baidu.com/" target="_blank" rel="noopener">www.baidu.com</a>, 443, true)<br>com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLOutputStream.ConscryptFileDescriptorSocket$SSLOutputStream(SSL socket over Socket[address=<a href="http://www.baidu.com/180.101.49.12,port=443,localPort=44405]" target="_blank" rel="noopener">www.baidu.com/180.101.49.12,port=443,localPort=44405]</a>)<br>com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLInputStream.ConscryptFileDescriptorSocket$SSLInputStream(SSL socket over Socket[address=<a href="http://www.baidu.com/180.101.49.12,port=443,localPort=44405]" target="_blank" rel="noopener">www.baidu.com/180.101.49.12,port=443,localPort=44405]</a>)</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function hook_Address()&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        Java.use(&quot;java.net.InetSocketAddress&quot;).$init.overload(&#39;java.net.InetAddress&#39;, &#39;int&#39;).implementation &#x3D; function(addr,int)&#123;</span><br><span class="line">            var result &#x3D; this.$init(addr,int) </span><br><span class="line">            if(addr.isSiteLocalAddress())&#123; &#x2F;&#x2F; 判断是不是本地地址</span><br><span class="line">                console.log(&quot;Local address &#x3D;&gt; &quot;,addr.toString(),&quot; port is &#x3D;&gt; &quot;,int)</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                console.log(&quot;Server address &#x3D;&gt; &quot;,addr.toString(),&quot; port is &#x3D;&gt; &quot;,int)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>frida -U -f com.onejane.httpsocket -l socketAddress.js –no-pause</p><p>frida -U com.cz.babySister -l socketAddress.js –no-pause -o /root/Desktop/babySisterLogin.txt 使用attach模式抓移动tv登录包http</p><p>frida -U com.ilulutv.fulao2 -l socketAddress.js –no-pause -o /root/Desktop/fulao2Login.txt 使用attach模式抓fulao2登录包https</p><p>frida -U com.ilulutv.fulao2 -l hookEvent.js 点击得到所在event的类，点击登录触发AccountActivity</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android hooking search classes cipher  直接搜索加密相关类，并将所有类加入txt文件进行批量hook</span><br><span class="line">objection -g com.onejane.httpsocket explore -c ~&#x2F;root&#x2F;Desktop&#x2F;hookCipher.txt </span><br><span class="line">android hooking watch class_method javax.crypto.Cipher.createCipher   hook系统的cipher类</span><br><span class="line">android hooking watch class_method net.idik.lib.cipher.so.encrypt.AESEncryptor.decrypt</span><br><span class="line">android hooking watch class_method javax.crypto.Cipher.doFinel   根据堆栈找到登录时触发的app函数</span><br><span class="line">android hooking watch class com.ilulutv.fulao2.other.i.b --dump-args --dump-backtrace --dump-return</span><br><span class="line">android hooking watch class_method com.ilulutv.fulao2.other.i.b.a --dump-args --dump-backtrace --dump-return</span><br><span class="line">android hooking watch class_method com.ilulutv.fulao2.other.i.b.b --dump-args --dump-backtrace --dump-return</span><br><span class="line">android hooking watch class_method com.ilulutv.fulao2.other.i.b.c --dump-args --dump-backtrace --dump-return</span><br><span class="line">android hooking watch class_method com.ilulutv.fulao2.other.i.b.d --dump-args --dump-backtrace --dump-return</span><br><span class="line">android hooking watch class_method com.ilulutv.fulao2.other.i.b.e --dump-args --dump-backtrace --dump-return</span><br></pre></td></tr></table></figure><blockquote><p>手机上抓：优点：无法对抗，全部能抓，没有抓不到的包<br>hook抓包：<br>- 优点1：为所欲为，可以对包的内容进行进一步的更改和定制；<br>- 优点2：抓包全面，直接就是明文，不需要解协议（无需绕过证书绑定,进入ssl之前已经抓到包）<br>- 缺点：可能会不全、可能会漏。hook点是有限的，万一它在用奇葩的框架做网络传输就会漏掉<br><code>Charles</code>+<code>Postern</code>：协议层抓包：<br>- 优点：全面。已经解好了协议，HTTP、WebSocket直接解好。<br>- 缺点：配置证书稍微麻烦，解不了纯Socket。</p></blockquote><h1 id="抓包通杀"><a href="#抓包通杀" class="headerlink" title="抓包通杀"></a>抓包通杀</h1><p>git clone <a href="https://github.com/BigFaceCat2017/frida_ssl_logger.git" target="_blank" rel="noopener">https://github.com/BigFaceCat2017/frida_ssl_logger.git</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python ssl_logger.py  -U -v com.iqiyi.video -p iqiyi.pcap  爱奇艺获取验证码抓包</span><br><span class="line">plugin wallbreaker objectsearch java.net.SocketOutputStream</span><br><span class="line">plugin wallbreaker objectdump --fullname 0x4c16  看到socket类中地址和ip</span><br><span class="line">android hooking search classes socket  将相关类拷贝到文件中前面加上android hooking watch class</span><br><span class="line">objection -g com.roysue.httpsocket explore -c tracesocket.txt  哪个类报错干掉哪个类即可</span><br></pre></td></tr></table></figure><p>r0capture.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br></pre></td><td class="code"><pre><span class="line"># Copyright 2017 Google Inc. All Rights Reserved.</span><br><span class="line"></span><br><span class="line"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"># you may not use this file except in compliance with the License.</span><br><span class="line"># You may obtain a copy of the License at</span><br><span class="line">#</span><br><span class="line">#     http:&#x2F;&#x2F;www.apache.org&#x2F;licenses&#x2F;LICENSE-2.0</span><br><span class="line">#</span><br><span class="line"># Unless required by applicable law or agreed to in writing, software</span><br><span class="line"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"># See the License for the specific language governing permissions and</span><br><span class="line"># limitations under the License.</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;Decrypts and logs a process&#39;s SSL traffic.</span><br><span class="line">Hooks the functions SSL_read() and SSL_write() in a given process and logs the</span><br><span class="line">decrypted data to the console and&#x2F;or to a pcap file.</span><br><span class="line">  Typical usage example:</span><br><span class="line">  ssl_log(&quot;wget&quot;, &quot;log.pcap&quot;, True)</span><br><span class="line">Dependencies:</span><br><span class="line">  frida (https:&#x2F;&#x2F;www.frida.re&#x2F;):</span><br><span class="line">    sudo pip install frida</span><br><span class="line">  hexdump (https:&#x2F;&#x2F;bitbucket.org&#x2F;techtonik&#x2F;hexdump&#x2F;) if using verbose output:</span><br><span class="line">    sudo pip install hexdump</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">__author__ &#x3D; &quot;geffner@google.com (Jason Geffner)&quot;</span><br><span class="line">__version__ &#x3D; &quot;2.0&quot;</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"># r0capture</span><br><span class="line"></span><br><span class="line">ID: r0ysue </span><br><span class="line"></span><br><span class="line">安卓应用层抓包通杀脚本</span><br><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;r0ysue&#x2F;r0capture</span><br><span class="line"></span><br><span class="line">## 简介</span><br><span class="line"></span><br><span class="line">- 仅限安卓平台，测试安卓7、8、9、10 可用 ；</span><br><span class="line">- 无视所有证书校验或绑定，无视任何证书；</span><br><span class="line">- 通杀TCP&#x2F;IP四层模型中的应用层中的全部协议；</span><br><span class="line">- 通杀协议包括：Http,WebSocket,Ftp,Xmpp,Imap,Smtp,Protobuf等等、以及它们的SSL版本；</span><br><span class="line">- 通杀所有应用层框架，包括HttpUrlConnection、Okhttp1&#x2F;3&#x2F;4、Retrofit&#x2F;Volley等等；</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Windows版本需要安装库：</span><br><span class="line"># pip install &#39;win_inet_pton&#39;</span><br><span class="line"># pip install hexdump</span><br><span class="line">import argparse</span><br><span class="line">import os</span><br><span class="line">import platform</span><br><span class="line">import pprint</span><br><span class="line">import random</span><br><span class="line">import signal</span><br><span class="line">import socket</span><br><span class="line">import struct</span><br><span class="line">import time</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">import frida</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    if os.name &#x3D;&#x3D; &#39;nt&#39;:</span><br><span class="line">        import win_inet_pton</span><br><span class="line">except ImportError:</span><br><span class="line">    # win_inet_pton import error</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    import hexdump  # pylint: disable&#x3D;g-import-not-at-top</span><br><span class="line">except ImportError:</span><br><span class="line">    pass</span><br><span class="line">try:</span><br><span class="line">    from shutil import get_terminal_size as get_terminal_size</span><br><span class="line">except:</span><br><span class="line">    try:</span><br><span class="line">        from backports.shutil_get_terminal_size import get_terminal_size as get_terminal_size</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    import click</span><br><span class="line">except:</span><br><span class="line">    class click:</span><br><span class="line">        @staticmethod</span><br><span class="line">        def secho(message&#x3D;None, **kwargs):</span><br><span class="line">            print(message)</span><br><span class="line">        @staticmethod</span><br><span class="line">        def style(**kwargs):</span><br><span class="line">            raise Exception(&quot;unsupported style&quot;)</span><br><span class="line"></span><br><span class="line">banner &#x3D; &quot;&quot;&quot;</span><br><span class="line">--------------------------------------------------------------------------------------------</span><br><span class="line">           .oooo.                                      .                                  </span><br><span class="line">          d8P&#39;&#96;Y8b                                   .o8                                  </span><br><span class="line">oooo d8b 888    888  .ooooo.   .oooo.   oo.ooooo.  .o888oo oooo  oooo  oooo d8b  .ooooo.  </span><br><span class="line">&#96;888&quot;&quot;8P 888    888 d88&#39; &#96;&quot;Y8 &#96;P  )88b   888&#39; &#96;88b   888   &#96;888  &#96;888  &#96;888&quot;&quot;8P d88&#39; &#96;88b </span><br><span class="line"> 888     888    888 888        .oP&quot;888   888   888   888    888   888   888     888ooo888 </span><br><span class="line"> 888     &#96;88b  d88&#39; 888   .o8 d8(  888   888   888   888 .  888   888   888     888    .o </span><br><span class="line">d888b     &#96;Y8bd8P&#39;  &#96;Y8bod8P&#39; &#96;Y888&quot;&quot;8o  888bod8P&#39;   &quot;888&quot;  &#96;V88V&quot;V8P&#39; d888b    &#96;Y8bod8P&#39; </span><br><span class="line">                                         888                                              </span><br><span class="line">                                        o888o                                                                                                                                       </span><br><span class="line">                    https:&#x2F;&#x2F;github.com&#x2F;r0ysue&#x2F;r0capture</span><br><span class="line">--------------------------------------------------------------------------------------------\n</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def show_banner():</span><br><span class="line">    colors &#x3D; [&#39;bright_red&#39;, &#39;bright_green&#39;, &#39;bright_blue&#39;, &#39;cyan&#39;, &#39;magenta&#39;]</span><br><span class="line">    try:</span><br><span class="line">        click.style(&#39;color test&#39;, fg&#x3D;&#39;bright_red&#39;)</span><br><span class="line">    except:</span><br><span class="line">        colors &#x3D; [&#39;red&#39;, &#39;green&#39;, &#39;blue&#39;, &#39;cyan&#39;, &#39;magenta&#39;]</span><br><span class="line">    try:</span><br><span class="line">        columns &#x3D; get_terminal_size().columns</span><br><span class="line">        if columns &gt;&#x3D; len(banner.splitlines()[1]):</span><br><span class="line">            for line in banner.splitlines():</span><br><span class="line">                click.secho(line, fg&#x3D;random.choice(colors))</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line"># ssl_session[&lt;SSL_SESSION id&gt;] &#x3D; (&lt;bytes sent by client&gt;,</span><br><span class="line">#                                  &lt;bytes sent by server&gt;)</span><br><span class="line">ssl_sessions &#x3D; &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def ssl_log(process, pcap&#x3D;None, host&#x3D;False, verbose&#x3D;False, isUsb&#x3D;False, ssllib&#x3D;&quot;&quot;, isSpawn&#x3D;True, wait&#x3D;0):</span><br><span class="line">    &quot;&quot;&quot;Decrypts and logs a process&#39;s SSL traffic.</span><br><span class="line">    Hooks the functions SSL_read() and SSL_write() in a given process and logs</span><br><span class="line">    the decrypted data to the console and&#x2F;or to a pcap file.</span><br><span class="line">    Args:</span><br><span class="line">      process: The target process&#39;s name (as a string) or process ID (as an int).</span><br><span class="line">      pcap: The file path to which the pcap file should be written.</span><br><span class="line">      verbose: If True, log the decrypted traffic to the console.</span><br><span class="line">    Raises:</span><br><span class="line">      NotImplementedError: Not running on a Linux or macOS system.</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # if platform.system() not in (&quot;Darwin&quot;, &quot;Linux&quot;):</span><br><span class="line">    #   raise NotImplementedError(&quot;This function is only implemented for Linux and &quot;</span><br><span class="line">    #                             &quot;macOS systems.&quot;)</span><br><span class="line"></span><br><span class="line">    def log_pcap(pcap_file, ssl_session_id, function, src_addr, src_port,</span><br><span class="line">                 dst_addr, dst_port, data):</span><br><span class="line">        &quot;&quot;&quot;Writes the captured data to a pcap file.</span><br><span class="line">        Args:</span><br><span class="line">          pcap_file: The opened pcap file.</span><br><span class="line">          ssl_session_id: The SSL session ID for the communication.</span><br><span class="line">          function: The function that was intercepted (&quot;SSL_read&quot; or &quot;SSL_write&quot;).</span><br><span class="line">          src_addr: The source address of the logged packet.</span><br><span class="line">          src_port: The source port of the logged packet.</span><br><span class="line">          dst_addr: The destination address of the logged packet.</span><br><span class="line">          dst_port: The destination port of the logged packet.</span><br><span class="line">          data: The decrypted packet data.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        t &#x3D; time.time()</span><br><span class="line"></span><br><span class="line">        if ssl_session_id not in ssl_sessions:</span><br><span class="line">            ssl_sessions[ssl_session_id] &#x3D; (random.randint(0, 0xFFFFFFFF),</span><br><span class="line">                                            random.randint(0, 0xFFFFFFFF))</span><br><span class="line">        client_sent, server_sent &#x3D; ssl_sessions[ssl_session_id]</span><br><span class="line"></span><br><span class="line">        if function &#x3D;&#x3D; &quot;SSL_read&quot;:</span><br><span class="line">            seq, ack &#x3D; (server_sent, client_sent)</span><br><span class="line">        else:</span><br><span class="line">            seq, ack &#x3D; (client_sent, server_sent)</span><br><span class="line"></span><br><span class="line">        for writes in (</span><br><span class="line">                # PCAP record (packet) header</span><br><span class="line">                (&quot;&#x3D;I&quot;, int(t)),  # Timestamp seconds</span><br><span class="line">                (&quot;&#x3D;I&quot;, int((t * 1000000) % 1000000)),  # Timestamp microseconds</span><br><span class="line">                (&quot;&#x3D;I&quot;, 40 + len(data)),  # Number of octets saved</span><br><span class="line">                (&quot;&#x3D;i&quot;, 40 + len(data)),  # Actual length of packet</span><br><span class="line">                # IPv4 header</span><br><span class="line">                (&quot;&gt;B&quot;, 0x45),  # Version and Header Length</span><br><span class="line">                (&quot;&gt;B&quot;, 0),  # Type of Service</span><br><span class="line">                (&quot;&gt;H&quot;, 40 + len(data)),  # Total Length</span><br><span class="line">                (&quot;&gt;H&quot;, 0),  # Identification</span><br><span class="line">                (&quot;&gt;H&quot;, 0x4000),  # Flags and Fragment Offset</span><br><span class="line">                (&quot;&gt;B&quot;, 0xFF),  # Time to Live</span><br><span class="line">                (&quot;&gt;B&quot;, 6),  # Protocol</span><br><span class="line">                (&quot;&gt;H&quot;, 0),  # Header Checksum</span><br><span class="line">                (&quot;&gt;I&quot;, src_addr),  # Source Address</span><br><span class="line">                (&quot;&gt;I&quot;, dst_addr),  # Destination Address</span><br><span class="line">                # TCP header</span><br><span class="line">                (&quot;&gt;H&quot;, src_port),  # Source Port</span><br><span class="line">                (&quot;&gt;H&quot;, dst_port),  # Destination Port</span><br><span class="line">                (&quot;&gt;I&quot;, seq),  # Sequence Number</span><br><span class="line">                (&quot;&gt;I&quot;, ack),  # Acknowledgment Number</span><br><span class="line">                (&quot;&gt;H&quot;, 0x5018),  # Header Length and Flags</span><br><span class="line">                (&quot;&gt;H&quot;, 0xFFFF),  # Window Size</span><br><span class="line">                (&quot;&gt;H&quot;, 0),  # Checksum</span><br><span class="line">                (&quot;&gt;H&quot;, 0)):  # Urgent Pointer</span><br><span class="line">            pcap_file.write(struct.pack(writes[0], writes[1]))</span><br><span class="line">        pcap_file.write(data)</span><br><span class="line"></span><br><span class="line">        if function &#x3D;&#x3D; &quot;SSL_read&quot;:</span><br><span class="line">            server_sent +&#x3D; len(data)</span><br><span class="line">        else:</span><br><span class="line">            client_sent +&#x3D; len(data)</span><br><span class="line">        ssl_sessions[ssl_session_id] &#x3D; (client_sent, server_sent)</span><br><span class="line"></span><br><span class="line">    def on_message(message, data):</span><br><span class="line">        &quot;&quot;&quot;Callback for errors and messages sent from Frida-injected JavaScript.</span><br><span class="line">        Logs captured packet data received from JavaScript to the console and&#x2F;or a</span><br><span class="line">        pcap file. See https:&#x2F;&#x2F;www.frida.re&#x2F;docs&#x2F;messages&#x2F; for more detail on</span><br><span class="line">        Frida&#39;s messages.</span><br><span class="line">        Args:</span><br><span class="line">          message: A dictionary containing the message &quot;type&quot; and other fields</span><br><span class="line">              dependent on message type.</span><br><span class="line">          data: The string of captured decrypted data.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        if message[&quot;type&quot;] &#x3D;&#x3D; &quot;error&quot;:</span><br><span class="line">            pprint.pprint(message)</span><br><span class="line">            os.kill(os.getpid(), signal.SIGTERM)</span><br><span class="line">            return</span><br><span class="line">        if len(data) &#x3D;&#x3D; 1:</span><br><span class="line">            print(message[&quot;payload&quot;][&quot;function&quot;])</span><br><span class="line">            print(message[&quot;payload&quot;][&quot;stack&quot;])</span><br><span class="line">            return</span><br><span class="line">        p &#x3D; message[&quot;payload&quot;]        </span><br><span class="line">        if verbose:</span><br><span class="line">            src_addr &#x3D; socket.inet_ntop(socket.AF_INET,</span><br><span class="line">                                        struct.pack(&quot;&gt;I&quot;, p[&quot;src_addr&quot;]))</span><br><span class="line">            dst_addr &#x3D; socket.inet_ntop(socket.AF_INET,</span><br><span class="line">                                        struct.pack(&quot;&gt;I&quot;, p[&quot;dst_addr&quot;]))</span><br><span class="line">            print(&quot;SSL Session: &quot; + p[&quot;ssl_session_id&quot;])</span><br><span class="line">            print(&quot;[%s] %s:%d --&gt; %s:%d&quot; % (</span><br><span class="line">                p[&quot;function&quot;],</span><br><span class="line">                src_addr,</span><br><span class="line">                p[&quot;src_port&quot;],</span><br><span class="line">                dst_addr,</span><br><span class="line">                p[&quot;dst_port&quot;]))</span><br><span class="line">            hexdump.hexdump(data)</span><br><span class="line">            print(p[&quot;stack&quot;])</span><br><span class="line">        if pcap:</span><br><span class="line">            log_pcap(pcap_file, p[&quot;ssl_session_id&quot;], p[&quot;function&quot;], p[&quot;src_addr&quot;],</span><br><span class="line">                     p[&quot;src_port&quot;], p[&quot;dst_addr&quot;], p[&quot;dst_port&quot;], data)</span><br><span class="line"></span><br><span class="line">    if isUsb:</span><br><span class="line">        try:</span><br><span class="line">            device &#x3D; frida.get_usb_device()</span><br><span class="line">        except:</span><br><span class="line">            device &#x3D; frida.get_remote_device()</span><br><span class="line">    else:</span><br><span class="line">        if host:</span><br><span class="line">            manager &#x3D; frida.get_device_manager()</span><br><span class="line">            device &#x3D; manager.add_remote_device(host)</span><br><span class="line">        else:</span><br><span class="line">            device &#x3D; frida.get_local_device()</span><br><span class="line"></span><br><span class="line">    if isSpawn:</span><br><span class="line">        pid &#x3D; device.spawn([process])</span><br><span class="line">        time.sleep(1)</span><br><span class="line">        session &#x3D; device.attach(pid)</span><br><span class="line">        time.sleep(1)</span><br><span class="line">        device.resume(pid)</span><br><span class="line">    else:</span><br><span class="line">        print(&quot;attach&quot;)</span><br><span class="line">        session &#x3D; device.attach(process)</span><br><span class="line">    if wait &gt; 0:</span><br><span class="line">        print(&quot;wait for &#123;&#125; seconds&quot;.format(wait))</span><br><span class="line">        time.sleep(wait)</span><br><span class="line"></span><br><span class="line">    # session &#x3D; frida.attach(process)</span><br><span class="line"></span><br><span class="line">    # pid &#x3D; device.spawn([process])</span><br><span class="line">    # pid &#x3D; process</span><br><span class="line">    # session &#x3D; device.attach(pid)</span><br><span class="line">    # device.resume(pid)</span><br><span class="line">    if pcap:</span><br><span class="line">        pcap_file &#x3D; open(pcap, &quot;wb&quot;, 0)</span><br><span class="line">        for writes in (</span><br><span class="line">                (&quot;&#x3D;I&quot;, 0xa1b2c3d4),  # Magic number</span><br><span class="line">                (&quot;&#x3D;H&quot;, 2),  # Major version number</span><br><span class="line">                (&quot;&#x3D;H&quot;, 4),  # Minor version number</span><br><span class="line">                (&quot;&#x3D;i&quot;, time.timezone),  # GMT to local correction</span><br><span class="line">                (&quot;&#x3D;I&quot;, 0),  # Accuracy of timestamps</span><br><span class="line">                (&quot;&#x3D;I&quot;, 65535),  # Max length of captured packets</span><br><span class="line">                (&quot;&#x3D;I&quot;, 228)):  # Data link type (LINKTYPE_IPV4)</span><br><span class="line">            pcap_file.write(struct.pack(writes[0], writes[1]))</span><br><span class="line"></span><br><span class="line">    with open(&quot;.&#x2F;script.js&quot;, encoding&#x3D;&quot;utf-8&quot;) as f:</span><br><span class="line">        _FRIDA_SCRIPT &#x3D; f.read()</span><br><span class="line">        # _FRIDA_SCRIPT &#x3D; session.create_script(content)</span><br><span class="line">        # print(_FRIDA_SCRIPT)</span><br><span class="line">    script &#x3D; session.create_script(_FRIDA_SCRIPT)</span><br><span class="line">    script.on(&quot;message&quot;, on_message)</span><br><span class="line">    script.load()</span><br><span class="line"></span><br><span class="line">    if ssllib !&#x3D; &quot;&quot;:</span><br><span class="line">        script.exports.setssllib(ssllib)</span><br><span class="line"></span><br><span class="line">    print(&quot;Press Ctrl+C to stop logging.&quot;)</span><br><span class="line"></span><br><span class="line">    def stoplog(signum, frame):</span><br><span class="line">        print(&#39;You have stoped logging.&#39;)</span><br><span class="line">        session.detach()</span><br><span class="line">        if pcap:</span><br><span class="line">            pcap_file.flush()</span><br><span class="line">            pcap_file.close()</span><br><span class="line">        exit()</span><br><span class="line">    signal.signal(signal.SIGINT, stoplog)</span><br><span class="line">    signal.signal(signal.SIGTERM, stoplog)</span><br><span class="line">    sys.stdin.read()</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    show_banner()</span><br><span class="line">    class ArgParser(argparse.ArgumentParser):</span><br><span class="line"></span><br><span class="line">        def error(self, message):</span><br><span class="line">            print(&quot;ssl_logger v&quot; + __version__)</span><br><span class="line">            print(&quot;by &quot; + __author__)</span><br><span class="line">            print(&quot;Modified by BigFaceCat&quot;)</span><br><span class="line">            print(&quot;Error: &quot; + message)</span><br><span class="line">            print()</span><br><span class="line">            print(self.format_help().replace(&quot;usage:&quot;, &quot;Usage:&quot;))</span><br><span class="line">            self.exit(0)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    parser &#x3D; ArgParser(</span><br><span class="line">        add_help&#x3D;False,</span><br><span class="line">        description&#x3D;&quot;Decrypts and logs a process&#39;s SSL traffic.&quot;,</span><br><span class="line">        formatter_class&#x3D;argparse.RawDescriptionHelpFormatter,</span><br><span class="line">        epilog&#x3D;r&quot;&quot;&quot;</span><br><span class="line">Examples:</span><br><span class="line">    %(prog)s -pcap ssl.pcap openssl</span><br><span class="line">    %(prog)s -verbose 31337</span><br><span class="line">    %(prog)s -pcap log.pcap -verbose wget</span><br><span class="line">    %(prog)s -pcap log.pcap -ssl &quot;*libssl.so*&quot; com.bigfacecat.testdemo</span><br><span class="line">&quot;&quot;&quot;)</span><br><span class="line"></span><br><span class="line">    args &#x3D; parser.add_argument_group(&quot;Arguments&quot;)</span><br><span class="line">    args.add_argument(&quot;-pcap&quot;, &#39;-p&#39;, metavar&#x3D;&quot;&lt;path&gt;&quot;, required&#x3D;False,</span><br><span class="line">                      help&#x3D;&quot;Name of PCAP file to write&quot;)</span><br><span class="line">    args.add_argument(&quot;-host&quot;, &#39;-H&#39;, metavar&#x3D;&quot;&lt;192.168.1.1:27042&gt;&quot;, required&#x3D;False,</span><br><span class="line">                      help&#x3D;&quot;connect to remote frida-server on HOST&quot;)</span><br><span class="line">    args.add_argument(&quot;-verbose&quot;,&quot;-v&quot;,  required&#x3D;False, action&#x3D;&quot;store_const&quot;, default&#x3D;True,</span><br><span class="line">                      const&#x3D;True, help&#x3D;&quot;Show verbose output&quot;)</span><br><span class="line">    args.add_argument(&quot;process&quot;, metavar&#x3D;&quot;&lt;process name | process id&gt;&quot;,</span><br><span class="line">                      help&#x3D;&quot;Process whose SSL calls to log&quot;)</span><br><span class="line">    args.add_argument(&quot;-ssl&quot;, default&#x3D;&quot;&quot;, metavar&#x3D;&quot;&lt;lib&gt;&quot;,</span><br><span class="line">                      help&#x3D;&quot;SSL library to hook&quot;)</span><br><span class="line">    args.add_argument(&quot;--isUsb&quot;, &quot;-U&quot;, default&#x3D;False, action&#x3D;&quot;store_true&quot;,</span><br><span class="line">                      help&#x3D;&quot;connect to USB device&quot;)</span><br><span class="line">    args.add_argument(&quot;--isSpawn&quot;, &quot;-f&quot;, default&#x3D;False, action&#x3D;&quot;store_true&quot;,</span><br><span class="line">                      help&#x3D;&quot;if spawned app&quot;)</span><br><span class="line">    args.add_argument(&quot;-wait&quot;, &quot;-w&quot;, type&#x3D;int, metavar&#x3D;&quot;&lt;seconds&gt;&quot;, default&#x3D;0,</span><br><span class="line">                      help&#x3D;&quot;Time to wait for the process&quot;)</span><br><span class="line"></span><br><span class="line">    parsed &#x3D; parser.parse_args()</span><br><span class="line">    ssl_log(</span><br><span class="line">        int(parsed.process) if parsed.process.isdigit() else parsed.process, </span><br><span class="line">    parsed.pcap, </span><br><span class="line">    parsed.host,</span><br><span class="line">    parsed.verbose, </span><br><span class="line">    isUsb&#x3D;parsed.isUsb, </span><br><span class="line">    isSpawn&#x3D;parsed.isSpawn, </span><br><span class="line">    ssllib&#x3D;parsed.ssl, </span><br><span class="line">    wait&#x3D;parsed.wait</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>script.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">   * Initializes &#39;addresses&#39; dictionary and NativeFunctions.</span><br><span class="line">   *&#x2F;</span><br><span class="line">&quot;use strict&quot;;</span><br><span class="line">rpc.exports &#x3D; &#123;</span><br><span class="line">  setssllib: function (name) &#123;</span><br><span class="line">    console.log(&quot;setSSLLib &#x3D;&gt; &quot; + name);</span><br><span class="line">    libname &#x3D; name;</span><br><span class="line">    initializeGlobals();</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var addresses &#x3D; &#123;&#125;;</span><br><span class="line">var SSL_get_fd &#x3D; null;</span><br><span class="line">var SSL_get_session &#x3D; null;</span><br><span class="line">var SSL_SESSION_get_id &#x3D; null;</span><br><span class="line">var getpeername &#x3D; null;</span><br><span class="line">var getsockname &#x3D; null;</span><br><span class="line">var ntohs &#x3D; null;</span><br><span class="line">var ntohl &#x3D; null;</span><br><span class="line">var SSLstackwrite &#x3D; null;</span><br><span class="line">var SSLstackread &#x3D; null;</span><br><span class="line"></span><br><span class="line">var libname &#x3D; &quot;*libssl*&quot;;</span><br><span class="line"></span><br><span class="line">function uuid(len, radix) &#123;</span><br><span class="line">  var chars &#x3D; &#39;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&#39;.split(&#39;&#39;);</span><br><span class="line">  var uuid &#x3D; [], i;</span><br><span class="line">  radix &#x3D; radix || chars.length;</span><br><span class="line"></span><br><span class="line">  if (len) &#123;</span><br><span class="line">    &#x2F;&#x2F; Compact form</span><br><span class="line">    for (i &#x3D; 0; i &lt; len; i++) uuid[i] &#x3D; chars[0 | Math.random() * radix];</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F; rfc4122, version 4 form</span><br><span class="line">    var r;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; rfc4122 requires these characters</span><br><span class="line">    uuid[8] &#x3D; uuid[13] &#x3D; uuid[18] &#x3D; uuid[23] &#x3D; &#39;-&#39;;</span><br><span class="line">    uuid[14] &#x3D; &#39;4&#39;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Fill in random data. At i&#x3D;&#x3D;19 set the high bits of clock sequence as</span><br><span class="line">    &#x2F;&#x2F; per rfc4122, sec. 4.1.5</span><br><span class="line">    for (i &#x3D; 0; i &lt; 36; i++) &#123;</span><br><span class="line">      if (!uuid[i]) &#123;</span><br><span class="line">        r &#x3D; 0 | Math.random() * 16;</span><br><span class="line">        uuid[i] &#x3D; chars[(i &#x3D;&#x3D; 19) ? (r &amp; 0x3) | 0x8 : r];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return uuid.join(&#39;&#39;);</span><br><span class="line">&#125;</span><br><span class="line">function return_zero(args) &#123;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line">function initializeGlobals() &#123;</span><br><span class="line">  var resolver &#x3D; new ApiResolver(&quot;module&quot;);</span><br><span class="line">  var exps &#x3D; [</span><br><span class="line">    [Process.platform &#x3D;&#x3D; &quot;darwin&quot; ? &quot;*libboringssl*&quot; : &quot;*libssl*&quot;, [&quot;SSL_read&quot;, &quot;SSL_write&quot;, &quot;SSL_get_fd&quot;, &quot;SSL_get_session&quot;, &quot;SSL_SESSION_get_id&quot;]], &#x2F;&#x2F; for ios and Android</span><br><span class="line">    [Process.platform &#x3D;&#x3D; &quot;darwin&quot; ? &quot;*libsystem*&quot; : &quot;*libc*&quot;, [&quot;getpeername&quot;, &quot;getsockname&quot;, &quot;ntohs&quot;, &quot;ntohl&quot;]]</span><br><span class="line">  ];</span><br><span class="line">  &#x2F;&#x2F; console.log(exps)</span><br><span class="line">  for (var i &#x3D; 0; i &lt; exps.length; i++) &#123;</span><br><span class="line">    var lib &#x3D; exps[i][0];</span><br><span class="line">    var names &#x3D; exps[i][1];</span><br><span class="line">    for (var j &#x3D; 0; j &lt; names.length; j++) &#123;</span><br><span class="line">      var name &#x3D; names[j];</span><br><span class="line">      &#x2F;&#x2F; console.log(&quot;exports:&quot; + lib + &quot;!&quot; + name)</span><br><span class="line">      var matches &#x3D; resolver.enumerateMatchesSync(&quot;exports:&quot; + lib + &quot;!&quot; + name);</span><br><span class="line">      if (matches.length &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        if (name &#x3D;&#x3D; &quot;SSL_get_fd&quot;) &#123;</span><br><span class="line">          addresses[&quot;SSL_get_fd&quot;] &#x3D; 0;</span><br><span class="line">          continue;</span><br><span class="line">        &#125;</span><br><span class="line">        throw &quot;Could not find &quot; + lib + &quot;!&quot; + name;</span><br><span class="line">      &#125;</span><br><span class="line">      else if (matches.length !&#x3D; 1) &#123;</span><br><span class="line">        &#x2F;&#x2F; Sometimes Frida returns duplicates.</span><br><span class="line">        var address &#x3D; 0;</span><br><span class="line">        var s &#x3D; &quot;&quot;;</span><br><span class="line">        var duplicates_only &#x3D; true;</span><br><span class="line">        for (var k &#x3D; 0; k &lt; matches.length; k++) &#123;</span><br><span class="line">          if (s.length !&#x3D; 0) &#123;</span><br><span class="line">            s +&#x3D; &quot;, &quot;;</span><br><span class="line">          &#125;</span><br><span class="line">          s +&#x3D; matches[k].name + &quot;@&quot; + matches[k].address;</span><br><span class="line">          if (address &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            address &#x3D; matches[k].address;</span><br><span class="line">          &#125;</span><br><span class="line">          else if (!address.equals(matches[k].address)) &#123;</span><br><span class="line">            duplicates_only &#x3D; false;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!duplicates_only) &#123;</span><br><span class="line">          throw &quot;More than one match found for &quot; + lib + &quot;!&quot; + name + &quot;: &quot; + s;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      addresses[name] &#x3D; matches[0].address;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if (addresses[&quot;SSL_get_fd&quot;] &#x3D;&#x3D; 0) &#123;</span><br><span class="line">    SSL_get_fd &#x3D; return_zero;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    SSL_get_fd &#x3D; new NativeFunction(addresses[&quot;SSL_get_fd&quot;], &quot;int&quot;, [&quot;pointer&quot;]);</span><br><span class="line">  &#125;</span><br><span class="line">  SSL_get_session &#x3D; new NativeFunction(addresses[&quot;SSL_get_session&quot;], &quot;pointer&quot;, [&quot;pointer&quot;]);</span><br><span class="line">  SSL_SESSION_get_id &#x3D; new NativeFunction(addresses[&quot;SSL_SESSION_get_id&quot;], &quot;pointer&quot;, [&quot;pointer&quot;, &quot;pointer&quot;]);</span><br><span class="line">  getpeername &#x3D; new NativeFunction(addresses[&quot;getpeername&quot;], &quot;int&quot;, [&quot;int&quot;, &quot;pointer&quot;, &quot;pointer&quot;]);</span><br><span class="line">  getsockname &#x3D; new NativeFunction(addresses[&quot;getsockname&quot;], &quot;int&quot;, [&quot;int&quot;, &quot;pointer&quot;, &quot;pointer&quot;]);</span><br><span class="line">  ntohs &#x3D; new NativeFunction(addresses[&quot;ntohs&quot;], &quot;uint16&quot;, [&quot;uint16&quot;]);</span><br><span class="line">  ntohl &#x3D; new NativeFunction(addresses[&quot;ntohl&quot;], &quot;uint32&quot;, [&quot;uint32&quot;]);</span><br><span class="line">&#125;</span><br><span class="line">initializeGlobals();</span><br><span class="line"></span><br><span class="line">function ipToNumber(ip) &#123;</span><br><span class="line">  var num &#x3D; 0;</span><br><span class="line">  if (ip &#x3D;&#x3D; &quot;&quot;) &#123;</span><br><span class="line">    return num;</span><br><span class="line">  &#125;</span><br><span class="line">  var aNum &#x3D; ip.split(&quot;.&quot;);</span><br><span class="line">  if (aNum.length !&#x3D; 4) &#123;</span><br><span class="line">    return num;</span><br><span class="line">  &#125;</span><br><span class="line">  num +&#x3D; parseInt(aNum[0]) &lt;&lt; 0;</span><br><span class="line">  num +&#x3D; parseInt(aNum[1]) &lt;&lt; 8;</span><br><span class="line">  num +&#x3D; parseInt(aNum[2]) &lt;&lt; 16;</span><br><span class="line">  num +&#x3D; parseInt(aNum[3]) &lt;&lt; 24;</span><br><span class="line">  num &#x3D; num &gt;&gt;&gt; 0;&#x2F;&#x2F;这个很关键，不然可能会出现负数的情况</span><br><span class="line">  return num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * Returns a dictionary of a sockfd&#39;s &quot;src_addr&quot;, &quot;src_port&quot;, &quot;dst_addr&quot;, and</span><br><span class="line"> * &quot;dst_port&quot;.</span><br><span class="line"> * @param &#123;int&#125; sockfd The file descriptor of the socket to inspect.</span><br><span class="line"> * @param &#123;boolean&#125; isRead If true, the context is an SSL_read call. If</span><br><span class="line"> *     false, the context is an SSL_write call.</span><br><span class="line"> * @return &#123;dict&#125; Dictionary of sockfd&#39;s &quot;src_addr&quot;, &quot;src_port&quot;, &quot;dst_addr&quot;,</span><br><span class="line"> *     and &quot;dst_port&quot;.</span><br><span class="line"> *&#x2F;</span><br><span class="line">function getPortsAndAddresses(sockfd, isRead) &#123;</span><br><span class="line">  var message &#x3D; &#123;&#125;;</span><br><span class="line">  var src_dst &#x3D; [&quot;src&quot;, &quot;dst&quot;];</span><br><span class="line">  for (var i &#x3D; 0; i &lt; src_dst.length; i++) &#123;</span><br><span class="line">    if ((src_dst[i] &#x3D;&#x3D; &quot;src&quot;) ^ isRead) &#123;</span><br><span class="line">      var sockAddr &#x3D; Socket.localAddress(sockfd)</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">      var sockAddr &#x3D; Socket.peerAddress(sockfd)</span><br><span class="line">    &#125;</span><br><span class="line">    if (sockAddr &#x3D;&#x3D; null) &#123;</span><br><span class="line">      &#x2F;&#x2F; 网络超时or其他原因可能导致socket被关闭</span><br><span class="line">      message[src_dst[i] + &quot;_port&quot;] &#x3D; 0</span><br><span class="line">      message[src_dst[i] + &quot;_addr&quot;] &#x3D; 0</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      message[src_dst[i] + &quot;_port&quot;] &#x3D; (sockAddr.port &amp; 0xFFFF)</span><br><span class="line">      message[src_dst[i] + &quot;_addr&quot;] &#x3D; ntohl(ipToNumber(sockAddr.ip.split(&quot;:&quot;).pop()))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return message;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;**</span><br><span class="line"> * Get the session_id of SSL object and return it as a hex string.</span><br><span class="line"> * @param &#123;!NativePointer&#125; ssl A pointer to an SSL object.</span><br><span class="line"> * @return &#123;dict&#125; A string representing the session_id of the SSL object&#39;s</span><br><span class="line"> *     SSL_SESSION. For example,</span><br><span class="line"> *     &quot;59FD71B7B90202F359D89E66AE4E61247954E28431F6C6AC46625D472FF76336&quot;.</span><br><span class="line"> *&#x2F;</span><br><span class="line">function getSslSessionId(ssl) &#123;</span><br><span class="line">  var session &#x3D; SSL_get_session(ssl);</span><br><span class="line">  if (session &#x3D;&#x3D; 0) &#123;</span><br><span class="line">    return 0;</span><br><span class="line">  &#125;</span><br><span class="line">  var len &#x3D; Memory.alloc(4);</span><br><span class="line">  var p &#x3D; SSL_SESSION_get_id(session, len);</span><br><span class="line">  len &#x3D; Memory.readU32(len);</span><br><span class="line">  var session_id &#x3D; &quot;&quot;;</span><br><span class="line">  for (var i &#x3D; 0; i &lt; len; i++) &#123;</span><br><span class="line">    &#x2F;&#x2F; Read a byte, convert it to a hex string (0xAB &#x3D;&#x3D;&gt; &quot;AB&quot;), and append</span><br><span class="line">    &#x2F;&#x2F; it to session_id.</span><br><span class="line">    session_id +&#x3D;</span><br><span class="line">      (&quot;0&quot; + Memory.readU8(p.add(i)).toString(16).toUpperCase()).substr(-2);</span><br><span class="line">  &#125;</span><br><span class="line">  return session_id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Interceptor.attach(addresses[&quot;SSL_read&quot;],</span><br><span class="line">  &#123;</span><br><span class="line">    onEnter: function (args) &#123;</span><br><span class="line">      var message &#x3D; getPortsAndAddresses(SSL_get_fd(args[0]), true);</span><br><span class="line">      message[&quot;ssl_session_id&quot;] &#x3D; getSslSessionId(args[0]);</span><br><span class="line">      message[&quot;function&quot;] &#x3D; &quot;SSL_read&quot;;</span><br><span class="line">      message[&quot;stack&quot;] &#x3D; SSLstackread;</span><br><span class="line">      this.message &#x3D; message;</span><br><span class="line">      this.buf &#x3D; args[1];</span><br><span class="line">    &#125;,</span><br><span class="line">    onLeave: function (retval) &#123;</span><br><span class="line">      retval |&#x3D; 0; &#x2F;&#x2F; Cast retval to 32-bit integer.</span><br><span class="line">      if (retval &lt;&#x3D; 0) &#123;</span><br><span class="line">        return;</span><br><span class="line">      &#125;</span><br><span class="line">      send(this.message, Memory.readByteArray(this.buf, retval));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">Interceptor.attach(addresses[&quot;SSL_write&quot;],</span><br><span class="line">  &#123;</span><br><span class="line">    onEnter: function (args) &#123;</span><br><span class="line">      var message &#x3D; getPortsAndAddresses(SSL_get_fd(args[0]), false);</span><br><span class="line">      message[&quot;ssl_session_id&quot;] &#x3D; getSslSessionId(args[0]);</span><br><span class="line">      message[&quot;function&quot;] &#x3D; &quot;SSL_write&quot;;</span><br><span class="line">      message[&quot;stack&quot;] &#x3D; SSLstackwrite;</span><br><span class="line">      send(message, Memory.readByteArray(args[1], parseInt(args[2])));</span><br><span class="line">    &#125;,</span><br><span class="line">    onLeave: function (retval) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">if (Java.available) &#123;</span><br><span class="line">  Java.perform(function () &#123;</span><br><span class="line">    function storeP12(pri, p7, p12Path, p12Password) &#123;</span><br><span class="line">      var X509Certificate &#x3D; Java.use(&quot;java.security.cert.X509Certificate&quot;)</span><br><span class="line">      var p7X509 &#x3D; Java.cast(p7, X509Certificate);</span><br><span class="line">      var chain &#x3D; Java.array(&quot;java.security.cert.X509Certificate&quot;, [p7X509])</span><br><span class="line">      var ks &#x3D; Java.use(&quot;java.security.KeyStore&quot;).getInstance(&quot;PKCS12&quot;, &quot;BC&quot;);</span><br><span class="line">      ks.load(null, null);</span><br><span class="line">      ks.setKeyEntry(&quot;client&quot;, pri, Java.use(&#39;java.lang.String&#39;).$new(p12Password).toCharArray(), chain);</span><br><span class="line">      try &#123;</span><br><span class="line">        var out &#x3D; Java.use(&quot;java.io.FileOutputStream&quot;).$new(p12Path);</span><br><span class="line">        ks.store(out, Java.use(&#39;java.lang.String&#39;).$new(p12Password).toCharArray())</span><br><span class="line">      &#125; catch (exp) &#123;</span><br><span class="line">        console.log(exp)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;在服务器校验客户端的情形下，帮助dump客户端证书，并保存为p12的格式，证书密码为r0ysue</span><br><span class="line">    Java.use(&quot;java.security.KeyStore$PrivateKeyEntry&quot;).getPrivateKey.implementation &#x3D; function () &#123;</span><br><span class="line">      var result &#x3D; this.getPrivateKey()</span><br><span class="line">      var packageName &#x3D; Java.use(&quot;android.app.ActivityThread&quot;).currentApplication().getApplicationContext().getPackageName();</span><br><span class="line">      storeP12(this.getPrivateKey(), this.getCertificate(), &#39;&#x2F;sdcard&#x2F;Download&#x2F;&#39; + packageName + uuid(10, 16) + &#39;.p12&#39;, &#39;r0ysue&#39;);</span><br><span class="line">      var message &#x3D; &#123;&#125;;</span><br><span class="line">      message[&quot;function&quot;] &#x3D; &quot;dumpClinetCertificate&#x3D;&gt;&quot; + &#39;&#x2F;sdcard&#x2F;Download&#x2F;&#39; + packageName + uuid(10, 16) + &#39;.p12&#39; + &#39;   pwd: r0ysue&#39;;</span><br><span class="line">      message[&quot;stack&quot;] &#x3D; Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new());</span><br><span class="line">      var data &#x3D; Memory.alloc(1);</span><br><span class="line">      send(message, Memory.readByteArray(data, 1))</span><br><span class="line">      return result;</span><br><span class="line">    &#125;</span><br><span class="line">    Java.use(&quot;java.security.KeyStore$PrivateKeyEntry&quot;).getCertificateChain.implementation &#x3D; function () &#123;</span><br><span class="line">      var result &#x3D; this.getCertificateChain()</span><br><span class="line">      var packageName &#x3D; Java.use(&quot;android.app.ActivityThread&quot;).currentApplication().getApplicationContext().getPackageName();</span><br><span class="line">      storeP12(this.getPrivateKey(), this.getCertificate(), &#39;&#x2F;sdcard&#x2F;Download&#x2F;&#39; + packageName + uuid(10, 16) + &#39;.p12&#39;, &#39;r0ysue&#39;);</span><br><span class="line">      var message &#x3D; &#123;&#125;;</span><br><span class="line">      message[&quot;function&quot;] &#x3D; &quot;dumpClinetCertificate&#x3D;&gt;&quot; + &#39;&#x2F;sdcard&#x2F;Download&#x2F;&#39; + packageName + uuid(10, 16) + &#39;.p12&#39; + &#39;   pwd: r0ysue&#39;;</span><br><span class="line">      message[&quot;stack&quot;] &#x3D; Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new());</span><br><span class="line">      var data &#x3D; Memory.alloc(1);</span><br><span class="line">      send(message, Memory.readByteArray(data, 1))</span><br><span class="line">      return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;SSLpinning helper 帮助定位证书绑定的关键代码</span><br><span class="line">    Java.use(&quot;java.io.File&quot;).$init.overload(&#39;java.io.File&#39;, &#39;java.lang.String&#39;).implementation &#x3D; function (file, cert) &#123;</span><br><span class="line">      var result &#x3D; this.$init(file, cert)</span><br><span class="line">      var stack &#x3D; Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new());</span><br><span class="line">      if (file.getPath().indexOf(&quot;cacert&quot;) &gt;&#x3D; 0 &amp;&amp; stack.indexOf(&quot;X509TrustManagerExtensions.checkServerTrusted&quot;) &gt;&#x3D; 0) &#123;</span><br><span class="line">        var message &#x3D; &#123;&#125;;</span><br><span class="line">        message[&quot;function&quot;] &#x3D; &quot;SSLpinning position locator &#x3D;&gt; &quot; + file.getPath() + &quot; &quot; + cert;</span><br><span class="line">        message[&quot;stack&quot;] &#x3D; stack;</span><br><span class="line">        var data &#x3D; Memory.alloc(1);</span><br><span class="line">        send(message, Memory.readByteArray(data, 1))</span><br><span class="line">      &#125;</span><br><span class="line">      return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Java.use(&quot;java.net.SocketOutputStream&quot;).socketWrite0.overload(&#39;java.io.FileDescriptor&#39;, &#39;[B&#39;, &#39;int&#39;, &#39;int&#39;).implementation &#x3D; function (fd, bytearry, offset, byteCount) &#123;</span><br><span class="line">      var result &#x3D; this.socketWrite0(fd, bytearry, offset, byteCount);</span><br><span class="line">      var message &#x3D; &#123;&#125;;</span><br><span class="line">      message[&quot;function&quot;] &#x3D; &quot;HTTP_send&quot;;</span><br><span class="line">      message[&quot;ssl_session_id&quot;] &#x3D; &quot;&quot;;</span><br><span class="line">      message[&quot;src_addr&quot;] &#x3D; ntohl(ipToNumber((this.socket.value.getLocalAddress().toString().split(&quot;:&quot;)[0]).split(&quot;&#x2F;&quot;).pop()));</span><br><span class="line">      message[&quot;src_port&quot;] &#x3D; parseInt(this.socket.value.getLocalPort().toString());</span><br><span class="line">      message[&quot;dst_addr&quot;] &#x3D; ntohl(ipToNumber((this.socket.value.getRemoteSocketAddress().toString().split(&quot;:&quot;)[0]).split(&quot;&#x2F;&quot;).pop()));</span><br><span class="line">      message[&quot;dst_port&quot;] &#x3D; parseInt(this.socket.value.getRemoteSocketAddress().toString().split(&quot;:&quot;).pop());</span><br><span class="line">      message[&quot;stack&quot;] &#x3D; Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new()).toString();</span><br><span class="line">      var ptr &#x3D; Memory.alloc(byteCount);</span><br><span class="line">      for (var i &#x3D; 0; i &lt; byteCount; ++i)</span><br><span class="line">        Memory.writeS8(ptr.add(i), bytearry[offset + i]);</span><br><span class="line">      send(message, Memory.readByteArray(ptr, byteCount))</span><br><span class="line">      return result;</span><br><span class="line">    &#125;</span><br><span class="line">    Java.use(&quot;java.net.SocketInputStream&quot;).socketRead0.overload(&#39;java.io.FileDescriptor&#39;, &#39;[B&#39;, &#39;int&#39;, &#39;int&#39;, &#39;int&#39;).implementation &#x3D; function (fd, bytearry, offset, byteCount, timeout) &#123;</span><br><span class="line">      var result &#x3D; this.socketRead0(fd, bytearry, offset, byteCount, timeout);</span><br><span class="line">      var message &#x3D; &#123;&#125;;</span><br><span class="line">      message[&quot;function&quot;] &#x3D; &quot;HTTP_recv&quot;;</span><br><span class="line">      message[&quot;ssl_session_id&quot;] &#x3D; &quot;&quot;;</span><br><span class="line">      message[&quot;src_addr&quot;] &#x3D; ntohl(ipToNumber((this.socket.value.getRemoteSocketAddress().toString().split(&quot;:&quot;)[0]).split(&quot;&#x2F;&quot;).pop()));</span><br><span class="line">      message[&quot;src_port&quot;] &#x3D; parseInt(this.socket.value.getRemoteSocketAddress().toString().split(&quot;:&quot;).pop());</span><br><span class="line">      message[&quot;dst_addr&quot;] &#x3D; ntohl(ipToNumber((this.socket.value.getLocalAddress().toString().split(&quot;:&quot;)[0]).split(&quot;&#x2F;&quot;).pop()));</span><br><span class="line">      message[&quot;dst_port&quot;] &#x3D; parseInt(this.socket.value.getLocalPort());</span><br><span class="line">      message[&quot;stack&quot;] &#x3D; Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new()).toString();</span><br><span class="line">      if (result &gt; 0) &#123;</span><br><span class="line">        var ptr &#x3D; Memory.alloc(result);</span><br><span class="line">        for (var i &#x3D; 0; i &lt; result; ++i)</span><br><span class="line">          Memory.writeS8(ptr.add(i), bytearry[offset + i]);</span><br><span class="line">        send(message, Memory.readByteArray(ptr, result))</span><br><span class="line">      &#125;</span><br><span class="line">      return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (parseFloat(Java.androidVersion)  &gt; 8) &#123;</span><br><span class="line">      Java.use(&quot;com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLOutputStream&quot;).write.overload(&#39;[B&#39;, &#39;int&#39;, &#39;int&#39;).implementation &#x3D; function (bytearry, int1, int2) &#123;</span><br><span class="line">        var result &#x3D; this.write(bytearry, int1, int2);</span><br><span class="line">        SSLstackwrite &#x3D; Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new()).toString();</span><br><span class="line">        return result;</span><br><span class="line">      &#125;</span><br><span class="line">      Java.use(&quot;com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLInputStream&quot;).read.overload(&#39;[B&#39;, &#39;int&#39;, &#39;int&#39;).implementation &#x3D; function (bytearry, int1, int2) &#123;</span><br><span class="line">        var result &#x3D; this.read(bytearry, int1, int2);</span><br><span class="line">        SSLstackread &#x3D; Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new()).toString();</span><br><span class="line">        return result;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">      Java.use(&quot;com.android.org.conscrypt.OpenSSLSocketImpl$SSLOutputStream&quot;).write.overload(&#39;[B&#39;, &#39;int&#39;, &#39;int&#39;).implementation &#x3D; function (bytearry, int1, int2) &#123;</span><br><span class="line">        var result &#x3D; this.write(bytearry, int1, int2);</span><br><span class="line">        SSLstackwrite &#x3D; Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new()).toString();</span><br><span class="line">        return result;</span><br><span class="line">      &#125;</span><br><span class="line">      Java.use(&quot;com.android.org.conscrypt.OpenSSLSocketImpl$SSLInputStream&quot;).read.overload(&#39;[B&#39;, &#39;int&#39;, &#39;int&#39;).implementation &#x3D; function (bytearry, int1, int2) &#123;</span><br><span class="line">        var result &#x3D; this.read(bytearry, int1, int2);</span><br><span class="line">        SSLstackread &#x3D; Java.use(&quot;android.util.Log&quot;).getStackTraceString(Java.use(&quot;java.lang.Throwable&quot;).$new()).toString();</span><br><span class="line">        return result;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>python r0capture.py -U -f com.qiyi.video -p iqiyi.pcap</p><ul><li><a href="https://mp.weixin.qq.com/s/UixExZkPWHJAT3jAD2sJJg" target="_blank" rel="noopener">某抢票app逆向续篇之干掉vpn抓包检测</a></li><li><a href="https://www.cnblogs.com/c-x-a/p/9174663.html" target="_blank" rel="noopener">Android 开发之避免被第三方使用代理抓包</a></li><li><a href="https://bbs.pediy.com/thread-223460.htm" target="_blank" rel="noopener">【SO壳】17种安卓native反调试收集</a></li><li><a href="https://www.jianshu.com/p/87ce6f565d37" target="_blank" rel="noopener">Android JNI(一)——NDK与JNI基础</a></li></ul><h1 id="网络通讯协议分析"><a href="#网络通讯协议分析" class="headerlink" title="网络通讯协议分析"></a>网络通讯协议分析</h1><h2 id="Java层"><a href="#Java层" class="headerlink" title="Java层"></a>Java层</h2><h3 id="socket抓包"><a href="#socket抓包" class="headerlink" title="socket抓包"></a>socket抓包</h3><p><strong>okhttp2.6项目启动tcp服务器</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i any -s 0 -w &#x2F;sdcard&#x2F;1.pcap 抓tcp包</span><br></pre></td></tr></table></figure><p>java.net.Socket类构造函数：new Socket(ip,port)-&gt;Socket(InetAddress[] addresses, int port, SocketAddress localAddr, boolean stream)</p><p>​ -&gt;impl java.net.SocksSocketImpl</p><p>建立连接：connect(SocketAddress endpoint)</p><p>接收数据：java,net.SocketInputStream.read(byte[])-&gt;read(b,0,b.length)-&gt;read(b,off,length,impl.getTimeout())-&gt;socketRead(fd,b,off,length,timeout)-&gt;socketRead0(fd,b,off,length,timeout)(jni函数)</p><p>发送数据：java.net.SocketOutputStream.write(byte[])-&gt;socketWrite(b,0,b.length)-&gt;socketWrite0(fd,b,off,len)-&gt;private native void socketWrite0(FileDescriptor fd,byte[] b,int off,int len) throws IOException</p><p>frida -UF -l hooktcp.js –no-pause</p><p>frida -U -f com.example.okhttp -l hooktcp.js –no-pause -o tcp.log</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">function LogPrint(log) &#123;</span><br><span class="line">    var theDate &#x3D; new Date();</span><br><span class="line">    var hour &#x3D; theDate.getHours();</span><br><span class="line">    var minute &#x3D; theDate.getMinutes();</span><br><span class="line">    var second &#x3D; theDate.getSeconds();</span><br><span class="line">    var mSecond &#x3D; theDate.getMilliseconds();</span><br><span class="line"></span><br><span class="line">    hour &lt; 10 ? hour &#x3D; &quot;0&quot; + hour : hour;</span><br><span class="line">    minute &lt; 10 ? minute &#x3D; &quot;0&quot; + minute : minute;</span><br><span class="line">    second &lt; 10 ? second &#x3D; &quot;0&quot; + second : second;</span><br><span class="line">    mSecond &lt; 10 ? mSecond &#x3D; &quot;00&quot; + mSecond : mSecond &lt; 100 ? mSecond &#x3D; &quot;0&quot; + mSecond : mSecond;</span><br><span class="line">    var time &#x3D; hour + &quot;:&quot; + minute + &quot;:&quot; + second + &quot;:&quot; + mSecond;</span><br><span class="line">    var threadid &#x3D; Process.getCurrentThreadId();</span><br><span class="line">    console.log(&quot;[&quot; + time + &quot;]&quot; + &quot;-&gt;threadid:&quot; + threadid + &quot;--&quot; + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function printJavaStack(name) &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        var Exception &#x3D; Java.use(&quot;java.lang.Exception&quot;);</span><br><span class="line">        var ins &#x3D; Exception.$new(&quot;Exception&quot;);</span><br><span class="line">        var straces &#x3D; ins.getStackTrace();</span><br><span class="line">        if (straces !&#x3D; undefined &amp;&amp; straces !&#x3D; null) &#123;</span><br><span class="line">            var strace &#x3D; straces.toString();</span><br><span class="line">            var replaceStr &#x3D; strace.replace(&#x2F;,&#x2F;g, &quot; \n &quot;);</span><br><span class="line">            LogPrint(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot; + name + &quot; Stack strat&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;);</span><br><span class="line">            LogPrint(replaceStr);</span><br><span class="line">            LogPrint(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot; + name + &quot; Stack end&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n &quot;);</span><br><span class="line">            Exception.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 可以打印ascii码 </span><br><span class="line">function isprintable(value) &#123;</span><br><span class="line">    if (value &gt;&#x3D; 32 &amp;&amp; value &lt;&#x3D; 126) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function hooktcp() &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        var SocketClass &#x3D; Java.use(&#39;java.net.Socket&#39;);</span><br><span class="line">        SocketClass.$init.overload(&#39;java.lang.String&#39;, &#39;int&#39;).implementation &#x3D; function (arg0, arg1) &#123;</span><br><span class="line">            console.log(&quot;[&quot; + Process.getCurrentThreadId() + &quot;]new Socket connection:&quot; + arg0 + &quot;,port:&quot; + arg1);</span><br><span class="line">            printJavaStack(&#39;tcp connect...&#39;)</span><br><span class="line">            return this.$init(arg0, arg1);</span><br><span class="line">        &#125;</span><br><span class="line">        var SocketInputStreamClass &#x3D; Java.use(&#39;java.net.SocketInputStream&#39;);</span><br><span class="line">        &#x2F;&#x2F;socketRead0</span><br><span class="line">        SocketInputStreamClass.socketRead0.implementation &#x3D; function (arg0, arg1, arg2, arg3, arg4) &#123;</span><br><span class="line">            var size &#x3D; this.socketRead0(arg0, arg1, arg2, arg3, arg4);</span><br><span class="line">            &#x2F;&#x2F;console.log(&quot;[&quot; + Process.getCurrentThreadId() + &quot;]socketRead0:size:&quot; + size + &quot;,content:&quot; + JSON.stringify(arg1));</span><br><span class="line">            var bytearray &#x3D; Java.array(&#39;byte&#39;, arg1);</span><br><span class="line">            var content &#x3D; &#39;&#39;;</span><br><span class="line">            for (var i &#x3D; 0; i &lt; size; i++) &#123;</span><br><span class="line">                if (isprintable(bytearray[i])) &#123;</span><br><span class="line">                    content &#x3D; content + String.fromCharCode(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            var socketimpl &#x3D; this.impl.value;</span><br><span class="line">            var address &#x3D; socketimpl.address.value;</span><br><span class="line">            var port &#x3D; socketimpl.port.value;</span><br><span class="line"></span><br><span class="line">            console.log(&quot;\naddress:&quot; + address + &quot;,port&quot; + port + &quot;\n&quot; + JSON.stringify(this.socket.value) + &quot;\n[&quot; + Process.getCurrentThreadId() + &quot;]receive:&quot; + content);</span><br><span class="line">            printJavaStack(&#39;socketRead0&#39;)</span><br><span class="line">            return size;</span><br><span class="line">        &#125;</span><br><span class="line">        var SocketOutPutStreamClass &#x3D; Java.use(&#39;java.net.SocketOutputStream&#39;);</span><br><span class="line">        SocketOutPutStreamClass.socketWrite0.implementation &#x3D; function (arg0, arg1, arg2, arg3) &#123;</span><br><span class="line">            var result &#x3D; this.socketWrite0(arg0, arg1, arg2, arg3);</span><br><span class="line">            &#x2F;&#x2F;console.log(&quot;[&quot; + Process.getCurrentThreadId() + &quot;]socketWrite0:len:&quot; + arg3 + &quot;--content:&quot; + JSON.stringify(arg1));</span><br><span class="line">            var bytearray &#x3D; Java.array(&#39;byte&#39;, arg1);</span><br><span class="line">            var content &#x3D; &#39;&#39;;</span><br><span class="line">            for (var i &#x3D; 0; i &lt; arg3; i++) &#123;</span><br><span class="line"></span><br><span class="line">                if (isprintable(bytearray[i])) &#123;</span><br><span class="line">                    content &#x3D; content + String.fromCharCode(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            var socketimpl &#x3D; this.impl.value;</span><br><span class="line">            var address &#x3D; socketimpl.address.value;</span><br><span class="line">            var port &#x3D; socketimpl.port.value;</span><br><span class="line">            console.log(&quot;send address:&quot; + address + &quot;,port&quot; + port + &quot;[&quot; + Process.getCurrentThreadId() + &quot;]send:&quot; + content);</span><br><span class="line">            console.log(&quot;\n&quot; + JSON.stringify(this.socket.value) + &quot;\n[&quot; + Process.getCurrentThreadId() + &quot;]send:&quot; + content);</span><br><span class="line">            printJavaStack(&#39;socketWrite0&#39;)</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function main() &#123;</span><br><span class="line">    hooktcp();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure><p><strong>okhttp2.6项目启动udp服务器</strong></p><p>java.net.DatagramSocket-&gt;receive</p><p>​ -&gt; <a href="http://androidxref.com/8.1.0_r33/xref/libcore/ojluni/src/main/java/java/net/PlainDatagramSocketImpl.java" target="_blank" rel="noopener">PlainDatagramSocketImpl</a></p><p>发送数据：<a href="http://androidxref.com/8.1.0_r33/xref/libcore/ojluni/src/main/java/java/net/PlainDatagramSocketImpl.java" target="_blank" rel="noopener">PlainDatagramSocketImpl</a>-&gt;send IoBridge.sendto(fd, p.getData(), p.getOffset(), p.getLength(), 0, address, port</p><p><a href="http://androidxref.com/8.1.0_r33/xref/libcore/luni/src/main/java/libcore/" target="_blank" rel="noopener">libcore</a>/<a href="http://androidxref.com/8.1.0_r33/xref/libcore/luni/src/main/java/libcore/io/" target="_blank" rel="noopener">io</a>/<a href="http://androidxref.com/8.1.0_r33/xref/libcore/luni/src/main/java/libcore/io/BlockGuardOs.java" target="_blank" rel="noopener">BlockGuardOs</a>.sendto</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">294    @Override public int sendto(FileDescriptor fd, ByteBuffer buffer, int flags, InetAddress inetAddress, int port) throws ErrnoException, SocketException &#123;</span><br><span class="line">295        BlockGuard.getThreadPolicy().onNetwork();</span><br><span class="line">296        return os.sendto(fd, buffer, flags, inetAddress, port);</span><br><span class="line">297    &#125;</span><br><span class="line">298</span><br><span class="line">299    @Override public int sendto(FileDescriptor fd, byte[] bytes, int byteOffset, int byteCount, int flags, InetAddress inetAddress, int port) throws ErrnoException, SocketException &#123;</span><br><span class="line">300        &#x2F;&#x2F; We permit datagrams without hostname lookups.</span><br><span class="line">301        if (inetAddress !&#x3D; null) &#123;</span><br><span class="line">302            BlockGuard.getThreadPolicy().onNetwork();</span><br><span class="line">303        &#125;</span><br><span class="line">304        return os.sendto(fd, bytes, byteOffset, byteCount, flags, inetAddress, port);</span><br><span class="line">305    &#125;</span><br></pre></td></tr></table></figure><p><a href="http://androidxref.com/8.1.0_r33/xref/libcore/luni/src/main/java/libcore/" target="_blank" rel="noopener">libcore</a>/<a href="http://androidxref.com/8.1.0_r33/xref/libcore/luni/src/main/java/libcore/io/" target="_blank" rel="noopener">io</a>/<a href="http://androidxref.com/8.1.0_r33/xref/libcore/luni/src/main/java/libcore/io/Linux.java" target="_blank" rel="noopener">Linux.java</a>.sendto</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">212    public int sendto(FileDescriptor fd, ByteBuffer buffer, int flags, InetAddress inetAddress, int port) throws ErrnoException, SocketException &#123;</span><br><span class="line">213        final int bytesSent;</span><br><span class="line">214        final int position &#x3D; buffer.position();</span><br><span class="line">215</span><br><span class="line">216        if (buffer.isDirect()) &#123;</span><br><span class="line">217            bytesSent &#x3D; sendtoBytes(fd, buffer, position, buffer.remaining(), flags, inetAddress, port);</span><br><span class="line">218        &#125; else &#123;</span><br><span class="line">219            bytesSent &#x3D; sendtoBytes(fd, NioUtils.unsafeArray(buffer), NioUtils.unsafeArrayOffset(buffer) + position, buffer.remaining(), flags, inetAddress, port);</span><br><span class="line">220        &#125;</span><br><span class="line">221</span><br><span class="line">222        maybeUpdateBufferPosition(buffer, position, bytesSent);</span><br><span class="line">223        return bytesSent;</span><br><span class="line">224    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">232    private native int sendtoBytes(FileDescriptor fd, Object buffer, int byteOffset, int byteCount, int flags, InetAddress inetAddress, int port) throws ErrnoException, SocketException;</span><br><span class="line">233    private native int sendtoBytes(FileDescriptor fd, Object buffer, int byteOffset, int byteCount, int flags, SocketAddress address) throws ErrnoException, SocketException;</span><br></pre></td></tr></table></figure><p>接受udp数据</p><p><a href="http://androidxref.com/8.1.0_r33/xref/libcore/luni/src/main/java/libcore/" target="_blank" rel="noopener">libcore</a>/<a href="http://androidxref.com/8.1.0_r33/xref/libcore/luni/src/main/java/libcore/io/" target="_blank" rel="noopener">io</a>/<a href="http://androidxref.com/8.1.0_r33/xref/libcore/luni/src/main/java/libcore/io/Linux.java" target="_blank" rel="noopener">Linux.java</a>.read</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">169    public int read(FileDescriptor fd, ByteBuffer buffer) throws ErrnoException, InterruptedIOException &#123;</span><br><span class="line">170        final int bytesRead;</span><br><span class="line">171        final int position &#x3D; buffer.position();</span><br><span class="line">172</span><br><span class="line">173        if (buffer.isDirect()) &#123;</span><br><span class="line">174            bytesRead &#x3D; readBytes(fd, buffer, position, buffer.remaining());</span><br><span class="line">175        &#125; else &#123;</span><br><span class="line">176            bytesRead &#x3D; readBytes(fd, NioUtils.unsafeArray(buffer), NioUtils.unsafeArrayOffset(buffer) + position, buffer.remaining());</span><br><span class="line">177        &#125;</span><br><span class="line">178</span><br><span class="line">179        maybeUpdateBufferPosition(buffer, position, bytesRead);</span><br><span class="line">180        return bytesRead;</span><br><span class="line">181    &#125;</span><br><span class="line">186    private native int readBytes(FileDescriptor fd, Object buffer, int offset, int byteCount) throws ErrnoException, InterruptedIOException;</span><br><span class="line">207    private native int recvfromBytes(FileDescriptor fd, Object buffer, int byteOffset, int byteCount, int flags, InetSocketAddress srcAddress) throws ErrnoException, SocketException;</span><br></pre></td></tr></table></figure><p>frida -U -f com.example.okhttp -l hookudp.js –no-pause -o udp.log</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">function LogPrint(log) &#123;</span><br><span class="line">    var theDate &#x3D; new Date();</span><br><span class="line">    var hour &#x3D; theDate.getHours();</span><br><span class="line">    var minute &#x3D; theDate.getMinutes();</span><br><span class="line">    var second &#x3D; theDate.getSeconds();</span><br><span class="line">    var mSecond &#x3D; theDate.getMilliseconds();</span><br><span class="line"></span><br><span class="line">    hour &lt; 10 ? hour &#x3D; &quot;0&quot; + hour : hour;</span><br><span class="line">    minute &lt; 10 ? minute &#x3D; &quot;0&quot; + minute : minute;</span><br><span class="line">    second &lt; 10 ? second &#x3D; &quot;0&quot; + second : second;</span><br><span class="line">    mSecond &lt; 10 ? mSecond &#x3D; &quot;00&quot; + mSecond : mSecond &lt; 100 ? mSecond &#x3D; &quot;0&quot; + mSecond : mSecond;</span><br><span class="line">    var time &#x3D; hour + &quot;:&quot; + minute + &quot;:&quot; + second + &quot;:&quot; + mSecond;</span><br><span class="line">    var threadid &#x3D; Process.getCurrentThreadId();</span><br><span class="line">    console.log(&quot;[&quot; + time + &quot;]&quot; + &quot;-&gt;threadid:&quot; + threadid + &quot;--&quot; + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function printJavaStack(name) &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        var Exception &#x3D; Java.use(&quot;java.lang.Exception&quot;);</span><br><span class="line">        var ins &#x3D; Exception.$new(&quot;Exception&quot;);</span><br><span class="line">        var straces &#x3D; ins.getStackTrace();</span><br><span class="line">        if (straces !&#x3D; undefined &amp;&amp; straces !&#x3D; null) &#123;</span><br><span class="line">            var strace &#x3D; straces.toString();</span><br><span class="line">            var replaceStr &#x3D; strace.replace(&#x2F;,&#x2F;g, &quot; \n &quot;);</span><br><span class="line">            LogPrint(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot; + name + &quot; Stack strat&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;);</span><br><span class="line">            LogPrint(replaceStr);</span><br><span class="line">            LogPrint(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot; + name + &quot; Stack end&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n &quot;);</span><br><span class="line">            Exception.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function isprintable(value) &#123;</span><br><span class="line">    if (value &gt;&#x3D; 32 &amp;&amp; value &lt;&#x3D; 126) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function hookudp() &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        var LinuxClass &#x3D; Java.use(&#39;libcore.io.Linux&#39;);</span><br><span class="line">        &#x2F;&#x2F;  private native int recvfromBytes(FileDescriptor fd, Object buffer, int byteOffset, int byteCount, int flags, InetSocketAddress srcAddress) throws ErrnoException, SocketException;  </span><br><span class="line">        LinuxClass.recvfromBytes.implementation &#x3D; function (arg0, arg1, arg2, arg3, arg4, arg5) &#123;</span><br><span class="line">            var size &#x3D; this.recvfromBytes(arg0, arg1, arg2, arg3, arg4, arg5);</span><br><span class="line">            var bytearray &#x3D; Java.array(&#39;byte&#39;,arg1);</span><br><span class="line">            var content &#x3D; &quot;&quot;;</span><br><span class="line">            for(var i&#x3D;0;i&lt;size;i++) &#123;</span><br><span class="line">                content&#x3D;content+String.fromCharCode(bytearray[i])</span><br><span class="line">            &#125;</span><br><span class="line">            console.log(&quot;address:&quot;+arg5+[&quot; + Process.getCurrentThreadId() + &quot;]recvfromBytes:size:&quot; + size + &quot;,content:&quot; + JSON.stringify(arg1)+&quot;--content:&quot;+content);</span><br><span class="line">             </span><br><span class="line">            printJavaStack(&#39;recvfromBytes&#39;)</span><br><span class="line">            return size;</span><br><span class="line">        &#125;        </span><br><span class="line">        LinuxClass.sendtoBytes.overload(&#39;java.io.FileDescriptor&#39;,&#39;java.lang.Object&#39;,&#39;int&#39;,&#39;int&#39;,&#39;int&#39;,&#39;java.net.SocketAddress&#39;,&#39;int&#39;).implementation &#x3D; function (arg0, arg1, arg2, arg3, arg4, arg5, arg6) &#123;</span><br><span class="line">            var size &#x3D; this.sendtoBytes(arg0, arg1, arg2, arg3, arg4, arg5, arg6);</span><br><span class="line">            var bytearray &#x3D; Java.array(&#39;byte&#39;,arg1);</span><br><span class="line">            var content &#x3D; &quot;&quot;;</span><br><span class="line">            for(var i&#x3D;0;i&lt;size;i++) &#123;</span><br><span class="line">                content&#x3D;content+String.fromCharCode(bytearray[i])</span><br><span class="line">            &#125;</span><br><span class="line">            console.log(&quot;address:&quot;+arg5+&quot;port:&quot;+arg6+[&quot; + Process.getCurrentThreadId() + &quot;]sendtoBytes1:len:&quot; + size + &quot;--content:&quot; + JSON.stringify(arg1)+&quot;--content:&quot;+content);</span><br><span class="line">           </span><br><span class="line">            printJavaStack(&#39;sendtoBytes1&#39;)</span><br><span class="line">            return size;</span><br><span class="line">        &#125;</span><br><span class="line">        LinuxClass.sendtoBytes.overload(&#39;java.io.FileDescriptor&#39;,&#39;java.lang.Object&#39;,&#39;int&#39;,&#39;int&#39;,&#39;int&#39;,&#39;java.net.SocketAddress&#39;).implementation &#x3D; function (arg0, arg1, arg2, arg3, arg4, arg5) &#123;</span><br><span class="line">            var size &#x3D; this.sendtoBytes(arg0, arg1, arg2, arg3, arg4, arg5, arg6);</span><br><span class="line">            var bytearray &#x3D; Java.array(&#39;byte&#39;,arg1);</span><br><span class="line">            var content &#x3D; &quot;&quot;;</span><br><span class="line">            for(var i&#x3D;0;i&lt;size;i++) &#123;</span><br><span class="line">                content&#x3D;content+String.fromCharCode(bytearray[i])</span><br><span class="line">            &#125;</span><br><span class="line">            console.log(&quot;address:&quot;+arg5+&quot;[&quot; + Process.getCurrentThreadId() + &quot;]sendtoBytes2:len:&quot; + size + &quot;--content:&quot; + JSON.stringify(arg1)+&quot;--content:&quot;+content);</span><br><span class="line">           </span><br><span class="line">            printJavaStack(&#39;sendtoBytes2&#39;)</span><br><span class="line">            return size;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function main() &#123;</span><br><span class="line">    hookudp();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure><h3 id="ssl抓包"><a href="#ssl抓包" class="headerlink" title="ssl抓包"></a>ssl抓包</h3><p>sslSocket-&gt;com.android.org.conscrypt.OpenSSLSocketImplWrapper</p><p>发送数据:com.android.org.conscrypt.OpenSSLSocketImpl$SSLOutputStream</p><p>​ public void write(int oneByte)</p><p>​ public void write(byte[] buf, int offset, int byteCount)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">807                NativeCrypto.SSL_write(sslNativePointer, Platform.getFileDescriptor(socket),</span><br><span class="line">808                        OpenSSLSocketImpl.this, buf, offset, byteCount, writeTimeoutMilliseconds);</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1039    public static native void SSL_write(long sslNativePointer,</span><br><span class="line">1040                                        FileDescriptor fd,</span><br><span class="line">1041                                        SSLHandshakeCallbacks shc,</span><br><span class="line">1042                                        byte[] b, int off, int len, int writeTimeoutMillis)</span><br></pre></td></tr></table></figure><p>接收数据:com.android.org.conscrypt.OpenSSLSocketImpl$SSLInputStream</p><p>​ public int read()</p><p>​ public int read(byte[] buf, int offset, int byteCount)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1030    public static native int SSL_read(long sslNativePointer,</span><br><span class="line">1031                                      FileDescriptor fd,</span><br><span class="line">1032                                      SSLHandshakeCallbacks shc,</span><br><span class="line">1033                                      byte[] b, int off, int len, int readTimeoutMillis)</span><br></pre></td></tr></table></figure><p>frida -UF -l hook.js –no-pause</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">function hookssl() &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        var NativeCrypto &#x3D; Java.use(&#39;com.android.org.conscrypt.NativeCrypto&#39;);</span><br><span class="line">        NativeCrypto.SSL_read.implementation &#x3D; function (arg0, arg1, arg2, arg3, arg4, arg5, arg6) &#123;</span><br><span class="line">            var size &#x3D; this.SSL_read(arg0, arg1, arg2, arg3, arg4, arg5, arg6);</span><br><span class="line">            var bytearray &#x3D; Java.array(&#39;byte&#39;,arg3);</span><br><span class="line">            var content &#x3D; &quot;&quot;;</span><br><span class="line">            for(var i&#x3D;0;i&lt;size;i++) &#123;</span><br><span class="line">                content&#x3D;content+String.fromCharCode(bytearray[i])</span><br><span class="line">            &#125;</span><br><span class="line">            console.log(&quot;\n[&quot; + Process.getCurrentThreadId() +&quot;]ssl receive content:&quot;+content);</span><br><span class="line">             </span><br><span class="line">            printJavaStack(&#39;NativeCrypto.read&#39;)</span><br><span class="line">            return size;</span><br><span class="line">        &#125;        </span><br><span class="line">        </span><br><span class="line">        NativeCrypto.SSL_write.implementation &#x3D; function (arg0, arg1, arg2, arg3, arg4, arg5, arg6) &#123;</span><br><span class="line">            var result &#x3D; this.SSL_write(arg0, arg1, arg2, arg3, arg4, arg5, arg6);</span><br><span class="line">            var bytearray &#x3D; Java.array(&#39;byte&#39;, arg3);</span><br><span class="line">            var content &#x3D; &#39;&#39;;</span><br><span class="line">            for (var i &#x3D; 0; i &lt; arg5; i++) &#123;</span><br><span class="line"></span><br><span class="line">                if (isprintable(bytearray[i])) &#123;</span><br><span class="line">                    content &#x3D; content + String.fromCharCode(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            console.log( &quot;\n[&quot; + Process.getCurrentThreadId() + &quot;]send:&quot; + content);</span><br><span class="line">            printJavaStack(&#39;SSL_write&#39;)</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">function enumerate() &#123;</span><br><span class="line">  Java.perform(function()&#123;</span><br><span class="line">    Java.enumerateLoadedClassesSync().forEach(function(classname)&#123;</span><br><span class="line">      if(classname.indexof(&quot;NativeCrypto&quot;) &gt;&#x3D;0) &#123;</span><br><span class="line">        console.log(classname)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">function main() &#123;</span><br><span class="line">    enumerate();</span><br><span class="line">    hookssl();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure><p>不过确实对端的ip和端口，根据调用栈向上追溯一层到SSLOutputStream</p><p>frida -U -p 12345 -l hookssl2.js –no-pause -o log.txt 多进程hook</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">function hookssl2() &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        var SSLInputStreamClass &#x3D; Java.use(&#39;com.android.org.conscrypt.OpenSSLSocketImpl$SSLInputStream&#39;);</span><br><span class="line">        SSLInputStreamClass.read.overload(&#39;[B&#39;,&#39;int&#39;,&#39;int&#39;).implementation &#x3D; function (arg0, arg1, arg2) &#123;</span><br><span class="line">            &#x2F;&#x2F; 获取内部类</span><br><span class="line">            var SSLInputStreamObj&#x3D;this;</span><br><span class="line">            var OpenSSLSocketImplobj &#x3D; this.this.$0.value;</span><br><span class="line">            var socketobj &#x3D; OpenSSLSocketImplobj.socket.value;</span><br><span class="line">            var size &#x3D; this.SSL_read(arg0, arg1, arg2);</span><br><span class="line">            var bytearray &#x3D; Java.array(&#39;byte&#39;,arg0);</span><br><span class="line">            var content &#x3D; &quot;&quot;;</span><br><span class="line">            for(var i&#x3D;0;i&lt;size;i++) &#123;</span><br><span class="line">                content&#x3D;content+String.fromCharCode(bytearray[i])</span><br><span class="line">            &#125;</span><br><span class="line">            console.log(&quot;\naddress:&quot;+&quot;socketobj&quot;+&quot;-----[&quot; + Process.getCurrentThreadId() +&quot;]SSLInputStreamClass receive content:&quot;+content);</span><br><span class="line">             </span><br><span class="line">            printJavaStack(&#39;SSLInputStreamClass.read&#39;)</span><br><span class="line">            return size;</span><br><span class="line">        &#125;        </span><br><span class="line">        var SSLOutputStreamClass &#x3D; Java.use(&#39;com.android.org.conscrypt.OpenSSLSocketImpl$SSLOutputStream&#39;);</span><br><span class="line">        SSLOutputStreamClass.write.overload(&#39;[B&#39;,&#39;int&#39;,&#39;int&#39;).implementation &#x3D; function (arg0, arg1, arg2) &#123;</span><br><span class="line">            var SSLOutputStreamObj&#x3D;this;</span><br><span class="line">            var OpenSSLSocketImplobj &#x3D; this.this.$0.value;</span><br><span class="line">            var socketobj &#x3D; OpenSSLSocketImplobj.socket.value;</span><br><span class="line">            var result &#x3D; this.write(arg0, arg1, arg2);</span><br><span class="line">            var bytearray &#x3D; Java.array(&#39;byte&#39;, arg0);</span><br><span class="line">            var content &#x3D; &#39;&#39;;</span><br><span class="line">            for (var i &#x3D; 0; i &lt; arg2; i++) &#123;</span><br><span class="line"></span><br><span class="line">                if (isprintable(bytearray[i])) &#123;</span><br><span class="line">                    content &#x3D; content + String.fromCharCode(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            console.log(&quot;\naddress:&quot;+&quot;socketobj&quot;+&quot;-----[&quot; + Process.getCurrentThreadId() + &quot;]SSLOutputStreamClass send:&quot; + content);</span><br><span class="line">            printJavaStack(&#39;SSLOutputStreamClass.write&#39;)</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">function enumerate() &#123;</span><br><span class="line">  Java.perform(function()&#123;</span><br><span class="line">    Java.enumerateLoadedClassesSync().forEach(function(classname)&#123;</span><br><span class="line">      if(classname.indexof(&quot;OpenSSLSocketImpl&quot;) &gt;&#x3D;0) &#123;</span><br><span class="line">        console.log(classname)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">function main() &#123;</span><br><span class="line">    enumerate();</span><br><span class="line">    hookssl();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure><h2 id="jni层"><a href="#jni层" class="headerlink" title="jni层"></a>jni层</h2><p>如果没有使用java层的安卓系统函数将无法抓到，但是wireshark却可以抓到，可以深入jni层抓包</p><h3 id="socket抓包-1"><a href="#socket抓包-1" class="headerlink" title="socket抓包"></a>socket抓包</h3><p><strong>tcp native层</strong></p><p><a href="http://androidxref.com/8.0.0_r4/xref/libcore/ojluni/src/main/native/SocketOutputStream.c#55" target="_blank" rel="noopener">SocketOutputStream_socketWrite0</a>动态注册jni函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">adb pull &#x2F;system&#x2F;lib&#x2F;libopenjdk.so</span><br><span class="line">adb pull &#x2F;system&#x2F;lib64&#x2F;libopenjdk.so libopenjdk64.so </span><br><span class="line"></span><br><span class="line">libopenjdk.so - socketRead0</span><br><span class="line">	|</span><br><span class="line">	NET_Read</span><br><span class="line">			|</span><br><span class="line">			libc.so - recvfrom</span><br><span class="line">				|</span><br><span class="line">				系统调用(可以在自己的so中实现recvfrom，然后调用系统调用号)</span><br><span class="line">					|</span><br><span class="line">					内核</span><br><span class="line"></span><br><span class="line">libopenjdk.so - socketWrite0</span><br><span class="line">	|</span><br><span class="line">	NET_Send</span><br><span class="line">			|</span><br><span class="line">			libc.so - sendto</span><br><span class="line">				|</span><br><span class="line">				系统调用</span><br><span class="line">					|</span><br><span class="line">					内核</span><br></pre></td></tr></table></figure><p>将这两个so用ida打开搜索JNI_OnLoad，搜索导出函数中SocketInputStream</p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/image-20221003163522200.png" alt="image-20221003163522200"></p><p><img src="/2021/02/18/%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E4%B8%8Ehook/image-20221003164042119.png" alt="image-20221003164042119"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">socketRead0-&gt;NET_Read-&gt;libc.so系统调用ssize_t recvfrom(int fd, void *buf, size_ n, int flags, struct sockaddr *addr, socklen_t *addr_len);</span><br><span class="line">socketWrite0-&gt;NET_Send-&gt;libc.so系统调用ssize_t sendto(int fd, void *buf, size_ n, int flags,const struct sockaddr *addr, socklen_t *addr_len);</span><br></pre></td></tr></table></figure><p>frida -U -f com.example.okhttp -l hooklibc.js –no-pause</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">function LogPrint(log) &#123;</span><br><span class="line">    var theDate &#x3D; new Date();</span><br><span class="line">    var hour &#x3D; theDate.getHours();</span><br><span class="line">    var minute &#x3D; theDate.getMinutes();</span><br><span class="line">    var second &#x3D; theDate.getSeconds();</span><br><span class="line">    var mSecond &#x3D; theDate.getMilliseconds();</span><br><span class="line"></span><br><span class="line">    hour &lt; 10 ? hour &#x3D; &quot;0&quot; + hour : hour;</span><br><span class="line">    minute &lt; 10 ? minute &#x3D; &quot;0&quot; + minute : minute;</span><br><span class="line">    second &lt; 10 ? second &#x3D; &quot;0&quot; + second : second;</span><br><span class="line">    mSecond &lt; 10 ? mSecond &#x3D; &quot;00&quot; + mSecond : mSecond &lt; 100 ? mSecond &#x3D; &quot;0&quot; + mSecond : mSecond;</span><br><span class="line">    var time &#x3D; hour + &quot;:&quot; + minute + &quot;:&quot; + second + &quot;:&quot; + mSecond;</span><br><span class="line">    var threadid &#x3D; Process.getCurrentThreadId();</span><br><span class="line">    console.log(&quot;[&quot; + time + &quot;]&quot; + &quot;-&gt;threadid:&quot; + threadid + &quot;--&quot; + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function printNativeStack(context, name) &#123;</span><br><span class="line">    &#x2F;&#x2F;Debug.</span><br><span class="line">    var array &#x3D; Thread.backtrace(context, Backtracer.ACCURATE);</span><br><span class="line">    var first &#x3D; DebugSymbol.fromAddress(array[0]);</span><br><span class="line">    if (first.toString().indexOf(&#39;libopenjdk.so!NET_Send&#39;) &lt; 0) &#123;</span><br><span class="line">        var trace &#x3D; Thread.backtrace(context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(&quot;\n&quot;);</span><br><span class="line">        LogPrint(&quot;-----------start:&quot; + name + &quot;--------------&quot;);</span><br><span class="line">        LogPrint(trace);</span><br><span class="line">        LogPrint(&quot;-----------end:&quot; + name + &quot;--------------&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function printJavaStack(name) &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        var Exception &#x3D; Java.use(&quot;java.lang.Exception&quot;);</span><br><span class="line">        var ins &#x3D; Exception.$new(&quot;Exception&quot;);</span><br><span class="line">        var straces &#x3D; ins.getStackTrace();</span><br><span class="line">        if (straces !&#x3D; undefined &amp;&amp; straces !&#x3D; null) &#123;</span><br><span class="line">            var strace &#x3D; straces.toString();</span><br><span class="line">            var replaceStr &#x3D; strace.replace(&#x2F;,&#x2F;g, &quot; \n &quot;);</span><br><span class="line">            LogPrint(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot; + name + &quot; Stack strat&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;);</span><br><span class="line">            LogPrint(replaceStr);</span><br><span class="line">            LogPrint(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot; + name + &quot; Stack end&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n &quot;);</span><br><span class="line">            Exception.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function isprintable(value) &#123;</span><br><span class="line">    if (value &gt;&#x3D; 32 &amp;&amp; value &lt;&#x3D; 126) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function getsocketdetail(fd) &#123;</span><br><span class="line">    var result &#x3D; &quot;&quot;;</span><br><span class="line">    var type &#x3D; Socket.type(fd);</span><br><span class="line">    if (type !&#x3D; null) &#123;</span><br><span class="line">        result &#x3D; result + &quot;type:&quot; + type;</span><br><span class="line">        var peer &#x3D; Socket.peerAddress(fd);</span><br><span class="line">        var local &#x3D; Socket.localAddress(fd);</span><br><span class="line">        result &#x3D; result + &quot;,address:&quot; + JSON.stringify(peer) + &quot;,local:&quot; + JSON.stringify(local);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        result &#x3D; &quot;unknown&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function hooklibc() &#123;</span><br><span class="line">    var libcmodule &#x3D; Process.getModuleByName(&quot;libc.so&quot;);</span><br><span class="line">    var recvfrom_addr &#x3D; libcmodule.getExportByName(&quot;recvfrom&quot;);</span><br><span class="line">    var sendto_addr &#x3D; libcmodule.getExportByName(&quot;sendto&quot;);</span><br><span class="line">    console.log(recvfrom_addr + &quot;---&quot; + sendto_addr);</span><br><span class="line">    &#x2F;&#x2F;ssize_t recvfrom(int fd, void *buf, size_t n, int flags, struct sockaddr *addr, socklen_t *addr_len)</span><br><span class="line">    Interceptor.attach(recvfrom_addr, &#123;</span><br><span class="line">        onEnter: function (args) &#123;</span><br><span class="line">            this.arg0 &#x3D; args[0];</span><br><span class="line">            this.arg1 &#x3D; args[1];</span><br><span class="line">            this.arg2 &#x3D; args[2];</span><br><span class="line"></span><br><span class="line">            LogPrint(&quot;go into libc.so-&gt;recvfom&quot;);</span><br><span class="line"></span><br><span class="line">            printNativeStack(this.context, &quot;recvfom&quot;);</span><br><span class="line">        &#125;, onLeave(retval) &#123;</span><br><span class="line">            var size &#x3D; retval.toInt32();</span><br><span class="line">            if (size &gt; 0) &#123;</span><br><span class="line">                var result &#x3D; getsocketdetail(this.arg0.toInt32());</span><br><span class="line">                console.log(result + &quot;---libc.so-&gt;recvfrom:&quot; + hexdump(this.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LogPrint(&quot;leave libc.so-&gt;recvfom&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    &#x2F;&#x2F;ssize_t sendto(int fd, const void *buf, size_t n, int flags, const struct sockaddr *addr, socklen_t addr_len)</span><br><span class="line">    Interceptor.attach(sendto_addr, &#123;</span><br><span class="line">        onEnter: function (args) &#123;</span><br><span class="line">            this.arg0 &#x3D; args[0];</span><br><span class="line">            this.arg1 &#x3D; args[1];</span><br><span class="line">            this.arg2 &#x3D; args[2];</span><br><span class="line">            LogPrint(&quot;go into libc.so-&gt;sendto&quot;);</span><br><span class="line">            printNativeStack(this.context, &quot;sendto&quot;);</span><br><span class="line">        &#125;, onLeave(retval) &#123;</span><br><span class="line">            var size &#x3D; ptr(this.arg2).toInt32();</span><br><span class="line">            if (size &gt; 0) &#123;</span><br><span class="line">                var result &#x3D; getsocketdetail(this.arg0.toInt32());</span><br><span class="line">                console.log(result + &quot;---libc.so-&gt;sendto:&quot; + hexdump(this.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LogPrint(&quot;leave libc.so-&gt;sendto&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function main() &#123;</span><br><span class="line">    hooklibc();</span><br><span class="line">    hooktcp();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><p><strong>udp native层</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">libcore.io.Linux.sendtoBytes (jni)</span><br><span class="line">	|</span><br><span class="line">	libc.so - sendto</span><br><span class="line"></span><br><span class="line">libcore.io.Linux.recvfromBytes (jni)</span><br><span class="line">	|</span><br><span class="line">	libc.so - recvfrom</span><br></pre></td></tr></table></figure><p>frida -U -f com.example.okhttp -l hooklibc.js –no-pause 解析数据结构</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">function LogPrint(log) &#123;</span><br><span class="line">    var theDate &#x3D; new Date();</span><br><span class="line">    var hour &#x3D; theDate.getHours();</span><br><span class="line">    var minute &#x3D; theDate.getMinutes();</span><br><span class="line">    var second &#x3D; theDate.getSeconds();</span><br><span class="line">    var mSecond &#x3D; theDate.getMilliseconds();</span><br><span class="line"></span><br><span class="line">    hour &lt; 10 ? hour &#x3D; &quot;0&quot; + hour : hour;</span><br><span class="line">    minute &lt; 10 ? minute &#x3D; &quot;0&quot; + minute : minute;</span><br><span class="line">    second &lt; 10 ? second &#x3D; &quot;0&quot; + second : second;</span><br><span class="line">    mSecond &lt; 10 ? mSecond &#x3D; &quot;00&quot; + mSecond : mSecond &lt; 100 ? mSecond &#x3D; &quot;0&quot; + mSecond : mSecond;</span><br><span class="line">    var time &#x3D; hour + &quot;:&quot; + minute + &quot;:&quot; + second + &quot;:&quot; + mSecond;</span><br><span class="line">    var threadid &#x3D; Process.getCurrentThreadId();</span><br><span class="line">    console.log(&quot;[&quot; + time + &quot;]&quot; + &quot;-&gt;threadid:&quot; + threadid + &quot;--&quot; + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function printNativeStack(context, name) &#123;</span><br><span class="line">    &#x2F;&#x2F;Debug.</span><br><span class="line">    var array &#x3D; Thread.backtrace(context, Backtracer.ACCURATE);</span><br><span class="line">    var first &#x3D; DebugSymbol.fromAddress(array[0]);</span><br><span class="line">    if (first.toString().indexOf(&#39;libopenjdk.so!NET_Send&#39;) &lt; 0) &#123;</span><br><span class="line">        var trace &#x3D; Thread.backtrace(context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(&quot;\n&quot;);&#x2F;&#x2F; Backtracer.FUZZY</span><br><span class="line">        LogPrint(&quot;-----------start:&quot; + name + &quot;--------------&quot;);</span><br><span class="line">        LogPrint(trace);</span><br><span class="line">        LogPrint(&quot;-----------end:&quot; + name + &quot;--------------&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function printJavaStack(name) &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        var Exception &#x3D; Java.use(&quot;java.lang.Exception&quot;);</span><br><span class="line">        var ins &#x3D; Exception.$new(&quot;Exception&quot;);</span><br><span class="line">        var straces &#x3D; ins.getStackTrace();</span><br><span class="line">        if (straces !&#x3D; undefined &amp;&amp; straces !&#x3D; null) &#123;</span><br><span class="line">            var strace &#x3D; straces.toString();</span><br><span class="line">            var replaceStr &#x3D; strace.replace(&#x2F;,&#x2F;g, &quot; \n &quot;);</span><br><span class="line">            LogPrint(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot; + name + &quot; Stack strat&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;);</span><br><span class="line">            LogPrint(replaceStr);</span><br><span class="line">            LogPrint(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot; + name + &quot; Stack end&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n &quot;);</span><br><span class="line">            Exception.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function isprintable(value) &#123;</span><br><span class="line">    if (value &gt;&#x3D; 32 &amp;&amp; value &lt;&#x3D; 126) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function getsocketdetail(fd) &#123;</span><br><span class="line">    var result &#x3D; &quot;&quot;;</span><br><span class="line">    var type &#x3D; Socket.type(fd);</span><br><span class="line">    if (type !&#x3D; null) &#123;</span><br><span class="line">        result &#x3D; result + &quot;type:&quot; + type;</span><br><span class="line">        var peer &#x3D; Socket.peerAddress(fd);</span><br><span class="line">        var local &#x3D; Socket.localAddress(fd);</span><br><span class="line">        result &#x3D; result + &quot;,address:&quot; + JSON.stringify(peer) + &quot;,local:&quot; + JSON.stringify(local);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        result &#x3D; &quot;unknown&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function getip(ip_ptr) &#123;</span><br><span class="line">    var result &#x3D; ptr(ip_ptr).readU8() + &quot;.&quot; + ptr(ip_ptr.add(1)).readU8() + &quot;.&quot; + ptr(ip_ptr.add(2)).readU8() + &quot;.&quot; + ptr(ip_ptr.add(3)).readU8()</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function getudpaddr(addrptr) &#123;</span><br><span class="line">    var port_ptr &#x3D; addrptr.add(2);</span><br><span class="line">    var port &#x3D; ptr(port_ptr).readU8() * 256 + ptr(port_ptr.add(1)).readU8();</span><br><span class="line">    var ip_ptr &#x3D; addrptr.add(4);</span><br><span class="line">    var ip_addr &#x3D; getip(ip_ptr);</span><br><span class="line">    return &quot;peer:&quot;+ip_addr+&quot;--port:&quot;+port;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function hooklibc() &#123;</span><br><span class="line">    var libcmodule &#x3D; Process.getModuleByName(&quot;libc.so&quot;);</span><br><span class="line">    var recvfrom_addr &#x3D; libcmodule.getExportByName(&quot;recvfrom&quot;);</span><br><span class="line">    var sendto_addr &#x3D; libcmodule.getExportByName(&quot;sendto&quot;);</span><br><span class="line">    console.log(recvfrom_addr + &quot;---&quot; + sendto_addr);</span><br><span class="line">    &#x2F;&#x2F;ssize_t recvfrom(int fd, void *buf, size_t n, int flags, struct sockaddr *addr, socklen_t *addr_len)</span><br><span class="line">    Interceptor.attach(recvfrom_addr, &#123;</span><br><span class="line">        onEnter: function (args) &#123;</span><br><span class="line">            this.arg0 &#x3D; args[0];</span><br><span class="line">            this.arg1 &#x3D; args[1];</span><br><span class="line">            this.arg2 &#x3D; args[2];</span><br><span class="line">            this.arg3 &#x3D; args[3];</span><br><span class="line">            this.arg4 &#x3D; args[4];</span><br><span class="line">            this.arg5 &#x3D; args[5];</span><br><span class="line">            LogPrint(&quot;go into libc.so-&gt;recvfom&quot;);</span><br><span class="line"></span><br><span class="line">            printNativeStack(this.context, &quot;recvfom&quot;);</span><br><span class="line">        &#125;, onLeave(retval) &#123;</span><br><span class="line">            var size &#x3D; retval.toInt32();</span><br><span class="line">            if (size &gt; 0) &#123;</span><br><span class="line">                var result &#x3D; getsocketdetail(this.arg0.toInt32());</span><br><span class="line">                if (result.indexOf(&#39;udp&#39;) &gt;&#x3D; 0) &#123;</span><br><span class="line">                    &#x2F;*75struct sockaddr_in &#123;</span><br><span class="line">                    76	short	sin_family;</span><br><span class="line">                    77	u_short	sin_port;</span><br><span class="line">                    78	struct in_addr	sin_addr;</span><br><span class="line">                    79	char	sin_zero[8];</span><br><span class="line">                    80&#125;;*&#x2F;</span><br><span class="line">                    var sockaddr_in_ptr &#x3D; this.arg4;</span><br><span class="line">                    var sizeofsockaddr_in &#x3D; this.arg5;</span><br><span class="line"></span><br><span class="line">                    &#x2F;&#x2F;02 00 22 b8 c0 a8 05 96 00 00 00 00 00 00 00 00</span><br><span class="line">                    console.log(&quot;this is a recvfrom udp!-&gt;&quot; + getudpaddr(sockaddr_in_ptr) + &quot;---&quot; + sizeofsockaddr_in);</span><br><span class="line">                &#125;</span><br><span class="line">                console.log(Process.getCurrentThreadId()+result + &quot;---libc.so-&gt;recvfrom:&quot; + hexdump(this.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LogPrint(&quot;leave libc.so-&gt;recvfom&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    &#x2F;&#x2F;ssize_t sendto(int fd, const void *buf, size_t n, int flags, const struct sockaddr *addr, socklen_t addr_len)</span><br><span class="line">    Interceptor.attach(sendto_addr, &#123;</span><br><span class="line">        onEnter: function (args) &#123;</span><br><span class="line">            this.arg0 &#x3D; args[0];</span><br><span class="line">            this.arg1 &#x3D; args[1];</span><br><span class="line">            this.arg2 &#x3D; args[2];</span><br><span class="line">            this.arg3 &#x3D; args[3];</span><br><span class="line">            this.arg4 &#x3D; args[4];</span><br><span class="line">            this.arg5 &#x3D; args[5];</span><br><span class="line">            LogPrint(&quot;go into libc.so-&gt;sendto&quot;);</span><br><span class="line">            printNativeStack(this.context, &quot;sendto&quot;);</span><br><span class="line">        &#125;, onLeave(retval) &#123;</span><br><span class="line">            var size &#x3D; ptr(this.arg2).toInt32();</span><br><span class="line">            if (size &gt; 0) &#123;</span><br><span class="line">                var result &#x3D; getsocketdetail(this.arg0.toInt32());</span><br><span class="line">                if (result.indexOf(&#39;udp&#39;) &gt;&#x3D; 0) &#123;</span><br><span class="line">                    &#x2F;*75struct sockaddr_in &#123;</span><br><span class="line">                    76	short	sin_family;</span><br><span class="line">                    77	u_short	sin_port;</span><br><span class="line">                    78	struct in_addr	sin_addr;</span><br><span class="line">                    79	char	sin_zero[8];</span><br><span class="line">                    80&#125;;*&#x2F;</span><br><span class="line">                    var sockaddr_in_ptr &#x3D; this.arg4;</span><br><span class="line">                    var sizeofsockaddr_in &#x3D; this.arg5;</span><br><span class="line"></span><br><span class="line">                    &#x2F;&#x2F;02 00 22 b8 c0 a8 05 96 00 00 00 00 00 00 00 00</span><br><span class="line">                    console.log(&quot;this is a sendto udp!-&gt;&quot; + getudpaddr(sockaddr_in_ptr) + &quot;---&quot; + sizeofsockaddr_in);</span><br><span class="line">                &#125;</span><br><span class="line">                console.log(Process.getCurrentThreadId()+&quot;---&quot;+result + &quot;---libc.so-&gt;sendto:&quot; + hexdump(this.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LogPrint(&quot;leave libc.so-&gt;sendto&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function main() &#123;</span><br><span class="line">    hooklibc();</span><br><span class="line">    hookudp();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><p>frida -U -f com.tencent.news -l hooklibc.js –no-pause -o log.txt</p><h3 id="ssl抓包-1"><a href="#ssl抓包-1" class="headerlink" title="ssl抓包"></a>ssl抓包</h3><p>发送：com.android.org.conscrypt.OpenSSLSocketImpl$SSLOutputStream.write-&gt;jni函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">7543  static void NativeCrypto_SSL_write(JNIEnv* env, jclass, jlong ssl_address, jobject fdObject,</span><br><span class="line">7544                                     jobject shc, jbyteArray b, jint offset, jint len,</span><br><span class="line">7545                                     jint write_timeout_millis) &#123;</span><br><span class="line">com.android.org.conscrypt.NativeCrypto.SSL_write （jni)</span><br><span class="line">	|</span><br><span class="line">	sslWrite</span><br><span class="line">		|</span><br><span class="line">		boringssl -&gt; ssl_lib.c -&gt; SSL_write</span><br><span class="line">			|</span><br><span class="line">			ssl3_write_app_data</span><br><span class="line">				|</span><br><span class="line">				do_ssl3_write （此时还是明文，之后被加密了）</span><br><span class="line">					|</span><br><span class="line">					ssl_write_pending</span><br><span class="line">						|</span><br><span class="line">						ssl_write_buffer_flush</span><br><span class="line">							|</span><br><span class="line">							dtls_write_buffer_flush&#x2F;tls_write_buffer_flush</span><br><span class="line">								|</span><br><span class="line">								BIO_write  openssl并没有使用sendto及send发送加密数据，而是使用write,接受没用recvfrom而是read</span><br><span class="line">									|</span><br><span class="line">									bio_io</span><br><span class="line">										|</span><br><span class="line">										libc.so - write</span><br><span class="line"></span><br><span class="line">com.android.org.conscrypt.NativeCrypto.SSL_read   (jni)</span><br><span class="line">	|</span><br><span class="line">	libc.so - read</span><br></pre></td></tr></table></figure><p>frida -U -f com.tencent.news -l hookopenssl.js –no-pause -o log.txt</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line">function hooklibc() &#123;</span><br><span class="line">    var libcmodule &#x3D; Process.getModuleByName(&quot;libc.so&quot;);</span><br><span class="line">    var read_addr &#x3D; libcmodule.getExportByName(&quot;read&quot;);</span><br><span class="line">    var write_addr &#x3D; libcmodule.getExportByName(&quot;write&quot;);</span><br><span class="line">    console.log(read_addr + &quot;---&quot; + write_addr);</span><br><span class="line">    Interceptor.attach(read_addr, &#123;</span><br><span class="line">        onEnter: function (args) &#123;</span><br><span class="line">            this.arg0 &#x3D; args[0];</span><br><span class="line">            this.arg1 &#x3D; args[1];</span><br><span class="line">            this.arg2 &#x3D; args[2];</span><br><span class="line"></span><br><span class="line">            this.socketinfo &#x3D; getsocketdetail(this.arg0.toInt32());</span><br><span class="line">            LogPrint(&quot;go into libc.so-&gt;read_addr&quot; + &quot;---&quot; + this.socketinfo);</span><br><span class="line">            this.flag &#x3D; false;</span><br><span class="line">            if (this.socketinfo.indexOf(&quot;tcp&quot;) &gt;&#x3D; 0) &#123;</span><br><span class="line">                this.flag &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">            if (this.flag) &#123;</span><br><span class="line">                printNativeStack(this.context, Process.getCurrentThreadId() + &quot;read&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;, onLeave(retval) &#123;</span><br><span class="line"></span><br><span class="line">            if (this.flag) &#123;</span><br><span class="line">                var size &#x3D; retval.toInt32();</span><br><span class="line">                if (size &gt; 0) &#123;</span><br><span class="line">                    console.log(Process.getCurrentThreadId() + &quot;---libc.so-&gt;read:&quot; + hexdump(this.arg1, &#123;</span><br><span class="line">                        length: size</span><br><span class="line">                    &#125;));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            LogPrint(&quot;leave libc.so-&gt;read&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    Interceptor.attach(write_addr, &#123;</span><br><span class="line">        onEnter: function (args) &#123;</span><br><span class="line">            this.arg0 &#x3D; args[0];</span><br><span class="line">            this.arg1 &#x3D; args[1];</span><br><span class="line">            this.arg2 &#x3D; args[2];</span><br><span class="line"></span><br><span class="line">            this.socketinfo &#x3D; getsocketdetail(this.arg0.toInt32());</span><br><span class="line">            LogPrint(&quot;go into libc.so-&gt;write&quot; + &quot;---&quot; + this.socketinfo);</span><br><span class="line">            this.flag &#x3D; false;</span><br><span class="line">            if (this.socketinfo.indexOf(&quot;tcp&quot;) &gt;&#x3D; 0) &#123;</span><br><span class="line">                this.flag &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">            if (this.flag) &#123;</span><br><span class="line">                printNativeStack(this.context, Process.getCurrentThreadId() + &quot;write&quot;);</span><br><span class="line">                var size &#x3D; ptr(this.arg2).toInt32();</span><br><span class="line">                if (size &gt; 0) &#123;</span><br><span class="line">                    console.log(Process.getCurrentThreadId() + &quot;---libc.so-&gt;write:&quot; + hexdump(this.arg1, &#123;</span><br><span class="line">                        length: size</span><br><span class="line">                    &#125;));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;, onLeave(retval) &#123;</span><br><span class="line">            LogPrint(&quot;leave libc.so-&gt;write&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 明文 打印ip port</span><br><span class="line">function hookssl() &#123;</span><br><span class="line">    var libcmodule &#x3D; Process.getModuleByName(&quot;libssl.so&quot;);</span><br><span class="line">    var read_addr &#x3D; libcmodule.getExportByName(&quot;SSL_read&quot;);</span><br><span class="line">    var write_addr &#x3D; libcmodule.getExportByName(&quot;SSL_write&quot;);</span><br><span class="line">    var bio_read_addr &#x3D; libcmodule.getExportByName(&quot;BIO_read&quot;);</span><br><span class="line">    var bio_write_addr &#x3D; libcmodule.getExportByName(&quot;BIO_write&quot;);</span><br><span class="line">    var SSL_get_rfd_ptr &#x3D; libsslmodule.getExportByName(&#39;SSL_get_rfd&#39;);</span><br><span class="line">    var SSL_get_rfd &#x3D; new NativeFunction(SSL_get_rfd_ptr, &#39;int&#39;, [&#39;pointer&#39;]);</span><br><span class="line">    console.log(read_addr + &quot;---&quot; + write_addr);</span><br><span class="line">    Interceptor.attach(read_addr, &#123;</span><br><span class="line">        onEnter: function (args) &#123;</span><br><span class="line">            this.arg0 &#x3D; args[0];</span><br><span class="line">            this.arg1 &#x3D; args[1];</span><br><span class="line">            this.arg2 &#x3D; args[2];</span><br><span class="line"> </span><br><span class="line">            LogPrint(&quot;go into libssl.so-&gt;SSL_read&quot;);</span><br><span class="line">            printNativeStack(this.context, Process.getCurrentThreadId() + &quot;SSL_read&quot;);</span><br><span class="line"></span><br><span class="line">        &#125;, onLeave(retval) &#123;</span><br><span class="line"> </span><br><span class="line">            var size &#x3D; retval.toInt32();</span><br><span class="line">            if (size &gt; 0) &#123;</span><br><span class="line">                var sockfd &#x3D; SSL_get_rfd(this.arg0);</span><br><span class="line">                var socketdetail &#x3D; getsocketdetail(sockfd);</span><br><span class="line">                console.log(socketdetail+&quot;----&quot;+Process.getCurrentThreadId() + &quot;---libssl.so-&gt;SSL_read:&quot; + hexdump(this.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            LogPrint(&quot;leave libc.so-&gt;SSL_read&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    Interceptor.attach(write_addr, &#123;</span><br><span class="line">        onEnter: function (args) &#123;</span><br><span class="line">            this.arg0 &#x3D; args[0];</span><br><span class="line">            this.arg1 &#x3D; args[1];</span><br><span class="line">            this.arg2 &#x3D; args[2];</span><br><span class="line"> </span><br><span class="line">            LogPrint(&quot;go into libc.so-&gt;SSL_write&quot;);</span><br><span class="line">            printNativeStack(this.context, Process.getCurrentThreadId() + &quot;SSL_write&quot;); </span><br><span class="line">            var size &#x3D; ptr(this.arg2).toInt32();</span><br><span class="line">            if (size &gt; 0) &#123;</span><br><span class="line">            var sockfd &#x3D; SSL_get_rfd(this.arg0);</span><br><span class="line">            var socketdetail &#x3D; getsocketdetail(sockfd);</span><br><span class="line">            console.log(socketdetail+&quot;----&quot;+Process.getCurrentThreadId() + &quot;---libssl.so-&gt;SSL_write:&quot; + hexdump(this.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;, onLeave(retval) &#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            LogPrint(&quot;libssl.so-&gt;SSL_write&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    Interceptor.attach(bio_read_addr, &#123;</span><br><span class="line">        onEnter: function (args) &#123;</span><br><span class="line">            this.arg0 &#x3D; args[0];</span><br><span class="line">            this.arg1 &#x3D; args[1];</span><br><span class="line">            this.arg2 &#x3D; args[2];</span><br><span class="line"> </span><br><span class="line">            LogPrint(&quot;go into libssl.so-&gt;bio_read&quot;);</span><br><span class="line">            printNativeStack(this.context, Process.getCurrentThreadId() + &quot;bio_read&quot;);</span><br><span class="line"></span><br><span class="line">        &#125;, onLeave(retval) &#123;</span><br><span class="line"> </span><br><span class="line">            var size &#x3D; retval.toInt32();</span><br><span class="line">            if (size &gt; 0) &#123;</span><br><span class="line">                var sockfd &#x3D; SSL_get_rfd(this.arg0);</span><br><span class="line">                var socketdetail &#x3D; getsocketdetail(sockfd);</span><br><span class="line">                console.log(socketdetail+&quot;----&quot;+Process.getCurrentThreadId() + &quot;---libssl.so-&gt;bio_read:&quot; + hexdump(this.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            LogPrint(&quot;leave libc.so-&gt;bio_read&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    Interceptor.attach(bio_write_addr, &#123;</span><br><span class="line">        onEnter: function (args) &#123;</span><br><span class="line">            this.arg0 &#x3D; args[0];</span><br><span class="line">            this.arg1 &#x3D; args[1];</span><br><span class="line">            this.arg2 &#x3D; args[2];</span><br><span class="line"> </span><br><span class="line">            LogPrint(&quot;go into libc.so-&gt;bio_write&quot;);</span><br><span class="line">            printNativeStack(this.context, Process.getCurrentThreadId() + &quot;bio_write&quot;); </span><br><span class="line">            var size &#x3D; ptr(this.arg2).toInt32();</span><br><span class="line">            if (size &gt; 0) &#123;</span><br><span class="line">            var sockfd &#x3D; SSL_get_rfd(this.arg0);</span><br><span class="line">            var socketdetail &#x3D; getsocketdetail(sockfd);</span><br><span class="line">            console.log(socketdetail+&quot;----&quot;+Process.getCurrentThreadId() + &quot;---libssl.so-&gt;bio_write:&quot; + hexdump(this.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;             </span><br><span class="line"></span><br><span class="line">        &#125;, onLeave(retval) &#123; </span><br><span class="line">            LogPrint(&quot;libssl.so-&gt;bio_write&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">function main() &#123;</span><br><span class="line">    hooklibc();</span><br><span class="line">    hookssl();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="自编译openssl库抓包溯源"><a href="#自编译openssl库抓包溯源" class="headerlink" title="自编译openssl库抓包溯源"></a>自编译openssl库抓包溯源</h2><p>hook 自编译 ssl so中的所有导出函数（有符号）,so中的符号被抹掉时：通过hook libc.so中的write，read进行堆栈回溯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">function hookallssl() &#123;</span><br><span class="line">    var libsslmodule &#x3D; Process.getModuleByName(&quot;libssl.so&quot;);</span><br><span class="line">    var SSL_get_rfd_ptr &#x3D; libsslmodule.getExportByName(&#39;SSL_get_rfd&#39;); &#x2F;&#x2F; 导出函数 获取socket的id</span><br><span class="line">    var SSL_get_rfd &#x3D; new NativeFunction(SSL_get_rfd_ptr, &#39;int&#39;, [&#39;pointer&#39;]);</span><br><span class="line">    Process.enumerateModules().forEach(function (module) &#123;</span><br><span class="line">        module.enumerateExports().forEach(function (symbol) &#123;</span><br><span class="line">            var name &#x3D; symbol.name;</span><br><span class="line">            if (name &#x3D;&#x3D; &#39;SSL_read&#39;) &#123;</span><br><span class="line">                LogPrint(JSON.stringify(module) + JSON.stringify(symbol));</span><br><span class="line">            &#125;</span><br><span class="line">            if (name &#x3D;&#x3D; &#39;SSL_write&#39;) &#123;</span><br><span class="line">                LogPrint(JSON.stringify(module) + JSON.stringify(symbol));</span><br><span class="line">                Interceptor.attach(symbol.address, &#123;</span><br><span class="line">                    onEnter: function (args) &#123;</span><br><span class="line">                        this.arg0 &#x3D; args[0];</span><br><span class="line">                        this.arg1 &#x3D; args[1];</span><br><span class="line">                        this.arg2 &#x3D; args[2];</span><br><span class="line">                        LogPrint(&quot;go into &quot; + Process.getCurrentThreadId() + &quot;---&quot; + JSON.stringify(module) + &quot;---&quot; + JSON.stringify(symbol));</span><br><span class="line">                        printNativeStack(this.context, Process.getCurrentThreadId() + &quot;---&quot; + JSON.stringify(module) + &quot;---&quot; + JSON.stringify(symbol));</span><br><span class="line">                        var size &#x3D; ptr(this.arg2).toInt32();</span><br><span class="line">                        if (size &gt; 0) &#123;</span><br><span class="line">                            var sockfd &#x3D; SSL_get_rfd(this.arg0);</span><br><span class="line">                            var socketdetail &#x3D; getsocketdetail(sockfd);</span><br><span class="line">                            console.log(socketdetail + &quot;---&quot; + Process.getCurrentThreadId() + &quot;---&quot; + JSON.stringify(module) + &quot;---&quot; + JSON.stringify(symbol) + hexdump(this.arg1, &#123;</span><br><span class="line">                                length: size</span><br><span class="line">                            &#125;));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, onLeave(retval) &#123;</span><br><span class="line">                        LogPrint(&quot;leave &quot; + Process.getCurrentThreadId() + &quot;---&quot; + JSON.stringify(module) + &quot;---&quot; + JSON.stringify(symbol));</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><p>脱壳</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 只适用于存在getDex和getBytes api的android版本,手动dump脱壳指定类的dex</span><br><span class="line">function dumpdex()&#123;</span><br><span class="line">    &#x2F;&#x2F; com.example.socket.MainActivity</span><br><span class="line">    &#x2F;&#x2F; a.a.a.a$a </span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        var File &#x3D; Java.use(&#39;java.io.File&#39;);</span><br><span class="line">        var FileOutputStream &#x3D; Java.use(&#39;java.io.FileOutputStream&#39;);</span><br><span class="line">        Java.enumerateClassLoadersSync().forEach(function(loader)&#123;</span><br><span class="line">            console.log(loader+&quot;\n&quot;);</span><br><span class="line">            try&#123;</span><br><span class="line">                var aclass &#x3D; loader.loaderClass(&quot;a.a.a.a$a&quot;)</span><br><span class="line">                console.log(aclass);</span><br><span class="line">                var dexobj &#x3D; aclass.getDex();</span><br><span class="line">                console.loader(dexobj);</span><br><span class="line">                var dexbytes &#x3D; dexobj.getBytes();</span><br><span class="line">                var dexsavepath &#x3D; &quot;&#x2F;data&#x2F;data&#x2F;com.example.socket&#x2F;dump.dex&quot;;</span><br><span class="line">                var dexfile &#x3D; File.$new(dexsavepath);</span><br><span class="line">                if(!dexfile.exists())&#123;</span><br><span class="line">                    dexfile.createNewFile();</span><br><span class="line">                &#125;</span><br><span class="line">                var fileOutputStream &#x3D; FileOutputStream.$new(dexfile);</span><br><span class="line">                fileOutputStream.write(dexbytes);</span><br><span class="line">                fileOutputStream.fluse();</span><br><span class="line">                fileOutputStream.close();</span><br><span class="line">                console.log(&quot;save dex success&quot;);</span><br><span class="line">            &#125; catch(e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>hook</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 只适用于存在getDex和getBytes api的android版本,手动dump脱壳指定类的dex</span><br><span class="line">function hook()&#123;</span><br><span class="line">    &#x2F;&#x2F; com.example.socket.MainActivity</span><br><span class="line">    &#x2F;&#x2F; a.a.a.a$a </span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        var File &#x3D; Java.use(&#39;java.io.File&#39;);</span><br><span class="line">        var FileOutputStream &#x3D; Java.use(&#39;java.io.FileOutputStream&#39;);</span><br><span class="line">        Java.enumerateClassLoadersSync().forEach(function(loader)&#123;</span><br><span class="line">            console.log(loader+&quot;\n&quot;);</span><br><span class="line">            try&#123;</span><br><span class="line">                var aclass &#x3D; loader.loaderClass(&quot;a.a.a.a$a&quot;)</span><br><span class="line">                Java.classFactory.loader&#x3D;loader;</span><br><span class="line">                var HelloKitty &#x3D; Java.use(&#39;com.example.socket.HelloKitty&#39;);</span><br><span class="line">                HelloKitty.hello.implementation &#x3D; function(arg) &#123;</span><br><span class="line">                    console.log(&quot;Hellokitty.hello is called,arg:&quot;+arg);</span><br><span class="line">                    var result &#x3D; this.hello(arg);</span><br><span class="line">                    console.log(&quot;Hellokitty.hello called over!,result:&quot;+result);</span><br><span class="line">                    return result;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch(e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if(!isMobile){var btw=new BTWPlugin;btw.init({id:"vip-container",blogId:"25827-1638538754631-918",name:"万物皆可逆向",qrcode:"https://onejane.github.io/gzh.jpg",keyword:"密码"})}</script></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="mailto:undefined">J</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="http://onejane.github.io/2021/02/18/抓包环境与hook/">http://onejane.github.io/2021/02/18/抓包环境与hook/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://onejane.github.io">万物皆可逆向</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/postern/">postern</a><a class="post-meta__tags" href="/tags/charles/">charles</a><a class="post-meta__tags" href="/tags/burpsuite/">burpsuite</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="http://onejane.gitee.io/picture/alipay.png"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="http://onejane.gitee.io/picture/wx.png"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share pull-right" data-disabled="google,facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/02/21/%E5%8A%A0%E5%A3%B3%E4%B8%8E%E8%84%B1%E5%A3%B3%E4%B9%8B%E5%88%86%E7%B1%BB%E6%8A%80%E6%9C%AF/"><i class="fa fa-chevron-left"></i> <span>加壳与脱壳之分类技术</span></a></div><div class="next-post pull-right"><a href="/2021/02/16/%E4%B8%BB%E5%8A%A8%E8%B0%83%E7%94%A8java%E5%8F%8Anative%E5%B1%82/"><span>主动调用java及native层</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify=!1,verify=!1,record_ip=!1,GUEST_INFO=["nick","mail","link"],guest_info="nick,mail,link".split(",").filter(function(i){return-1<GUEST_INFO.indexOf(i)});guest_info=0==guest_info.length?GUEST_INFO:guest_info,window.valine=new Valine({el:"#vcomment",notify:notify,verify:verify,recordIP:record_ip,appId:"cWLsquGr5PNi33OWXNhzerep-gzGzoHsz",appKey:"S35phfCSbm8dAG9LpOc5rjm3",placeholder:"一起来吹牛逼好吗！",avatar:"mm",guest_info:guest_info,pageSize:"10",lang:"zh-cn"})</script></div></div><footer class="footer-bg" style="background-image:url(http://onejane.gitee.io/picture/kali.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2022 By J</div><div class="framework-info"><span>驱动 -</span> <a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 -</span> <a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script>/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)&&($("#nav").addClass("is-mobile"),$("footer").addClass("is-mobile"),$("#top-container").addClass("is-mobile"))</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49b1f5">hexo-generator-search</a> <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>