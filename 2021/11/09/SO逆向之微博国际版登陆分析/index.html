<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="SO逆向之微博国际版登陆分析"><meta name="keywords" content="frida,unidbg,ida"><meta name="author" content="J"><meta name="copyright" content="J"><title>SO逆向之微博国际版登陆分析 | 万物皆可逆向</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?a345f534c85363668f09d4d5c6a9ee81";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-111479568-4","auto"),ga("send","pageview")</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer="defer"></script><script>var GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容:${query}"}},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},hexoVersion:"4.2.1"}</script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#篇幅有限"><span class="toc-number">1.</span> <span class="toc-text">篇幅有限</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#抓包"><span class="toc-number">2.</span> <span class="toc-text">抓包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Charles本地证书"><span class="toc-number">2.1.</span> <span class="toc-text">Charles本地证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ssl-pinning"><span class="toc-number">2.2.</span> <span class="toc-text">ssl pinning</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#分析"><span class="toc-number">3.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#password"><span class="toc-number">3.1.</span> <span class="toc-text">password</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sValue"><span class="toc-number">3.2.</span> <span class="toc-text">sValue</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Unidbg"><span class="toc-number">3.2.1.</span> <span class="toc-text">Unidbg</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Frida"><span class="toc-number">3.2.2.</span> <span class="toc-text">Frida</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#iValue"><span class="toc-number">3.3.</span> <span class="toc-text">iValue</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="http://onejane.gitee.io/picture/avatar.jpg"></div><div class="author-info__name text-center">J</div><div class="author-info__description text-center">逆向,爬虫</div><div class="follow-button"><a href="https://github.com/OneJane/" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">84</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">66</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">9</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友情链接</div><a class="author-info-links__name text-center" href="https://blog.csdn.net/welggy" target="_blank" rel="noopener">OneJane</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image:url(http://onejane.gitee.io/picture/kali.jpg)"><div id="page-header"> <span class="pull-left"><a id="site-name" href="/">万物皆可逆向</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i> <span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i> <span>搜索</span></a></span></div><div id="post-info"><div id="post-title">SO逆向之微博国际版登陆分析</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-09</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/">安卓逆向</a><div class="post-meta-wordcount"><span>字数总计:</span> <span class="word-count">4.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 21 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><div id="vip-container"><h1 id="篇幅有限"><a href="#篇幅有限" class="headerlink" title="篇幅有限"></a>篇幅有限</h1><p>完整内容及源码关注公众号：ReverseCode，发送 <strong>冲</strong></p><h1 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h1><h2 id="Charles本地证书"><a href="#Charles本地证书" class="headerlink" title="Charles本地证书"></a>Charles本地证书</h2><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20220106102345520.png" alt="image-20220106102345520"></p><p>系统证书目录：/system/etc/security/cacerts/</p><p>其中的每个证书的命名规则如下：<certificate_hash>. 文件名是一个Hash值，而后缀是一个数字。</certificate_hash></p><p>文件名可以用下面的命令计算出来： openssl x509 -subject_hash_old -in<certificate_file></certificate_file></p><p>后缀名的数字是为了防止文件名冲突的，比如如果两个证书算出的Hash值是一样的话，那么一个证书的后缀名数字可以设置成0，而另一个证书的后缀名数字可以设置成1</p><p>安卓8</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;data&#x2F;misc&#x2F;user&#x2F;0&#x2F;cacerts-added&#x2F;</span><br><span class="line">mount -o remount,rw &#x2F;</span><br><span class="line">mount -o remount,rw &#x2F;system</span><br><span class="line">chmod 777 *</span><br><span class="line">cp * &#x2F;etc&#x2F;security&#x2F;cacerts&#x2F;</span><br><span class="line">mount -o remount,ro &#x2F;</span><br><span class="line">mount -o remount,ro &#x2F;system</span><br></pre></td></tr></table></figure><p>安卓7</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;data&#x2F;misc&#x2F;user&#x2F;0&#x2F;cacerts-added&#x2F;</span><br><span class="line">mount -o rw,remount &#x2F;system</span><br><span class="line">mount -o rw,remount &#x2F;</span><br><span class="line">chmod 777 *</span><br><span class="line">cp * &#x2F;etc&#x2F;security&#x2F;cacerts&#x2F;</span><br><span class="line">mount -o ro,remount &#x2F;system</span><br><span class="line">mount -o ro,remount &#x2F;</span><br></pre></td></tr></table></figure><p>安卓10</p><p>Move_Certificates-v1.9 直接面具插件安排，重启即可</p><p>重启</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20220106102744607.png" alt="image-20220106102744607"></p><h2 id="ssl-pinning"><a href="#ssl-pinning" class="headerlink" title="ssl pinning"></a>ssl pinning</h2><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211105204214989.png" alt="image-20211105204214989"></p><p>xposed+justTrustMe.apk破解ssl pinning</p><p>抓包登录<code>http://api.weibo.cn/2/account/login</code>，账户密码为188888888/123456</p><table><thead><tr><th>参数</th><th>值</th></tr></thead><tbody><tr><td>c</td><td>weicoabroad</td></tr><tr><td>i</td><td>3655223</td></tr><tr><td>s</td><td>7c5edcf8</td></tr><tr><td>u</td><td>188888888</td></tr><tr><td>p</td><td>bFbQbLlD4PMcp8gOTSxh3NFS4g2VJIh5Vw6k62wAq49BLlQaeeVDAYBL4iqwY7AHup8LZRGrfHsf+/zP246oBg+LV3UqK+3IpZ6qP654NkEUH/YNzg+JP8WbMmxTE4mZsddMReBquawLm1WwN86m7WRiVO0GBxznHvyK/h5uhmk=</td></tr><tr><td>getuser</td><td>1</td></tr><tr><td>getoauth</td><td>1</td></tr><tr><td>getcookie</td><td>1</td></tr><tr><td>lang</td><td>zh_CN_#Hans</td></tr></tbody></table><h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>微博1.7.1.apk，多次抓包发现除了p其他值都不变，p看起来像是RSA加密，目标参数i和s</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;fs1280arm64</span><br><span class="line">frida -U com.weico.international -l hookEvent.js 事件hook，点击登录后触发点击事件</span><br></pre></td></tr></table></figure><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108155045044.png" alt="image-20211108155045044"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android hooking watch class com.weico.international.activity.SinaLoginMainActivity --dump-args --dump-backtrace --dump-return  对该类进行hook，重新点击登录</span><br><span class="line">android hooking watch class_method com.weico.international.activity.SinaLoginMainActivity.refreshSinaToken --dump-args --dump-backtrace --dump-return  对refreshSinaToken进行hook</span><br></pre></td></tr></table></figure><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108204950577.png" alt="image-20211108204950577"></p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108205514055.png" alt="image-20211108205514055"></p><p>打开jadx查看refreshSinaToken</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private static void refreshSinaToken(String userName, String password, String sValue, String cpt, String cptcode, WeicoCallbackString callback) &#123;</span><br><span class="line">    Object iValue &#x3D; WeiboSecurityUtils.getIValue(WApplication.cContext);</span><br><span class="line">    Map&lt;String, Object&gt; maps &#x3D; new LinkedHashMap&lt;&gt;();</span><br><span class="line">    maps.put(SinaRetrofitAPI.ParamsKey.c, KeyUtil.WEICO_C_VALUE);</span><br><span class="line">    maps.put(SinaRetrofitAPI.ParamsKey.i, iValue);</span><br><span class="line">    maps.put(SinaRetrofitAPI.ParamsKey.s, sValue);</span><br><span class="line">    maps.put(&quot;u&quot;, userName);</span><br><span class="line">    maps.put(&quot;p&quot;, password);</span><br><span class="line">    maps.put(&quot;getuser&quot;, 1);</span><br><span class="line">    maps.put(&quot;getoauth&quot;, 1);</span><br><span class="line">    maps.put(&quot;getcookie&quot;, 1);</span><br><span class="line">    maps.put(&quot;lang&quot;, Utils.getLocalLanguage());</span><br><span class="line">    if (!TextUtils.isEmpty(cpt)) &#123;</span><br><span class="line">        maps.put(&quot;cpt&quot;, cpt);</span><br><span class="line">    &#125;</span><br><span class="line">    if (!TextUtils.isEmpty(cptcode)) &#123;</span><br><span class="line">        maps.put(&quot;cptcode&quot;, cptcode);</span><br><span class="line">    &#125;</span><br><span class="line">    SinaRetrofitAPI.getWeiboSinaService().login(maps, callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上说明在调用<code>refreshSinaToken</code>时加密参数有password，sValue。userName为登录名，cpt为none，cptcode为none。对应请求参数中u对应userName，c=<code>weicoabroad</code>，<code>i=WeiboSecurityUtils.getIValue(WApplication.cContext)</code>，getuser=getoauth=getcookie=1，lang=<code>zh_CN_#Hans</code>，p=password，s=sValue。</p><p>在doLogin中调用了refreshSinaToken，同时也生成了password和sValue的值。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">private void doLogin(String cpt, String cptcode) &#123;</span><br><span class="line">    this.loadingDialog &#x3D; new EasyDialog.Builder(this.me).progress(true, 0).canceledOnTouchOutside(false).progressColor(Res.getColor(R.color.card_content_text)).show();</span><br><span class="line">    final String userName &#x3D; this.loginNameEditText.getText().toString();</span><br><span class="line">    String password &#x3D; this.loginPasswordEditText.getText().toString();</span><br><span class="line">    final String psd &#x3D; WeicoSecurityUtils.securityPsd(password);</span><br><span class="line">    try &#123;</span><br><span class="line">        String decode &#x3D; WeicoSecurityUtils.decode(KeyUtil.WEICO_PIN);</span><br><span class="line">        LogUtil.d(&quot;decode &quot; + decode + decode.equals(&quot;CypCHG2kSlRkdvr2RG1QF8b2lCWXl7k7&quot;));</span><br><span class="line">        final String sValue &#x3D; WeiboSecurityUtils.calculateSInJava(getApplicationContext(), userName + password, decode);</span><br><span class="line">        refreshSinaToken(userName, psd, sValue, cpt, cptcode, new WeicoCallbackString() &#123;</span><br><span class="line">            &#x2F;* class com.weico.international.activity.SinaLoginMainActivity.AnonymousClass10 *&#x2F;</span><br><span class="line"></span><br><span class="line">            @Override &#x2F;&#x2F; com.weibo.sdk.android.api.WeicoCallbackString</span><br><span class="line">            public void onSuccess(String str, Object bak) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    SinaLoginMainActivity.this.loadingDialog.dismiss();</span><br><span class="line">                    SinaLoginMainActivity.this.parseAccount(SinaLoginMainActivity.this.checkLoginResponseForWeibo(str), userName, psd, sValue);</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    SinaLoginMainActivity.this.weibofail();</span><br><span class="line">                    UIManager.showSystemToast(e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override &#x2F;&#x2F; com.weibo.sdk.android.api.WeicoCallbackString</span><br><span class="line">            public void onFail(Exception e, Object bak) &#123;</span><br><span class="line">                LogUtil.e(e);</span><br><span class="line">                SinaLoginMainActivity.this.loadingDialog.dismiss();</span><br><span class="line">                SinaLoginMainActivity.this.weibofail();</span><br><span class="line">                UIManager.showSystemToast((int) R.string.Login_failed);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        UIManager.showSystemToast((int) R.string.process_fail);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="password"><a href="#password" class="headerlink" title="password"></a>password</h2><p>在<code>WeicoSecurityUtils.securityPsd(password)</code>中将代码拷出来配合<code>android.util.Base64</code>即可完成加密拿到password。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">public class WeiboSecurityUtils &#123;</span><br><span class="line">    &#x2F;&#x2F; password</span><br><span class="line">    private static final String KEY_ALGORITHM &#x3D; &quot;RSA&quot;;</span><br><span class="line">    private static final String KEY_CIPHER_ALGORITHM &#x3D; &quot;RSA&#x2F;ECB&#x2F;PKCS1Padding&quot;;</span><br><span class="line">    private static final int MAX_DECRYPT_BLOCK &#x3D; 128;</span><br><span class="line">    private static final int MAX_ENCRYPT_BLOCK &#x3D; 117;</span><br><span class="line">    private static String publicKeyInner &#x3D; &quot;MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDWcQcgj60fU8fFev9RlvFPg0GcRgHyGFTN9ytE\nLujvfCwGt7n54Q9+k1rDDo+sRQeYdTwA7ZMS8n1RHjZATgmHw9rBBzk&#x2F;cHXAVIgrJrZ5txDdW1i4\n8ZxEarcdSrmlk9ZFSsvGXE8&#x2F;0fZYHM0mr4WaIh2y9E0CNkd0rU9VKAR9RQIDAQAB&quot;;</span><br><span class="line">    private static final String publicKeyString &#x3D; &quot;iMxVDGf9f5Z3P3NsFac7tM7SC6DZDJY+H&#x2F;vXc+xv3HlT2E&#x2F;LUzWf5fct2P0VauekLzNAaNsH93SZ\n2Z3jUc&#x2F;0x81FLThPwI8cexCuRT7P1bdnmcwhjZmW3Lc1FCu2K6iBuVQ9I51TR9eTU2lNcq4AW8WV\nEWtwIj6EpLFzQ3qOm3AY4UNgcGrNYYBbF+SiUkchdXbxYRBNFkguDiayaJzMC&#x2F;5WmTrEnQ0xXwmy\nA2lWpZ6+sUlyDRU&#x2F;HvPh5Oto0xpuLc6bIjfl0b+PSjxh5e&#x2F;7&#x2F;4jXoYoUfdm3r2FtPKJtQ2NeKnsp\nOCdk6HNULtk5WSnkBKjufQqoZblvdrEiixnogQ&quot;;</span><br><span class="line">    public static final String WEICO_PIN &#x3D; &quot;Fp1vyiH7EkHmHl6ixX9RmVYy5ynZDnmDZZgp7s7vNq2wfV5aLrM4dPCQiI6jboMS4zu19F66OucE\n9HTRWsC9ksQxuhhsBeBUWJTNeojX076C9gmOGESKJczQPFx1RxJfUfTGeGYAvoTSExo1wVa98v3z\nE5gl&#x2F;uaAdduDI59yOZI&quot;;</span><br><span class="line">    final static BASE64Encoder encoder &#x3D; new BASE64Encoder();</span><br><span class="line">    final static BASE64Decoder decoder &#x3D; new BASE64Decoder();</span><br><span class="line"></span><br><span class="line">    public static String securityPsd(String password) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return new String(Base64.encode(encryptByPublicKey(password.getBytes(), decode(publicKeyString)), 2));</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static byte[] encryptByPublicKey(byte[] data, String publicKey) throws Exception &#123;</span><br><span class="line">        byte[] cache;</span><br><span class="line">        PublicKey publicK &#x3D; KeyFactory.getInstance(KEY_ALGORITHM).generatePublic(new X509EncodedKeySpec(Base64.decode(publicKey.getBytes(), 2)));</span><br><span class="line">        Cipher cipher &#x3D; Cipher.getInstance(KEY_CIPHER_ALGORITHM);</span><br><span class="line">        cipher.init(1, publicK);</span><br><span class="line">        int inputLen &#x3D; data.length;</span><br><span class="line">        ByteArrayOutputStream out &#x3D; new ByteArrayOutputStream();</span><br><span class="line">        int offSet &#x3D; 0;</span><br><span class="line">        int i &#x3D; 0;</span><br><span class="line">        while (inputLen - offSet &gt; 0) &#123;</span><br><span class="line">            if (inputLen - offSet &gt; MAX_ENCRYPT_BLOCK) &#123;</span><br><span class="line">                cache &#x3D; cipher.doFinal(data, offSet, MAX_ENCRYPT_BLOCK);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                cache &#x3D; cipher.doFinal(data, offSet, inputLen - offSet);</span><br><span class="line">            &#125;</span><br><span class="line">            out.write(cache, 0, cache.length);</span><br><span class="line">            i++;</span><br><span class="line">            offSet &#x3D; i * MAX_ENCRYPT_BLOCK;</span><br><span class="line">        &#125;</span><br><span class="line">        byte[] encryptedData &#x3D; out.toByteArray();</span><br><span class="line">        out.close();</span><br><span class="line">        return encryptedData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String decode(String encryptedStr) throws Exception &#123;</span><br><span class="line">        return new String(decryptByPublicKey(Base64.decode(encryptedStr, 1), publicKeyInner));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static byte[] decryptByPublicKey(byte[] encryptedData, String publicKey) throws Exception &#123;</span><br><span class="line">        byte[] cache;</span><br><span class="line">        Key publicK &#x3D; KeyFactory.getInstance(KEY_ALGORITHM).generatePublic(new X509EncodedKeySpec(Base64.decode(publicKey, 1)));</span><br><span class="line">        Cipher cipher &#x3D; Cipher.getInstance(KEY_CIPHER_ALGORITHM);</span><br><span class="line">        cipher.init(2, publicK);</span><br><span class="line">        int inputLen &#x3D; encryptedData.length;</span><br><span class="line">        ByteArrayOutputStream out &#x3D; new ByteArrayOutputStream();</span><br><span class="line">        int offSet &#x3D; 0;</span><br><span class="line">        int i &#x3D; 0;</span><br><span class="line">        while (inputLen - offSet &gt; 0) &#123;</span><br><span class="line">            if (inputLen - offSet &gt; 128) &#123;</span><br><span class="line">                cache &#x3D; cipher.doFinal(encryptedData, offSet, 128);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                cache &#x3D; cipher.doFinal(encryptedData, offSet, inputLen - offSet);</span><br><span class="line">            &#125;</span><br><span class="line">            out.write(cache, 0, cache.length);</span><br><span class="line">            i++;</span><br><span class="line">            offSet &#x3D; i * 128;</span><br><span class="line">        &#125;</span><br><span class="line">        byte[] decryptedData &#x3D; out.toByteArray();</span><br><span class="line">        out.close();</span><br><span class="line">        return decryptedData;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="sValue"><a href="#sValue" class="headerlink" title="sValue"></a>sValue</h2><p>跟进<code>final String sValue = WeiboSecurityUtils.calculateSInJava(getApplicationContext(), userName + password, decode);</code>参数分别为context，账户+密码，<code>decode = WeicoSecurityUtils.decode(KeyUtil.WEICO_PIN)</code>，直接用上面扣出的加解密逻辑即可。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public static String calculateSInJava(Context context, String srcArray, String pin) &#123;</span><br><span class="line">    String str;</span><br><span class="line">    synchronized (mCalculateSLock) &#123;</span><br><span class="line">        if (srcArray.equals(sSeed) &amp;&amp; !TextUtils.isEmpty(sValue)) &#123;</span><br><span class="line">            str &#x3D; sValue;</span><br><span class="line">        &#125; else if (context !&#x3D; null) &#123;</span><br><span class="line">            sSeed &#x3D; srcArray;</span><br><span class="line">            sValue &#x3D; getInstance().calculateS(context.getApplicationContext(), srcArray, pin);</span><br><span class="line">            str &#x3D; sValue;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            str &#x3D; &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>跟进<code>getInstance().calculateS</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">static &#123;</span><br><span class="line">    System.loadLibrary(&quot;utility&quot;);</span><br><span class="line">&#125;</span><br><span class="line">public native String calculateS(Context context, String str, String str2);</span><br></pre></td></tr></table></figure><p>可以知道该方法定义在了libutility.so中，引出今天的分析so，该方法中参数一是Context上下文，参数二是传入的明文，参数三是固定的值，返回值是8位的Sign，且输入不变的情况下，输出也固定不变。</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108161215489.png" alt="image-20211108161215489"></p><p>静态绑定，F5查看C伪代码，y设置type为JNIEnv*</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108161638232.png" alt="image-20211108161638232"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">if ( sub_1C60(a1, a3) )</span><br><span class="line">&#123;</span><br><span class="line">  if ( (*a1)-&gt;PushLocalFrame(a1, 16) &gt;&#x3D; 0 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 &#x3D; (*a1)-&gt;GetStringUTFChars(a1, a5, 0);</span><br><span class="line">    v18 &#x3D; (char *)(*a1)-&gt;GetStringUTFChars(a1, a4, 0);</span><br><span class="line">    v7 &#x3D; j_strlen(v18);</span><br><span class="line">    v8 &#x3D; v7 + j_strlen(v6) + 1;</span><br><span class="line">    v9 &#x3D; j_malloc(v8);</span><br><span class="line">    j_memset(v9, 0, v8);</span><br><span class="line">    j_strcpy((char *)v9, v18);</span><br><span class="line">    j_strcat((char *)v9, v6);</span><br><span class="line">    v10 &#x3D; (_BYTE *)MDStringOld(v9);</span><br><span class="line">    v11 &#x3D; (char *)j_malloc(9u);</span><br><span class="line">    *v11 &#x3D; v10[1];</span><br><span class="line">    v11[1] &#x3D; v10[5];</span><br><span class="line">    v11[2] &#x3D; v10[2];</span><br><span class="line">    v11[3] &#x3D; v10[10];</span><br><span class="line">    v11[4] &#x3D; v10[17];</span><br><span class="line">    v11[5] &#x3D; v10[9];</span><br><span class="line">    v11[6] &#x3D; v10[25];</span><br><span class="line">    v12 &#x3D; v10[27];</span><br><span class="line">    v11[8] &#x3D; 0;</span><br><span class="line">    v11[7] &#x3D; v12;</span><br><span class="line">    v21 &#x3D; (*a1)-&gt;FindClass(a1, &quot;java&#x2F;lang&#x2F;String&quot;);</span><br><span class="line">    v22 &#x3D; (*a1)-&gt;GetMethodID(a1, v21, &quot;&lt;init&gt;&quot;, &quot;([BLjava&#x2F;lang&#x2F;String;)V&quot;);</span><br><span class="line">    v13 &#x3D; j_strlen(v11);</span><br><span class="line">    v19 &#x3D; (*a1)-&gt;NewByteArray(a1, v13);</span><br><span class="line">    v14 &#x3D; j_strlen(v11);</span><br><span class="line">    (*a1)-&gt;SetByteArrayRegion(a1, v19, 0, v14, v11);</span><br><span class="line">    v15 &#x3D; (*a1)-&gt;NewStringUTF(a1, &quot;utf-8&quot;);</span><br><span class="line">    v16 &#x3D; (*a1)-&gt;NewObject(a1, v21, v22, v19, v15);</span><br><span class="line">    j_free(v11);</span><br><span class="line">    j_free(v9);</span><br><span class="line">    (*a1)-&gt;ReleaseStringUTFChars(a1, (jstring)a4, v18);</span><br><span class="line">    a4 &#x3D; (int)(*a1)-&gt;PopLocalFrame(a1, v16);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    a4 &#x3D; 0;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">return a4;</span><br></pre></td></tr></table></figure><p>sub_1C60如果返回0，直接返回0，挂了，想必整个if逻辑才是实现加密的流程。</p><h3 id="Unidbg"><a href="#Unidbg" class="headerlink" title="Unidbg"></a>Unidbg</h3><p>搭建<strong>Unidbg</strong>框架，不过没有JNI OnLoad</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public class sina extends AbstractJni&#123;</span><br><span class="line">    private final AndroidEmulator emulator;</span><br><span class="line">    private final VM vm;</span><br><span class="line">    private final Module module;</span><br><span class="line"> </span><br><span class="line">    sina() &#123;</span><br><span class="line">        &#x2F;&#x2F; 创建模拟器实例,进程名建议依照实际进程名填写，可以规避针对进程名的校验</span><br><span class="line">        emulator &#x3D; AndroidEmulatorBuilder.for32Bit().setProcessName(&quot;com.sina.International&quot;).build();</span><br><span class="line">        &#x2F;&#x2F; 获取模拟器的内存操作接口</span><br><span class="line">        final Memory memory &#x3D; emulator.getMemory();</span><br><span class="line">        &#x2F;&#x2F; 设置系统类库解析</span><br><span class="line">        memory.setLibraryResolver(new AndroidResolver(23));</span><br><span class="line">        &#x2F;&#x2F; 创建Android虚拟机,传入APK，Unidbg可以替我们做部分签名校验的工作</span><br><span class="line">        vm &#x3D; emulator.createDalvikVM(new File(&quot;sinaInternational.apk&quot;));</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F; 加载目标SO</span><br><span class="line">        DalvikModule dm &#x3D; vm.loadLibrary(new File(&quot;libutility.so&quot;), true); &#x2F;&#x2F; 加载so到虚拟内存</span><br><span class="line">        &#x2F;&#x2F;获取本SO模块的句柄,后续需要用它</span><br><span class="line">        module &#x3D; dm.getModule();</span><br><span class="line">        vm.setJni(this); &#x2F;&#x2F; 设置JNI</span><br><span class="line">        vm.setVerbose(true); &#x2F;&#x2F; 打印日志</span><br><span class="line">        &#x2F;&#x2F; 样本连JNI OnLoad都没有</span><br><span class="line">        &#x2F;&#x2F; dm.callJNI_OnLoad(emulator); &#x2F;&#x2F; 调用JNI OnLoad</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        sina test &#x3D; new sina();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>alt+g 查看修改当前指令模式，1是Thumb，0是Arm模式，Thumb 指令看作ARM指令压缩形式的子集，添加一个calculateS函数，依然是地址方式调用，ARM32有Thumb和ARM两种指令模式，此处是thumb模式，所以hook的时候地址要在start基础上+1。</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108162945580.png" alt="image-20211108162945580"></p><blockquote><p>ARM模式指令总是4字节长度，Thumb指令长度多数为2字节，少部分指令是4字节。右键查看Text view，IDA-Options-General</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108163426798.png" alt="image-20211108163426798"></p><p>指令大多为两个字节长度，那就是Thumb</p></blockquote><p>除了基本类型，比如int，long等，其他的对象类型一律要手动 addLocalObject。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public String calculateS() throws Exception &#123;</span><br><span class="line">    List&lt;Object&gt; list &#x3D; new ArrayList&lt;&gt;(10);</span><br><span class="line">    list.add(vm.getJNIEnv()); &#x2F;&#x2F; 第一个参数是env</span><br><span class="line">    list.add(0); &#x2F;&#x2F; 第二个参数，实例方法是jobject，静态方法是jclazz，直接填0，一般用不到。</span><br><span class="line">    DvmObject&lt;?&gt; context &#x3D; vm.resolveClass(&quot;android&#x2F;content&#x2F;Context&quot;).newObject(null);&#x2F;&#x2F; context</span><br><span class="line">    list.add(vm.addLocalObject(context));</span><br><span class="line">    list.add(vm.addLocalObject(new StringObject(vm, &quot;188888888123456&quot;)));</span><br><span class="line">    list.add(vm.addLocalObject(new StringObject(vm, WeiboSecurityUtils.decode(WeiboSecurityUtils.WEICO_PIN))));</span><br><span class="line">    Number number &#x3D; module.callFunction(emulator, 0x1E7C + 1, list.toArray())[0];</span><br><span class="line">    String result &#x3D; vm.getObject(number.intValue()).getValue().toString();</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    sina test &#x3D; new sina();</span><br><span class="line">    System.out.println(test.calculateS());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行报错如下，显示的报错所处地址0x2c8d</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108163602626.png" alt="image-20211108163602626"></p><p>g跳转到0x2c8d，F5查看C伪代码，将a1使用快捷键y转成JNI Env，所属函数<code>jbyte *__fastcall sub_2C3C(JNIEnv *a1, int a2)</code></p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108164550912.png" alt="image-20211108164550912"></p><p>这地方出现Signature一定是签名校验了</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108165757993.png" alt="image-20211108165757993"></p><p>x交叉引用</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108170909203.png" alt="image-20211108170909203"></p><p>进入第一条后发现之前的函数sub_1C60，该函数一旦返回0，直接gg，校验成功返回1，继续x交叉引用</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108171144032.png" alt="image-20211108171144032"></p><p>跳转到了一开始的函数<code>Java_com_sina_weibo_security_WeiboSecurityUtils_calculateS</code></p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108171251713.png" alt="image-20211108171251713"></p><p>Tab查看Text View，sub_1C60地址为<code>FF F7 EB FE</code></p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108171340198.png" alt="image-20211108171340198"></p><p>ARM参数传递规则</p><ul><li>r0:参数1，返回时作为返回值1用，通用寄存器1</li><li>r1:参数2，返回值，通用寄存器2</li><li>r2:参数3，通用寄存器</li><li>r3:参数4，通用寄存器</li><li>r4 ~ r8:变量寄存器1，2，3，4，5</li><li>r9:平台寄存器，该寄存器的意义由平台标准定义</li><li>r10,r11:变量寄存器</li><li>r12:内部过程调用寄存器</li><li>r13:栈寄存器SP</li><li>r14:link寄存器</li><li>r15:PC</li></ul><p>我们可以通过<code>mov r0,1</code>实现不执行这个函数，并给出正确的返回值。且这个函数并没有产生一些之后需要使用的值或者中间变量，所以这让我们不需要管别的寄存器。</p><p><a href="https://armconverter.com/" target="_blank" rel="noopener">arm转hex</a>，可以讲hex和arm互相转换</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108172439486.png" alt="image-20211108172439486"></p><p>将<code>sub_1C60</code>地址<code>FF F7 EB FE</code>改为<code>4F F0 01 00</code>，我们可以调用Unicorn对虚拟内存进行patch，Thumb的+1只在运行和Hook时需要考虑，patch不用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void patchVerify()&#123;</span><br><span class="line">    int patchCode &#x3D; 0x4FF00100;</span><br><span class="line">    emulator.getMemory().pointer(module.base + 0x1E86).setInt(0,patchCode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    sina test &#x3D; new sina();</span><br><span class="line">    test.patchVerify();</span><br><span class="line">    System.out.println(test.calculateS()); &#x2F;&#x2F; 7c5edcf8</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211109202049242.png" alt="image-20211109202049242"></p><p>当需要动态patch的时候就不能以来网站转换arm来拿到hex了，可以使用Unidbg给我们封装的Patch方法。找到<code>FF F7 EB FE</code>，再用Keystone 把patch代码”mov r0,1”转成机器码，填进去，校验一下长度是否相等即可。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public void patchVerifyS()&#123;</span><br><span class="line">    &#x2F;&#x2F; 0x1E86为sub_1C60的地址</span><br><span class="line">    Pointer pointer &#x3D; UnidbgPointer.pointer(emulator, module.base + 0x1E86);</span><br><span class="line">    assert pointer !&#x3D; null;</span><br><span class="line">    byte[] code &#x3D; pointer.getByteArray(0, 4);</span><br><span class="line">    if (!Arrays.equals(code, new byte[]&#123; (byte)0xFF, (byte) 0xF7, (byte) 0xEB, (byte) 0xFE &#125;)) &#123; &#x2F;&#x2F; FF F7 EB FE  BL sub_1C60</span><br><span class="line">        throw new IllegalStateException(Inspector.inspectString(code, &quot;patch32 code&#x3D;&quot; + Arrays.toString(code)));</span><br><span class="line">    &#125;</span><br><span class="line">    try (Keystone keystone &#x3D; new Keystone(KeystoneArchitecture.Arm, KeystoneMode.ArmThumb)) &#123;</span><br><span class="line">        KeystoneEncoded encoded &#x3D; keystone.assemble(&quot;mov r0,1&quot;);</span><br><span class="line">        byte[] patch &#x3D; encoded.getMachineCode();</span><br><span class="line">        if (patch.length !&#x3D; code.length) &#123;</span><br><span class="line">            throw new IllegalStateException(Inspector.inspectString(patch, &quot;patch32 length&#x3D;&quot; + patch.length));</span><br><span class="line">        &#125;</span><br><span class="line">        pointer.write(0, patch, 0, patch.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据伪C代码分析，利用Unidbg实现算法，将text和key拼接起来，然后放到<code>MDStringOld</code>函数中，出来的结果，从中分别抽出第1，5，2，10，17，9，25，27位就是结果了。</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108174300477.png" alt="image-20211108174300477"></p><p>双击进入<code>MDStringOld</code>,tab进入Text View，hook地址为0x1BD0+1</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211108174846870.png" alt="image-20211108174846870"></p><blockquote><p>Unidbg内嵌了多种Hook工具，目前主要是四种，Dobby，HookZz，xHook，Whale</p><ul><li>xHook 是爱奇艺开源的基于PLT HOOK的Hook框架，它无法Hook不在符号表里的函数，也不支持inline hook，这在我们的逆向分析中是无法忍受的，所以在这里不去理会它。</li><li>Whale 在Unidbg的测试用例中只有对符号表函数的Hook，没看到Inline Hook 或者 非导出函数的Hook，所以也不去考虑。</li><li>HookZz是Dobby的前身，两者都可以Hook 非导出表中的函数，即IDA中显示为sub_xxx的函数，也都可以进行inline hook，所以二选一就行了。我喜欢HookZz这个名字，所以就HookZz了。使用HookZz hook MDStringOld函数，MDStringOld是导出函数，可以传入符号名，解析地址，但管他什么findsymbol，findExport呢，我就认准地址，地址，yyds。</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public void HookMDStringold()&#123;</span><br><span class="line">    &#x2F;&#x2F; 加载HookZz</span><br><span class="line">    IHookZz hookZz &#x3D; HookZz.getInstance(emulator);</span><br><span class="line"> </span><br><span class="line">    hookZz.wrap(module.base + 0x1BD0 + 1, new WrapCallback&lt;HookZzArm32RegisterContext&gt;() &#123; &#x2F;&#x2F; inline wrap导出函数</span><br><span class="line">        @Override</span><br><span class="line">        &#x2F;&#x2F; 类似于 frida onEnter</span><br><span class="line">        public void preCall(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info) &#123;</span><br><span class="line">            &#x2F;&#x2F; 类似于Frida args[0]</span><br><span class="line">            Pointer input &#x3D; ctx.getPointerArg(0);</span><br><span class="line">            System.out.println(&quot;input:&quot; + input.getString(0));</span><br><span class="line">        &#125;;</span><br><span class="line"> </span><br><span class="line">        @Override</span><br><span class="line">        &#x2F;&#x2F; 类似于 frida onLeave</span><br><span class="line">        public void postCall(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info) &#123;</span><br><span class="line">            Pointer result &#x3D; ctx.getPointerArg(0);</span><br><span class="line">            System.out.println(&quot;input:&quot; + result.getString(0));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    sina test &#x3D; new sina();</span><br><span class="line">    test.patchVerify1();</span><br><span class="line">    test.HookMDStringold();</span><br><span class="line">    System.out.println(test.calculateS());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211109202250718.png" alt="image-20211109202250718"></p><h3 id="Frida"><a href="#Frida" class="headerlink" title="Frida"></a>Frida</h3><p>打印<code>MDStringOld</code>的参数和返回值，其中0x1BD0为<code>MDStringOld</code>起始地址。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function hookMDStringOld() &#123;</span><br><span class="line">    var baseAddr &#x3D; Module.findBaseAddress(&quot;libutility.so&quot;)</span><br><span class="line">    var MDStringOld &#x3D; baseAddr.add(0x1BD0).add(0x1)</span><br><span class="line">    Interceptor.attach(MDStringOld, &#123;</span><br><span class="line">        onEnter: function (args) &#123;</span><br><span class="line">            console.log(&quot;input:\n&quot;, hexdump(this.arg0))</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: function (retval) &#123;</span><br><span class="line">            console.log(&quot;result:\n&quot;, hexdump(retval))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="iValue"><a href="#iValue" class="headerlink" title="iValue"></a>iValue</h2><p>跟进<code>Object iValue = WeiboSecurityUtils.getIValue(WApplication.cContext);</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public static String getIValue(Context context) &#123;</span><br><span class="line">    if (!TextUtils.isEmpty(sIValue)) &#123;</span><br><span class="line">        return sIValue;</span><br><span class="line">    &#125;</span><br><span class="line">    String deviceSerial &#x3D; getImei(context);</span><br><span class="line">    if (TextUtils.isEmpty(deviceSerial)) &#123;</span><br><span class="line">        deviceSerial &#x3D; getWifiMac(context);</span><br><span class="line">    &#125;</span><br><span class="line">    if (TextUtils.isEmpty(deviceSerial)) &#123;</span><br><span class="line">        deviceSerial &#x3D; &quot;000000000000000&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (context &#x3D;&#x3D; null || TextUtils.isEmpty(deviceSerial)) &#123;</span><br><span class="line">        return &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    String iValue &#x3D; getInstance().getIValue(context.getApplicationContext(), deviceSerial);</span><br><span class="line">    sIValue &#x3D; iValue;</span><br><span class="line">    return iValue;</span><br><span class="line">&#125;</span><br><span class="line">public native String getIValue(Context context, String str);</span><br></pre></td></tr></table></figure><p>以上逻辑中参数<code>deviceSerial</code>通过getWifiMac或者getImei获取，使用Frida<strong>主动调用</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">function getDeviceSerial()&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        Java.choose(&quot;com.sina.weibo.security.WeiboSecurityUtils&quot;,&#123;</span><br><span class="line">            onMatch:function(ins)&#123;</span><br><span class="line">                &#x2F;&#x2F; 获取context</span><br><span class="line">                var current_application &#x3D; Java.use(&#39;android.app.ActivityThread&#39;).currentApplication();</span><br><span class="line">                var context &#x3D; current_application.getApplicationContext();</span><br><span class="line">				&#x2F;&#x2F; 动态方法choose onMatch找到实例进行调用</span><br><span class="line">                console.log(&quot;found ins &#x3D;&gt; &quot;,ins);</span><br><span class="line">				&#x2F;&#x2F; smali或objection看真实方法名</span><br><span class="line">                console.log(&quot;imei&quot;,ins.getImei(context))</span><br><span class="line">                console.log(&quot;getWifiMac&quot;,ins.getWifiMac(context))</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete:function()&#123;</span><br><span class="line">                console.log(&quot;Search completed!&quot;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">function main()&#123;</span><br><span class="line">    console.log(&quot;Start hook&quot;)</span><br><span class="line">    getDeviceSerial()</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211110101058565.png" alt="image-20211110101058565"></p><p>拿到了imei作为deviceSerial，IDA中该搜索getIValue，1EF4为起始地址</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211110101308515.png" alt="image-20211110101308515"></p><p>设置type为JNIEnv*</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211109204732446.png" alt="image-20211109204732446"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public String calculateI()&#123;</span><br><span class="line">    List&lt;Object&gt; list &#x3D; new ArrayList&lt;&gt;(10);</span><br><span class="line">    list.add(vm.getJNIEnv()); &#x2F;&#x2F; 第一个参数是env</span><br><span class="line">    list.add(0); &#x2F;&#x2F; 第二个参数，实例方法是jobject，静态方法是jclazz，直接填0，一般用不到。</span><br><span class="line">    DvmObject&lt;?&gt; context &#x3D; vm.resolveClass(&quot;android&#x2F;content&#x2F;Context&quot;).newObject(null);&#x2F;&#x2F; context</span><br><span class="line">    list.add(vm.addLocalObject(context));</span><br><span class="line">    &#x2F;&#x2F; imei</span><br><span class="line">    list.add(vm.addLocalObject(new StringObject(vm, &quot;352530084364850&quot;)));</span><br><span class="line">    Number number &#x3D; module.callFunction(emulator, 0x1FE4 + 1, list.toArray())[0];</span><br><span class="line">    String result &#x3D; vm.getObject(number.intValue()).getValue().toString();</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line">public static void main(String[] args) throws Exception &#123;</span><br><span class="line">    sina test &#x3D; new sina();</span><br><span class="line">    System.out.println(test.calculateI());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>报错位置在0x2c8d</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211110101527159.png" alt="image-20211110101527159"></p><p>g跳转过去</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211110101647241.png" alt="image-20211110101647241"></p><p>F5查看源码在方法<code>jbyte *__fastcall sub_2C3C(JNIEnv *a1, int a2)</code>中，x交叉引用</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211110101730772.png" alt="image-20211110101730772"></p><p>看到熟悉的sub_1C60，继续x交叉引用，找到getIValue中的sub_1C60</p><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211110101758622.png" alt="image-20211110101758622"></p><p>​ <img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211110101902313.png" alt="image-20211110101902313"></p><p>tab进入汇编模式<code>.text:00001FFE FF F7 2F FE BL sub_1C60</code>，降sub_1C60改为1即可，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public void patchVerifyI()&#123;</span><br><span class="line">    &#x2F;&#x2F; Java_com_sina_weibo_security_WeiboSecurityUtils_getIValue中的sub_1C60</span><br><span class="line">    &#x2F;&#x2F; 00001FFE FF F7 2F FE                 BL      sub_1C60</span><br><span class="line">    Pointer pointer &#x3D; UnidbgPointer.pointer(emulator, module.base + 0x1FFE);</span><br><span class="line">    assert pointer !&#x3D; null;</span><br><span class="line">    byte[] code &#x3D; pointer.getByteArray(0, 4);</span><br><span class="line">    if (!Arrays.equals(code, new byte[]&#123; (byte)0xFF, (byte) 0xF7, (byte) 0x2F, (byte) 0xFE &#125;)) &#123;</span><br><span class="line">        throw new IllegalStateException(Inspector.inspectString(code, &quot;patch32 code&#x3D;&quot; + Arrays.toString(code)));</span><br><span class="line">    &#125;</span><br><span class="line">    try (Keystone keystone &#x3D; new Keystone(KeystoneArchitecture.Arm, KeystoneMode.ArmThumb)) &#123;</span><br><span class="line">        KeystoneEncoded encoded &#x3D; keystone.assemble(&quot;mov r0,1&quot;);</span><br><span class="line">        byte[] patch &#x3D; encoded.getMachineCode();</span><br><span class="line">        if (patch.length !&#x3D; code.length) &#123;</span><br><span class="line">            throw new IllegalStateException(Inspector.inspectString(patch, &quot;patch32 length&#x3D;&quot; + patch.length));</span><br><span class="line">        &#125;</span><br><span class="line">        pointer.write(0, patch, 0, patch.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211110103843824.png" alt="image-20211110103843824"></p><p>接下来双击dword_7068找到地址00007068，修改为0x0</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public void patchVerifyI()&#123;</span><br><span class="line">    &#x2F;&#x2F; Java_com_sina_weibo_security_WeiboSecurityUtils_getIValue中的sub_1C60</span><br><span class="line">    &#x2F;&#x2F; 00001FFE FF F7 2F FE                 BL      sub_1C60</span><br><span class="line">    Pointer pointer &#x3D; UnidbgPointer.pointer(emulator, module.base + 0x1FFE);</span><br><span class="line">    assert pointer !&#x3D; null;</span><br><span class="line">    byte[] code &#x3D; pointer.getByteArray(0, 4);</span><br><span class="line">    if (!Arrays.equals(code, new byte[]&#123; (byte)0xFF, (byte) 0xF7, (byte) 0x2F, (byte) 0xFE &#125;)) &#123;</span><br><span class="line">        throw new IllegalStateException(Inspector.inspectString(code, &quot;patch32 code&#x3D;&quot; + Arrays.toString(code)));</span><br><span class="line">    &#125;</span><br><span class="line">    try (Keystone keystone &#x3D; new Keystone(KeystoneArchitecture.Arm, KeystoneMode.ArmThumb)) &#123;</span><br><span class="line">        KeystoneEncoded encoded &#x3D; keystone.assemble(&quot;mov r0,1&quot;);</span><br><span class="line">        byte[] patch &#x3D; encoded.getMachineCode();</span><br><span class="line">        if (patch.length !&#x3D; code.length) &#123;</span><br><span class="line">            throw new IllegalStateException(Inspector.inspectString(patch, &quot;patch32 length&#x3D;&quot; + patch.length));</span><br><span class="line">        &#125;</span><br><span class="line">        pointer.write(0, patch, 0, patch.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UnidbgPointer basePoint &#x3D; new UnidbgPointer(emulator,(module.base)+0x7068,4);</span><br><span class="line">    int[] javmarr &#x3D; &#123;(int)(0x0)&#125;;</span><br><span class="line">    basePoint.write(0,javmarr,0,1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) throws Exception &#123;</span><br><span class="line">    Map&lt;String, Object&gt; param &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">    sina test &#x3D; new sina();</span><br><span class="line">    test.patchVerifyI();</span><br><span class="line">    test.HookMDStringold();</span><br><span class="line">    test.patchVerifyS();</span><br><span class="line">    param.put(&quot;c&quot;, &quot;weicoabroad&quot;);</span><br><span class="line">    param.put(&quot;i&quot;, test.calculateI());</span><br><span class="line">    param.put(&quot;s&quot;, test.calculateS());</span><br><span class="line">    param.put(&quot;u&quot;, &quot;188888888&quot;);</span><br><span class="line">    param.put(&quot;p&quot;, WeiboSecurityUtils.securityPsd(&quot;123456&quot;));</span><br><span class="line">    param.put(&quot;getuser&quot;, &quot;1&quot;);</span><br><span class="line">    param.put(&quot;getoauth&quot;, &quot;1&quot;);</span><br><span class="line">    param.put(&quot;getcookie&quot;, &quot;1&quot;);</span><br><span class="line">    param.put(&quot;lang&quot;, &quot;zh_CN_#Hans&quot;);</span><br><span class="line">    for (Map.Entry&lt;String, Object&gt; entry : param.entrySet()) &#123;</span><br><span class="line">        System.out.println(entry.getKey() + &quot;---&gt;&quot; + entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    String result &#x3D; HttpUtils.postRequest(&quot;http:&#x2F;&#x2F;api.weibo.cn&#x2F;2&#x2F;account&#x2F;login&quot;, param);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/11/09/SO%E9%80%86%E5%90%91%E4%B9%8B%E5%BE%AE%E5%8D%9A%E5%9B%BD%E9%99%85%E7%89%88%E7%99%BB%E9%99%86%E5%88%86%E6%9E%90/image-20211110105140167.png" alt="image-20211110105140167"></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本次案例中使用xposed破解ssl pinning反抓包，结合objection，frida和unidbg针对so层修改opcode，完成参数的逆向分析和主动调用。</p></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if(!isMobile){var btw=new BTWPlugin;btw.init({id:"vip-container",blogId:"25827-1638538754631-918",name:"万物皆可逆向",qrcode:"https://onejane.github.io/gzh.jpg",keyword:"密码"})}</script></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="mailto:undefined">J</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="http://onejane.github.io/2021/11/09/SO逆向之微博国际版登陆分析/">http://onejane.github.io/2021/11/09/SO逆向之微博国际版登陆分析/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://onejane.github.io">万物皆可逆向</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/frida/">frida</a><a class="post-meta__tags" href="/tags/unidbg/">unidbg</a><a class="post-meta__tags" href="/tags/ida/">ida</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="http://onejane.gitee.io/picture/alipay.png"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="http://onejane.gitee.io/picture/wx.png"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share pull-right" data-disabled="google,facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/11/11/SO%E9%80%86%E5%90%91%E4%B9%8B%E6%9C%80%E5%8F%B3sign%E5%88%86%E6%9E%90/"><i class="fa fa-chevron-left"></i> <span>SO逆向之最右sign分析</span></a></div><div class="next-post pull-right"><a href="/2021/11/03/SO%E9%80%86%E5%90%91%E4%B9%8BUnidbg%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C%E5%85%A5%E9%97%A8/"><span>SO逆向之Unidbg模拟执行入门</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify=!1,verify=!1,record_ip=!1,GUEST_INFO=["nick","mail","link"],guest_info="nick,mail,link".split(",").filter(function(i){return-1<GUEST_INFO.indexOf(i)});guest_info=0==guest_info.length?GUEST_INFO:guest_info,window.valine=new Valine({el:"#vcomment",notify:notify,verify:verify,recordIP:record_ip,appId:"cWLsquGr5PNi33OWXNhzerep-gzGzoHsz",appKey:"S35phfCSbm8dAG9LpOc5rjm3",placeholder:"一起来吹牛逼好吗！",avatar:"mm",guest_info:guest_info,pageSize:"10",lang:"zh-cn"})</script></div></div><footer class="footer-bg" style="background-image:url(http://onejane.gitee.io/picture/kali.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2022 By J</div><div class="framework-info"><span>驱动 -</span> <a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 -</span> <a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script>/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)&&($("#nav").addClass("is-mobile"),$("footer").addClass("is-mobile"),$("#top-container").addClass("is-mobile"))</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49b1f5">hexo-generator-search</a> <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>